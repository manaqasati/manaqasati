<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± â€“ Ù…Ù†Ø§Ù‚ØµØ©</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --p:#7c3aed;--p2:#6d28d9;--p3:#5b21b6;--p-light:#ede9fe;--p-mid:#ddd6fe;
  --gold:#f59e0b;--gold2:#d97706;--gold-l:#fef3c7;
  --text:#0f0a1e;--muted:#64748b;--border:#e2e8f0;--bg:#f8f7ff;--white:#fff;
  --red:#ef4444;--red-l:#fee2e2;--green:#16a34a;--green-l:#dcfce7;
  --blue:#2563eb;--blue-l:#dbeafe;--orange:#ea580c;--orange-l:#ffedd5;
  --sidebar:240px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Tajawal',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;overflow-x:hidden}
.sidebar{width:var(--sidebar);background:linear-gradient(180deg,#1e0545 0%,#2d0f6b 50%,#3b1490 100%);position:fixed;top:0;right:0;bottom:0;z-index:100;display:flex;flex-direction:column;transition:.3s}
.sb-logo{padding:20px 16px;border-bottom:1px solid rgba(255,255,255,0.08)}
.sb-logo-text{font-size:20px;font-weight:900;color:#fff}
.sb-logo-text span{color:var(--gold)}
.sb-badge{font-size:9px;font-weight:800;background:var(--gold);color:#fff;padding:2px 7px;border-radius:20px;margin-right:6px}
.sb-admin{display:flex;align-items:center;gap:8px;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.08)}
.sb-av{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--gold),var(--p));color:#fff;font-size:14px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.sb-admin-name{font-size:12px;font-weight:800;color:#fff}
.sb-admin-role{font-size:10px;color:rgba(255,255,255,0.4)}
.sb-nav{flex:1;padding:12px 10px;overflow-y:auto}
.sb-section{font-size:9px;font-weight:800;color:rgba(255,255,255,0.3);letter-spacing:1px;padding:8px 6px 4px;margin-top:8px}
.sb-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:11px;cursor:pointer;transition:.15s;margin-bottom:2px;border:none;background:transparent;width:100%;font-family:'Tajawal',sans-serif;text-align:right}
.sb-item:hover{background:rgba(255,255,255,0.08)}
.sb-item.on{background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.1)}
.sb-item svg{width:17px;height:17px;stroke:rgba(255,255,255,0.5);flex-shrink:0;transition:.15s}
.sb-item.on svg,.sb-item:hover svg{stroke:#fff}
.sb-item span{font-size:13px;font-weight:700;color:rgba(255,255,255,0.6);transition:.15s}
.sb-item.on span,.sb-item:hover span{color:#fff}
.sb-badge-count{margin-right:auto;background:var(--red);color:#fff;font-size:10px;font-weight:800;padding:1px 6px;border-radius:20px;min-width:18px;text-align:center}
.sb-logout{padding:12px 10px;border-top:1px solid rgba(255,255,255,0.08)}
.main{margin-right:var(--sidebar);flex:1;display:flex;flex-direction:column;min-height:100vh}
.topbar{background:var(--white);border-bottom:1px solid var(--border);padding:0 24px;height:56px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50}
.topbar-title{font-size:16px;font-weight:900}
.topbar-right{display:flex;align-items:center;gap:12px}
.notif-btn{position:relative;width:36px;height:36px;border-radius:10px;border:1.5px solid var(--border);background:var(--white);cursor:pointer;display:flex;align-items:center;justify-content:center}
.notif-btn svg{width:17px;height:17px;stroke:var(--muted)}
.notif-dot{position:absolute;top:6px;right:6px;width:7px;height:7px;background:var(--red);border-radius:50%;border:1.5px solid var(--white)}
.content{padding:24px;flex:1}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:14px;margin-bottom:24px}
.stat-card{background:var(--white);border:1.5px solid var(--border);border-radius:16px;padding:16px;position:relative;overflow:hidden;transition:.2s}
.stat-card:hover{transform:translateY(-2px);box-shadow:0 4px 20px rgba(0,0,0,0.06)}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.stat-p::before{background:var(--p)}.stat-g::before{background:var(--green)}.stat-gold::before{background:var(--gold)}.stat-b::before{background:var(--blue)}.stat-r::before{background:var(--red)}.stat-o::before{background:var(--orange)}
.stat-num{font-size:28px;font-weight:900;margin-bottom:2px}
.stat-label{font-size:11px;color:var(--muted);font-weight:600}
.stat-icon{position:absolute;left:14px;top:14px;width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center}
.stat-icon svg{width:18px;height:18px}
.si-p{background:var(--p-light)}.si-p svg{stroke:var(--p)}
.si-g{background:var(--green-l)}.si-g svg{stroke:var(--green)}
.si-gold{background:var(--gold-l)}.si-gold svg{stroke:var(--gold2)}
.si-b{background:var(--blue-l)}.si-b svg{stroke:var(--blue)}
.si-r{background:var(--red-l)}.si-r svg{stroke:var(--red)}
.si-o{background:var(--orange-l)}.si-o svg{stroke:var(--orange)}
.section{background:var(--white);border:1.5px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:20px}
.section-head{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}
.section-head h3{font-size:14px;font-weight:900}
.section-body{padding:16px 18px}
.tbl{width:100%;border-collapse:collapse;font-size:12px}
.tbl th{text-align:right;padding:8px 10px;color:var(--muted);font-weight:700;border-bottom:1.5px solid var(--border);white-space:nowrap;font-size:11px}
.tbl td{padding:10px;border-bottom:1px solid var(--border);vertical-align:middle}
.tbl tr:last-child td{border-bottom:none}
.tbl tr:hover td{background:#fafafa}
.tag{padding:3px 10px;border-radius:20px;font-size:10px;font-weight:800;display:inline-flex;align-items:center;gap:4px;white-space:nowrap}
.t-pending{background:#fef3c7;color:#d97706}.t-open{background:var(--green-l);color:var(--green)}
.t-prog{background:var(--blue-l);color:var(--blue)}.t-done{background:var(--p-light);color:var(--p)}
.t-rejected{background:var(--red-l);color:var(--red)}
.badge-chip{padding:3px 9px;border-radius:20px;font-size:10px;font-weight:800;display:inline-flex;align-items:center;gap:3px}
.b-none{background:#f1f5f9;color:#94a3b8}.b-verified{background:var(--blue-l);color:var(--blue)}
.b-star{background:var(--gold-l);color:var(--gold2)}.b-partner{background:var(--p-light);color:var(--p)}
.b-top{background:var(--green-l);color:var(--green)}
.btn{padding:7px 14px;border-radius:9px;font-family:'Tajawal',sans-serif;font-size:12px;font-weight:800;cursor:pointer;border:none;transition:.15s;display:inline-flex;align-items:center;gap:5px;white-space:nowrap}
.btn-p{background:var(--p);color:#fff}.btn-p:hover{background:var(--p2)}
.btn-g{background:var(--green);color:#fff}.btn-g:hover{background:#15803d}
.btn-r{background:var(--red);color:#fff}.btn-r:hover{background:#dc2626}
.btn-gold{background:var(--gold);color:#fff}.btn-gold:hover{background:var(--gold2)}
.btn-b{background:var(--blue);color:#fff}.btn-b:hover{background:#1d4ed8}
.btn-ghost{background:var(--bg);color:var(--text);border:1.5px solid var(--border)}.btn-ghost:hover{border-color:var(--p);color:var(--p)}
.btn-sm{padding:5px 10px;font-size:11px;border-radius:7px}
.btn-xs{padding:3px 8px;font-size:10px;border-radius:6px}
.search-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
.search-inp{flex:1;min-width:180px;padding:8px 12px;border:1.5px solid var(--border);border-radius:9px;font-family:'Tajawal',sans-serif;font-size:13px;outline:none}
.search-inp:focus{border-color:var(--p)}
.f-sel{padding:8px 12px;border:1.5px solid var(--border);border-radius:9px;font-family:'Tajawal',sans-serif;font-size:12px;font-weight:700;background:var(--white);color:var(--text);outline:none;cursor:pointer}
.f-sel:focus{border-color:var(--p)}
.proj-card{border:1.5px solid var(--border);border-radius:14px;padding:16px;margin-bottom:12px;background:var(--white);transition:.2s;position:relative}
.proj-card:hover{border-color:var(--p-mid);box-shadow:0 3px 16px rgba(124,58,237,0.07)}
.proj-card.assigned{border-color:#bfdbfe;background:#f0f9ff}
.proj-card.completed{border-color:#bbf7d0;background:#f0fdf4}
.proj-card.pending{border-color:#fde68a;background:#fffbeb}
.proj-card.rejected-card{border-color:#fecaca;background:#fff5f5}
.proj-num{font-size:11px;font-weight:800;color:var(--muted);margin-bottom:6px;font-family:monospace;letter-spacing:.5px}
.proj-title{font-size:15px;font-weight:900;margin-bottom:8px;line-height:1.3}
.proj-meta{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
.pm{font-size:11px;color:var(--muted);background:var(--bg);padding:3px 8px;border-radius:20px;display:flex;align-items:center;gap:3px}
.proj-actions{display:flex;gap:6px;flex-wrap:wrap}
.stamp{position:absolute;top:12px;left:12px;padding:4px 10px;border-radius:8px;font-size:10px;font-weight:900;border:2px solid;transform:rotate(-2deg)}
.stamp-assigned{background:#dbeafe;color:#1d4ed8;border-color:#93c5fd}
.stamp-done{background:#dcfce7;color:#16a34a;border-color:#86efac}
.stamp-pending{background:#fef3c7;color:#d97706;border-color:#fcd34d}
.stamp-rejected{background:#fee2e2;color:#dc2626;border-color:#fca5a5}
.overlay{display:none;position:fixed;inset:0;background:rgba(10,5,30,0.6);z-index:400;align-items:center;justify-content:center;backdrop-filter:blur(6px)}
.overlay.show{display:flex}
.modal{background:var(--white);border-radius:18px;width:94%;max-width:560px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.2)}
.modal-head{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--white);z-index:2}
.modal-head h3{font-size:15px;font-weight:900}
.modal-x{width:30px;height:30px;border-radius:8px;background:var(--bg);border:none;cursor:pointer;font-size:18px;color:var(--muted);display:flex;align-items:center;justify-content:center}
.modal-body{padding:20px}
.form-group{margin-bottom:14px}
.form-label{font-size:12px;font-weight:800;color:var(--text);margin-bottom:5px;display:block}
.form-inp{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:9px;font-family:'Tajawal',sans-serif;font-size:13px;outline:none;background:var(--white);color:var(--text)}
.form-inp:focus{border-color:var(--p)}
.form-sel{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:9px;font-family:'Tajawal',sans-serif;font-size:13px;outline:none;background:var(--white);cursor:pointer}
.form-sel:focus{border-color:var(--p)}
.form-ta{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:9px;font-family:'Tajawal',sans-serif;font-size:13px;outline:none;resize:vertical;min-height:80px}
.form-ta:focus{border-color:var(--p)}
.modal-foot{display:flex;gap:8px;justify-content:flex-end;padding:14px 20px;border-top:1px solid var(--border)}
.prov-av{width:38px;height:38px;border-radius:11px;background:linear-gradient(135deg,var(--gold),var(--p));color:#fff;font-size:15px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.notif-targets{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.notif-target{padding:6px 14px;border-radius:8px;border:1.5px solid var(--border);background:var(--white);font-family:'Tajawal',sans-serif;font-size:12px;font-weight:700;cursor:pointer;transition:.15s}
.notif-target.on{border-color:var(--p);background:var(--p);color:#fff}
.loading{text-align:center;padding:40px;color:var(--muted)}
.loading-spin{width:32px;height:32px;border:3px solid var(--p-mid);border-top-color:var(--p);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 10px}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:40px;color:var(--muted)}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#1e0545;color:#fff;padding:10px 20px;border-radius:12px;font-size:13px;font-weight:700;z-index:999;opacity:0;transition:.3s;pointer-events:none}
.toast.show{opacity:1}
.mob-toggle{display:none;position:fixed;top:14px;left:14px;z-index:300;width:38px;height:38px;border-radius:11px;background:var(--p);border:none;cursor:pointer;align-items:center;justify-content:center}
.mob-toggle svg{width:18px;height:18px;stroke:#fff}
.overlay-mob{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:99}
@media(max-width:768px){
  .sidebar{transform:translateX(100%)}.sidebar.open{transform:translateX(0)}
  .main{margin-right:0}.mob-toggle{display:flex}.overlay-mob.show{display:block}
  .stats-grid{grid-template-columns:repeat(2,1fr)}.content{padding:14px}.topbar{padding:0 14px}
}
</style>
</head>
<body>
<button class="mob-toggle" onclick="toggleSidebar()">
  <svg viewBox="0 0 24 24" fill="none"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
</button>
<div class="overlay-mob" id="mobOverlay" onclick="toggleSidebar()"></div>
<nav class="sidebar" id="sidebar">
  <div class="sb-logo"><div class="sb-logo-text">Ù…Ù†Ø§Ù‚ØµØ©<span>.</span> <span class="sb-badge">Ù…Ø¯ÙŠØ±</span></div></div>
  <div class="sb-admin">
    <div class="sb-av" id="sb-av">Ù…</div>
    <div><div class="sb-admin-name" id="sb-name">Ø§Ù„Ù…Ø¯ÙŠØ±</div><div class="sb-admin-role">ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØ§Ù…Ù„Ø©</div></div>
  </div>
  <div class="sb-nav">
    <div class="sb-section">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
    <button class="sb-item on" onclick="showPage('home',this)">
      <svg viewBox="0 0 24 24" fill="none"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
    </button>
    <div class="sb-section">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</div>
    <button class="sb-item" onclick="showPage('pending',this)">
      <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><span>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span><span class="sb-badge-count" id="sb-pending-count">0</span>
    </button>
    <button class="sb-item" onclick="showPage('requests',this)">
      <svg viewBox="0 0 24 24" fill="none"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><span>ÙƒÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</span>
    </button>
    <div class="sb-section">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</div>
    <button class="sb-item" onclick="showPage('providers',this)">
      <svg viewBox="0 0 24 24" fill="none"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg><span>Ø§Ù„Ù…Ø²ÙˆØ¯ÙˆÙ†</span>
    </button>
    <button class="sb-item" onclick="showPage('clients',this)">
      <svg viewBox="0 0 24 24" fill="none"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg><span>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</span>
    </button>
    <div class="sb-section">Ø§Ù„ØªÙˆØ§ØµÙ„</div>
    <button class="sb-item" onclick="showPage('notifications',this)">
      <svg viewBox="0 0 24 24" fill="none"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg><span>Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span>
    </button>
    <div class="sb-section">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
    <button class="sb-item" onclick="showPage('reviews',this)">
      <svg viewBox="0 0 24 24" fill="none"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg><span>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</span>
    </button>
  </div>
  <div class="sb-logout">
    <button class="sb-item" onclick="logout()" style="width:100%">
      <svg viewBox="0 0 24 24" fill="none"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg><span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
    </button>
  </div>
</nav>
<div class="main">
  <div class="topbar">
    <div class="topbar-title" id="page-title">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
    <div class="topbar-right">
      <div style="font-size:11px;color:var(--muted)" id="clock"></div>
      <button class="notif-btn" onclick="showPage('notifications',null)">
        <svg viewBox="0 0 24 24" fill="none"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
      </button>
    </div>
  </div>
  <div class="content" id="content"><div class="loading"><div class="loading-spin"></div></div></div>
</div>
<div class="overlay" id="overlay">
  <div class="modal">
    <div class="modal-head"><h3 id="modal-title">-</h3><button class="modal-x" onclick="closeModal()">Ã—</button></div>
    <div class="modal-body" id="modal-body"></div>
    <div class="modal-foot" id="modal-foot"></div>
  </div>
</div>
<div class="toast" id="toast"></div>
<script>
var API='https://manaqasati-production.up.railway.app';
var token=localStorage.getItem('token');
var me=JSON.parse(localStorage.getItem('user')||'{}');
var currentPage='home';
var allRequests=[],allUsers=[];

if(!token||me.role!=='admin'){window.location.href='auth.html';}

document.getElementById('sb-name').textContent=me.name||'Ø§Ù„Ù…Ø¯ÙŠØ±';
document.getElementById('sb-av').textContent=(me.name||'Ù…').charAt(0);
setInterval(function(){document.getElementById('clock').textContent=new Date().toLocaleTimeString('ar-SA');},1000);

function api(path,opts){
  return fetch(API+path,Object.assign({headers:{'Authorization':'Bearer '+token,'Content-Type':'application/json'}},opts)).then(function(r){return r.json();});
}

function toast(msg,type){
  var t=document.getElementById('toast');
  t.textContent=msg;
  t.style.background=type==='error'?'#dc2626':type==='success'?'#16a34a':'#1e0545';
  t.className='toast show';
  setTimeout(function(){t.className='toast';},3000);
}

function closeModal(){document.getElementById('overlay').className='overlay';}

function openModal(title,body,foot){
  document.getElementById('modal-title').textContent=title;
  document.getElementById('modal-body').innerHTML=body;
  document.getElementById('modal-foot').innerHTML=foot||'';
  document.getElementById('overlay').className='overlay show';
}

function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('mobOverlay').classList.toggle('show');
}

function logout(){localStorage.clear();window.location.href='auth.html';}

function showPage(page,btn){
  currentPage=page;
  document.querySelectorAll('.sb-item').forEach(function(i){i.className='sb-item';});
  if(btn)btn.className='sb-item on';
  var titles={home:'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',pending:'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',requests:'ÙƒÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹',providers:'Ø§Ù„Ù…Ø²ÙˆØ¯ÙˆÙ†',clients:'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡',notifications:'Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª',reviews:'Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª'};
  document.getElementById('page-title').textContent=titles[page]||page;
  var pages={home:renderHome,pending:renderPending,requests:renderRequests,providers:renderProviders,clients:renderClients,notifications:renderNotifications,reviews:renderReviews};
  if(pages[page])pages[page]();
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('mobOverlay').classList.remove('show');
}

function renderHome(){
  document.getElementById('content').innerHTML='<div class="loading"><div class="loading-spin"></div></div>';
  api('/api/admin/stats').then(function(s){
    document.getElementById('sb-pending-count').textContent=s.pending_review||0;
    document.getElementById('content').innerHTML=`
      <div class="stats-grid">
        <div class="stat-card stat-p"><div class="stat-icon si-p"><svg viewBox="0 0 24 24" fill="none"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div><div class="stat-num">${s.users||0}</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div></div>
        <div class="stat-card stat-gold"><div class="stat-icon si-gold"><svg viewBox="0 0 24 24" fill="none"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg></div><div class="stat-num">${s.providers||0}</div><div class="stat-label">Ù…Ø²ÙˆØ¯Ùˆ Ø§Ù„Ø®Ø¯Ù…Ø©</div></div>
        <div class="stat-card stat-b"><div class="stat-icon si-b"><svg viewBox="0 0 24 24" fill="none"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div><div class="stat-num">${s.requests||0}</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</div></div>
        <div class="stat-card stat-o"><div class="stat-icon si-o"><svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div><div class="stat-num">${s.pending_review||0}</div><div class="stat-label">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div></div>
        <div class="stat-card stat-g"><div class="stat-icon si-g"><svg viewBox="0 0 24 24" fill="none"><polyline points="20 6 9 17 4 12"/></svg></div><div class="stat-num">${s.completed||0}</div><div class="stat-label">Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…ÙƒØªÙ…Ù„Ø©</div></div>
        <div class="stat-card stat-b"><div class="stat-icon si-b"><svg viewBox="0 0 24 24" fill="none"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg></div><div class="stat-num">${s.bids||0}</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±ÙˆØ¶</div></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div class="section"><div class="section-head"><h3>â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h3><button class="btn btn-sm btn-p" onclick="showPage('pending',null)">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button></div><div class="section-body" id="home-pending"><div class="loading"><div class="loading-spin"></div></div></div></div>
        <div class="section"><div class="section-head"><h3>ğŸ”¥ Ø¢Ø®Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…ÙØªÙˆØ­Ø©</h3></div><div class="section-body" id="home-open"><div class="loading"><div class="loading-spin"></div></div></div></div>
      </div>`;
    api('/api/admin/requests?status=pending_review').then(function(reqs){
      var el=document.getElementById('home-pending');if(!el)return;
      if(!reqs.length){el.innerHTML='<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø© âœ…</div>';return;}
      el.innerHTML=reqs.slice(0,4).map(function(r){
        return `<div class="proj-card pending" style="margin-bottom:8px">
          <div class="proj-num">${r.project_number||'#'+r.id}</div>
          <div class="proj-title">${r.title}</div>
          <div class="proj-meta"><span class="pm">ğŸ“ ${r.city||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span><span class="pm">${r.category||'Ø¹Ø§Ù…'}</span></div>
          <div class="proj-actions">
            <button class="btn btn-sm btn-g" onclick="approveReq(${r.id})">âœ“ Ù…ÙˆØ§ÙÙ‚Ø©</button>
            <button class="btn btn-sm btn-r" onclick="rejectReq(${r.id})">âœ— Ø±ÙØ¶</button>
            <button class="btn btn-sm btn-ghost" onclick="viewReq(${r.id})">ØªÙØ§ØµÙŠÙ„</button>
          </div></div>`;
      }).join('');
    });
    api('/api/admin/requests?status=open').then(function(reqs){
      var el=document.getElementById('home-open');if(!el)return;
      if(!reqs.length){el.innerHTML='<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…ÙØªÙˆØ­Ø©</div>';return;}
      el.innerHTML=reqs.slice(0,5).map(function(r){
        return `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
          <div><div style="font-size:12px;font-weight:800">${r.title}</div><div style="font-size:10px;color:var(--muted)">${r.bid_count||0} Ø¹Ø±ÙˆØ¶ â€¢ ${r.city||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div></div>
          <button class="btn btn-xs btn-p" onclick="viewReq(${r.id})">Ø¹Ø±Ø¶</button></div>`;
      }).join('');
    });
  });
}

function renderPending(){
  document.getElementById('content').innerHTML=`<div class="section"><div class="section-head"><h3>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h3><span id="pending-count" class="tag t-pending">0 Ø·Ù„Ø¨</span></div><div class="section-body" id="pending-list"><div class="loading"><div class="loading-spin"></div></div></div></div>`;
  api('/api/admin/requests?status=pending_review').then(function(reqs){
    document.getElementById('pending-count').textContent=reqs.length+' Ø·Ù„Ø¨';
    document.getElementById('sb-pending-count').textContent=reqs.length;
    if(!reqs.length){document.getElementById('pending-list').innerHTML='<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø© âœ…</div>';return;}
    document.getElementById('pending-list').innerHTML=reqs.map(function(r){
      return `<div class="proj-card pending">
        <div class="stamp stamp-pending">â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
        <div class="proj-num">${r.project_number||'#'+r.id}</div>
        <div class="proj-title">${r.title}</div>
        <div class="proj-meta">
          <span class="pm">ğŸ‘¤ ${r.client_name}</span><span class="pm">ğŸ“ ${r.city||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
          <span class="pm">ğŸ“‚ ${r.category||'Ø¹Ø§Ù…'}</span>
          ${r.budget_max?`<span class="pm">ğŸ’° ${r.budget_max.toLocaleString()} Ø±.Ø³</span>`:''}
          ${r.deadline?`<span class="pm">ğŸ“… ${r.deadline}</span>`:''}
        </div>
        ${r.description?`<div style="font-size:12px;color:var(--muted);margin-bottom:10px;line-height:1.6">${r.description}</div>`:''}
        <div class="proj-actions">
          <button class="btn btn-g" onclick="approveReq(${r.id})">âœ“ Ù…ÙˆØ§ÙÙ‚Ø© ÙˆÙ†Ø´Ø±</button>
          <button class="btn btn-r" onclick="rejectReq(${r.id})">âœ— Ø±ÙØ¶</button>
          <button class="btn btn-ghost" onclick="viewReq(${r.id})">ğŸ‘ ØªÙØ§ØµÙŠÙ„</button>
        </div></div>`;
    }).join('');
  });
}

function renderRequests(){
  document.getElementById('content').innerHTML=`
    <div class="section">
      <div class="section-head"><h3>ÙƒÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</h3>
        <select class="f-sel" id="req-status-f" onchange="loadRequests()">
          <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
          <option value="pending_review">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
          <option value="open">Ù…ÙØªÙˆØ­</option>
          <option value="in_progress">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
          <option value="completed">Ù…ÙƒØªÙ…Ù„</option>
          <option value="rejected">Ù…Ø±ÙÙˆØ¶</option>
        </select>
      </div>
      <div class="section-body">
        <div class="search-row"><input type="text" class="search-inp" id="req-search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹..." oninput="filterRequests()"></div>
        <div id="req-list"><div class="loading"><div class="loading-spin"></div></div></div>
      </div>
    </div>`;
  loadRequests();
}

function loadRequests(){
  var status=document.getElementById('req-status-f')?document.getElementById('req-status-f').value:'';
  api('/api/admin/requests'+(status?'?status='+status:'')).then(function(reqs){allRequests=reqs;filterRequests();});
}

function filterRequests(){
  var q=(document.getElementById('req-search')||{value:''}).value.toLowerCase();
  var filtered=allRequests.filter(function(r){return !q||r.title.toLowerCase().includes(q)||(r.client_name||'').toLowerCase().includes(q)||(r.project_number||'').toLowerCase().includes(q);});
  var el=document.getElementById('req-list');if(!el)return;
  if(!filtered.length){el.innerHTML='<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';return;}
  var sMap={pending_review:'t-pending',open:'t-open',in_progress:'t-prog',completed:'t-done',rejected:'t-rejected'};
  var sLabel={pending_review:'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',open:'Ù…ÙØªÙˆØ­',in_progress:'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°',completed:'Ù…ÙƒØªÙ…Ù„',rejected:'Ù…Ø±ÙÙˆØ¶'};
  var cClass={pending_review:'pending',in_progress:'assigned',completed:'completed',rejected:'rejected-card'};
  var stamps={in_progress:'<div class="stamp stamp-assigned">âœ“ ØªÙ… Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯</div>',completed:'<div class="stamp stamp-done">âœ“ Ù…ÙƒØªÙ…Ù„</div>',rejected:'<div class="stamp stamp-rejected">âœ— Ù…Ø±ÙÙˆØ¶</div>'};
  el.innerHTML=filtered.map(function(r){
    return `<div class="proj-card ${cClass[r.status]||''}">
      ${stamps[r.status]||''}
      <div class="proj-num">${r.project_number||'#'+r.id}</div>
      <div class="proj-title">${r.title}</div>
      <div class="proj-meta">
        <span class="tag ${sMap[r.status]||'t-pending'}">${sLabel[r.status]||r.status}</span>
        <span class="pm">ğŸ‘¤ ${r.client_name}</span><span class="pm">ğŸ“ ${r.city||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
        <span class="pm">ğŸ“‚ ${r.category||'Ø¹Ø§Ù…'}</span><span class="pm">ğŸ’¼ ${r.bid_count||0} Ø¹Ø±ÙˆØ¶</span>
        ${r.budget_max?`<span class="pm">ğŸ’° ${r.budget_max.toLocaleString()} Ø±.Ø³</span>`:''}
      </div>
      <div class="proj-actions">
        <button class="btn btn-sm btn-p" onclick="viewReq(${r.id})">ğŸ‘ ØªÙØ§ØµÙŠÙ„</button>
        ${r.status==='pending_review'?`<button class="btn btn-sm btn-g" onclick="approveReq(${r.id})">âœ“ Ù…ÙˆØ§ÙÙ‚Ø©</button><button class="btn btn-sm btn-r" onclick="rejectReq(${r.id})">âœ— Ø±ÙØ¶</button>`:''}
        ${r.status==='in_progress'?`<button class="btn btn-sm btn-gold" onclick="completeReq(${r.id})">âœ“ Ø¥ÙƒÙ…Ø§Ù„</button>`:''}
        <button class="btn btn-sm btn-ghost" onclick="editReq(${r.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn btn-sm btn-r" onclick="deleteReq(${r.id})">ğŸ—‘</button>
      </div></div>`;
  }).join('');
}

var CATS=['ØªØ¨Ø±ÙŠØ¯ ÙˆØªÙƒÙŠÙŠÙ','ÙƒÙ‡Ø±Ø¨Ø§Ø¡','Ø³Ø¨Ø§ÙƒØ©','Ù†Ø¬Ø§Ø±Ø©','ØªÙ†Ø¸ÙŠÙ','Ù†Ù‚Ù„ Ø¹ÙØ´','Ø­Ø¯Ø§Ø¯Ø©','Ø£Ù„Ù…Ù†ÙŠÙˆÙ…','Ù…Ø³Ø§Ø¨Ø­ (ØªÙ†ÙÙŠØ° ÙˆØµÙŠØ§Ù†Ø©)','ÙƒØ§Ù…ÙŠØ±Ø§Øª Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ£Ù…Ù†','Ø´Ø¨ÙƒØ§Øª ÙˆØ¥Ù†ØªØ±Ù†Øª','Ù…Ø¸Ù„Ø§Øª ÙˆØ³ÙˆØ§ØªØ±','Ø¹Ø²Ù„ Ø­Ø±Ø§Ø±ÙŠ ÙˆØ£Ø³Ø·Ø­','Ø£Ø¨ÙˆØ§Ø¨','Ø£Ø¹Ù…Ø§Ù„ Ø¬Ø¨Ø³ ÙˆØ·Ø¨Ø§Ø´ÙŠØ±','Ù…ÙƒØ§ÙØ­Ø© Ø­Ø´Ø±Ø§Øª','Ø£Ø®Ø±Ù‰'];

function renderProviders(){
  document.getElementById('content').innerHTML=`
    <div class="section">
      <div class="section-head"><h3>Ù…Ø²ÙˆØ¯Ùˆ Ø§Ù„Ø®Ø¯Ù…Ø©</h3><button class="btn btn-p" onclick="addUserModal('provider')">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø²ÙˆØ¯</button></div>
      <div class="section-body">
        <div class="search-row">
          <input type="text" class="search-inp" id="prov-search" placeholder="Ø¨Ø­Ø«..." oninput="filterProviders()">
          <select class="f-sel" id="prov-cat-f" onchange="filterProviders()"><option value="">ÙƒÙ„ Ø§Ù„ØªØ®ØµØµØ§Øª</option>${CATS.map(function(c){return`<option value="${c}">${c}</option>`;}).join('')}</select>
        </div>
        <div id="prov-list"><div class="loading"><div class="loading-spin"></div></div></div>
      </div>
    </div>`;
  api('/api/admin/users').then(function(users){allUsers=users.filter(function(u){return u.role==='provider';});filterProviders();});
}

function filterProviders(){
  var q=(document.getElementById('prov-search')||{value:''}).value.toLowerCase();
  var cat=(document.getElementById('prov-cat-f')||{value:''}).value;
  var filtered=allUsers.filter(function(u){
    return(!q||u.name.toLowerCase().includes(q)||(u.city||'').toLowerCase().includes(q))&&(!cat||(u.specialties&&u.specialties.includes(cat)));
  });
  var el=document.getElementById('prov-list');if(!el)return;
  if(!filtered.length){el.innerHTML='<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø²ÙˆØ¯ÙˆÙ†</div>';return;}
  var bMap={none:'b-none Ø¨Ø¯ÙˆÙ† ÙˆØ³Ø§Ù…',verified:'b-verified âœ“ Ù…ÙˆØ«Ù‚',star:'b-star â­ Ù…ØªÙ…ÙŠØ²',partner:'b-partner ğŸ’ Ø´Ø±ÙŠÙƒ',top:'b-top ğŸ† Ø§Ù„Ø£ÙØ¶Ù„'};
  el.innerHTML=`<table class="tbl"><thead><tr><th>Ø§Ù„Ù…Ø²ÙˆØ¯</th><th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th><th>Ø§Ù„ØªØ®ØµØµ</th><th>Ø§Ù„ÙˆØ³Ø§Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody>${
    filtered.map(function(u){
      var bp=(bMap[u.badge||'none']||'b-none Ø¨Ø¯ÙˆÙ† ÙˆØ³Ø§Ù…').split(' ');
      return `<tr>
        <td><div style="display:flex;align-items:center;gap:8px"><div class="prov-av" style="width:32px;height:32px;font-size:12px">${u.name.charAt(0)}</div><div><div style="font-size:12px;font-weight:800">${u.name}</div><div style="font-size:10px;color:var(--muted)">${u.email}</div></div></div></td>
        <td>${u.city||'â€”'}</td>
        <td style="font-size:11px">${u.specialties&&u.specialties.length?u.specialties.slice(0,2).join('ØŒ '):'â€”'}</td>
        <td><span class="badge-chip ${bp[0]}">${bp.slice(1).join(' ')}</span></td>
        <td><span class="tag ${u.is_active?'t-open':'t-rejected'}">${u.is_active?'Ù†Ø´Ø·':'Ù…ÙˆÙ‚ÙˆÙ'}</span></td>
        <td><div style="display:flex;gap:4px">
          <button class="btn btn-xs btn-gold" onclick="setBadge(${u.id},'${u.name}')">ğŸ†</button>
          <button class="btn btn-xs btn-p" onclick="editUser(${u.id})">âœï¸</button>
          <button class="btn btn-xs ${u.is_active?'btn-r':'btn-g'}" onclick="toggleUser(${u.id})">${u.is_active?'Ø¥ÙŠÙ‚Ø§Ù':'ØªÙØ¹ÙŠÙ„'}</button>
          <button class="btn btn-xs btn-ghost" onclick="notifyUser(${u.id},'${u.name}')">ğŸ””</button>
          <button class="btn btn-xs btn-r" onclick="deleteUser(${u.id})">ğŸ—‘</button>
        </div></td></tr>`;
    }).join('')
  }</tbody></table>`;
}

function renderClients(){
  document.getElementById('content').innerHTML=`
    <div class="section">
      <div class="section-head"><h3>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3><button class="btn btn-p" onclick="addUserModal('client')">+ Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</button></div>
      <div class="section-body">
        <div class="search-row"><input type="text" class="search-inp" id="cli-search" placeholder="Ø¨Ø­Ø«..." oninput="filterClients()"></div>
        <div id="cli-list"><div class="loading"><div class="loading-spin"></div></div></div>
      </div>
    </div>`;
  api('/api/admin/users').then(function(users){allUsers=users.filter(function(u){return u.role==='client';});filterClients();});
}

function filterClients(){
  var q=(document.getElementById('cli-search')||{value:''}).value.toLowerCase();
  var filtered=allUsers.filter(function(u){return !q||u.name.toLowerCase().includes(q)||(u.email||'').toLowerCase().includes(q);});
  var el=document.getElementById('cli-list');if(!el)return;
  if(!filtered.length){el.innerHTML='<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡</div>';return;}
  el.innerHTML=`<table class="tbl"><thead><tr><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody>${
    filtered.map(function(u){
      return `<tr>
        <td><div style="display:flex;align-items:center;gap:8px"><div class="prov-av" style="width:32px;height:32px;font-size:12px;background:linear-gradient(135deg,var(--blue),var(--p))">${u.name.charAt(0)}</div><div><div style="font-size:12px;font-weight:800">${u.name}</div><div style="font-size:10px;color:var(--muted)">${u.email}</div></div></div></td>
        <td>${u.phone||'â€”'}</td><td>${u.city||'â€”'}</td>
        <td><span class="tag ${u.is_active?'t-open':'t-rejected'}">${u.is_active?'Ù†Ø´Ø·':'Ù…ÙˆÙ‚ÙˆÙ'}</span></td>
        <td><div style="display:flex;gap:4px">
          <button class="btn btn-xs btn-p" onclick="editUser(${u.id})">âœï¸</button>
          <button class="btn btn-xs ${u.is_active?'btn-r':'btn-g'}" onclick="toggleUser(${u.id})">${u.is_active?'Ø¥ÙŠÙ‚Ø§Ù':'ØªÙØ¹ÙŠÙ„'}</button>
          <button class="btn btn-xs btn-ghost" onclick="notifyUser(${u.id},'${u.name}')">ğŸ””</button>
          <button class="btn btn-xs btn-r" onclick="deleteUser(${u.id})">ğŸ—‘</button>
        </div></td></tr>`;
    }).join('')
  }</tbody></table>`;
}

function renderNotifications(){
  document.getElementById('content').innerHTML=`
    <div class="section">
      <div class="section-head"><h3>Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3></div>
      <div class="section-body">
        <div class="form-group"><div class="form-label">Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</div>
          <div class="notif-targets">
            <button class="notif-target on" onclick="setTarget(this,'')">Ø§Ù„ÙƒÙ„</button>
            <button class="notif-target" onclick="setTarget(this,'provider')">Ø§Ù„Ù…Ø²ÙˆØ¯ÙˆÙ† ÙÙ‚Ø·</button>
            <button class="notif-target" onclick="setTarget(this,'client')">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙÙ‚Ø·</button>
          </div>
        </div>
        <input type="hidden" id="notif-role" value="">
        <div class="form-group"><label class="form-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</label><input type="text" class="form-inp" id="notif-title" placeholder="Ù…Ø«Ø§Ù„: ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ù…Ù†ØµØ©"></div>
        <div class="form-group"><label class="form-label">Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</label><textarea class="form-ta" id="notif-body" placeholder="Ø§ÙƒØªØ¨ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù‡Ù†Ø§..."></textarea></div>
        <button class="btn btn-p" onclick="sendNotif()">ğŸ”” Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</button>
      </div>
    </div>`;
}

function setTarget(btn,role){
  document.querySelectorAll('.notif-target').forEach(function(b){b.className='notif-target';});
  btn.className='notif-target on';
  document.getElementById('notif-role').value=role;
}

function sendNotif(){
  var title=document.getElementById('notif-title').value;
  var body=document.getElementById('notif-body').value;
  var role=document.getElementById('notif-role').value;
  if(!title||!body){toast('Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù†Øµ','error');return;}
  api('/api/admin/notify',{method:'POST',body:JSON.stringify({title:title,body:body,role:role||undefined,type:'admin'})}).then(function(){
    toast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± âœ…','success');
    document.getElementById('notif-title').value='';
    document.getElementById('notif-body').value='';
  });
}

function renderReviews(){
  document.getElementById('content').innerHTML=`<div class="section"><div class="section-head"><h3>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h3></div><div class="section-body" id="reviews-list"><div class="loading"><div class="loading-spin"></div></div></div></div>`;
  api('/api/admin/reviews').then(function(reviews){
    var el=document.getElementById('reviews-list');
    if(!reviews.length){el.innerHTML='<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª</div>';return;}
    el.innerHTML=`<table class="tbl"><thead><tr><th>Ø§Ù„Ù…Ù‚ÙŠÙÙ‘Ù…</th><th>Ø§Ù„Ù…Ù‚ÙŠÙÙ‘Ù…</th><th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th><th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th><th>Ø§Ù„ØªØ¹Ù„ÙŠÙ‚</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody>${
      reviews.map(function(r){
        return `<tr>
          <td style="font-size:12px;font-weight:700">${r.reviewer_name}</td>
          <td style="font-size:12px;font-weight:700">${r.reviewed_name}</td>
          <td style="font-size:11px;color:var(--muted)">${r.project_number||'#'+r.request_id}</td>
          <td><span style="color:var(--gold)">${'â˜…'.repeat(r.rating)}${'â˜†'.repeat(5-r.rating)}</span></td>
          <td style="font-size:11px;color:var(--muted)">${r.comment||'â€”'}</td>
          <td><button class="btn btn-xs btn-r" onclick="deleteReview(${r.id})">ğŸ—‘</button></td></tr>`;
      }).join('')
    }</tbody></table>`;
  });
}

function approveReq(id){
  api('/api/admin/requests/'+id+'/review',{method:'PUT',body:JSON.stringify({status:'open',admin_notes:'ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©'})}).then(function(){
    toast('ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙˆÙ†Ø´Ø± Ø§Ù„Ø·Ù„Ø¨ âœ…','success');
    if(currentPage==='pending')renderPending();else if(currentPage==='requests')loadRequests();else renderHome();
  });
}

function rejectReq(id){
  openModal('Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨',`<div class="form-group"><label class="form-label">Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶</label><textarea class="form-ta" id="reject-reason" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶..."></textarea></div>`,
    `<button class="btn btn-ghost" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button><button class="btn btn-r" onclick="doReject(${id})">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±ÙØ¶</button>`);
}

function doReject(id){
  var reason=document.getElementById('reject-reason').value||'Ù„Ø§ ÙŠØ³ØªÙˆÙÙŠ Ø§Ù„Ø´Ø±ÙˆØ·';
  api('/api/admin/requests/'+id+'/review',{method:'PUT',body:JSON.stringify({status:'rejected',admin_notes:reason})}).then(function(){
    closeModal();toast('ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨','error');
    if(currentPage==='pending')renderPending();else loadRequests();
  });
}

function completeReq(id){
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ÙƒÙ…Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŸ'))return;
  api('/api/admin/requests/'+id+'/complete',{method:'PUT'}).then(function(){toast('ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ âœ…','success');loadRequests();});
}

function deleteReq(id){
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ'))return;
  api('/api/admin/requests/'+id,{method:'DELETE'}).then(function(){toast('ØªÙ… Ø§Ù„Ø­Ø°Ù','error');loadRequests();});
}

function viewReq(id){
  api('/api/requests/'+id).then(function(r){
    var sLabel={pending_review:'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',open:'Ù…ÙØªÙˆØ­',in_progress:'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°',completed:'Ù…ÙƒØªÙ…Ù„',rejected:'Ù…Ø±ÙÙˆØ¶'};
    openModal('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹',
      `<div style="display:flex;flex-direction:column;gap:10px">
        <div style="background:var(--p-light);border-radius:11px;padding:14px;text-align:center">
          <div style="font-size:10px;color:var(--p);font-weight:800;margin-bottom:4px">Ø±Ù‚Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</div>
          <div style="font-size:18px;font-weight:900;font-family:monospace;color:var(--p)">${r.project_number||'#'+r.id}</div>
        </div>
        <div style="background:var(--bg);border-radius:11px;padding:14px">
          <div style="font-size:11px;color:var(--muted);margin-bottom:4px">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</div>
          <div style="font-size:15px;font-weight:900">${r.title}</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <div style="background:var(--bg);border-radius:11px;padding:12px"><div style="font-size:10px;color:var(--muted)">Ø§Ù„Ø­Ø§Ù„Ø©</div><div style="font-size:12px;font-weight:800">${sLabel[r.status]||r.status}</div></div>
          <div style="background:var(--bg);border-radius:11px;padding:12px"><div style="font-size:10px;color:var(--muted)">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</div><div style="font-size:12px;font-weight:800">${r.city||'â€”'}</div></div>
          <div style="background:var(--bg);border-radius:11px;padding:12px"><div style="font-size:10px;color:var(--muted)">Ø§Ù„ØªØµÙ†ÙŠÙ</div><div style="font-size:12px;font-weight:800">${r.category||'â€”'}</div></div>
          <div style="background:var(--bg);border-radius:11px;padding:12px"><div style="font-size:10px;color:var(--muted)">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</div><div style="font-size:12px;font-weight:800">${r.budget_max?r.budget_max.toLocaleString()+' Ø±.Ø³':'â€”'}</div></div>
        </div>
        <div style="background:var(--bg);border-radius:11px;padding:12px"><div style="font-size:10px;color:var(--muted);margin-bottom:4px">ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨</div><div style="font-size:12px;font-weight:800">${r.client_name} ${r.client_phone?'â€” '+r.client_phone:''}</div></div>
        ${r.provider_name?`<div style="background:var(--green-l);border-radius:11px;padding:12px"><div style="font-size:10px;color:var(--green);margin-bottom:4px">Ø§Ù„Ù…Ø²ÙˆØ¯ Ø§Ù„Ù…ÙØ³Ù†Ø¯</div><div style="font-size:12px;font-weight:800">${r.provider_name}</div></div>`:''}
        ${r.description?`<div style="background:var(--bg);border-radius:11px;padding:12px"><div style="font-size:10px;color:var(--muted);margin-bottom:4px">Ø§Ù„ØªÙØ§ØµÙŠÙ„</div><div style="font-size:12px;line-height:1.6">${r.description}</div></div>`:''}
        ${r.admin_notes?`<div style="background:var(--gold-l);border-radius:11px;padding:12px"><div style="font-size:10px;color:var(--gold2);margin-bottom:4px">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±</div><div style="font-size:12px">${r.admin_notes}</div></div>`:''}
      </div>`,
      `${r.status==='pending_review'?`<button class="btn btn-g" onclick="closeModal();approveReq(${r.id})">âœ“ Ù…ÙˆØ§ÙÙ‚Ø©</button><button class="btn btn-r" onclick="closeModal();rejectReq(${r.id})">âœ— Ø±ÙØ¶</button>`:''}
       ${r.status==='in_progress'?`<button class="btn btn-gold" onclick="closeModal();completeReq(${r.id})">âœ“ Ø¥ÙƒÙ…Ø§Ù„</button>`:''}
       <button class="btn btn-ghost" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>`
    );
  });
}

function editReq(id){
  var r=allRequests.find(function(x){return x.id===id;});
  if(!r){api('/api/requests/'+id).then(function(r2){doEditModal(r2);});return;}
  doEditModal(r);
}

function doEditModal(r){
  openModal('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ â€” '+r.project_number,
    `<div class="form-group"><label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input type="text" class="form-inp" id="e-title" value="${r.title}"></div>
     <div class="form-group"><label class="form-label">Ø§Ù„ØªÙØ§ØµÙŠÙ„</label><textarea class="form-ta" id="e-desc">${r.description||''}</textarea></div>
     <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
       <div class="form-group"><label class="form-label">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label><input type="text" class="form-inp" id="e-city" value="${r.city||''}"></div>
       <div class="form-group"><label class="form-label">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</label><input type="number" class="form-inp" id="e-budget" value="${r.budget_max||''}"></div>
     </div>
     <div class="form-group"><label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±</label><textarea class="form-ta" id="e-notes">${r.admin_notes||''}</textarea></div>`,
    `<button class="btn btn-ghost" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button><button class="btn btn-p" onclick="doEditReq(${r.id})">Ø­ÙØ¸</button>`
  );
}

function doEditReq(id){
  var r=allRequests.find(function(x){return x.id===id;})||{};
  api('/api/admin/requests/'+id,{method:'PUT',body:JSON.stringify({
    title:document.getElementById('e-title').value,
    description:document.getElementById('e-desc').value,
    category:r.category,city:document.getElementById('e-city').value,
    address:r.address,budget_max:document.getElementById('e-budget').value,
    deadline:r.deadline,admin_notes:document.getElementById('e-notes').value
  })}).then(function(){closeModal();toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª âœ…','success');loadRequests();});
}

function setBadge(userId,name){
  openModal('ØªØ¹ÙŠÙŠÙ† ÙˆØ³Ø§Ù… â€” '+name,
    `<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <button class="btn btn-ghost" style="justify-content:center" onclick="doSetBadge(${userId},'none')">ğŸš« Ø¨Ø¯ÙˆÙ† ÙˆØ³Ø§Ù…</button>
      <button class="btn btn-b" style="justify-content:center" onclick="doSetBadge(${userId},'verified')">âœ“ Ù…ÙˆØ«Ù‚</button>
      <button class="btn btn-gold" style="justify-content:center" onclick="doSetBadge(${userId},'star')">â­ Ù…ØªÙ…ÙŠØ²</button>
      <button class="btn btn-p" style="justify-content:center" onclick="doSetBadge(${userId},'partner')">ğŸ’ Ø´Ø±ÙŠÙƒ</button>
      <button class="btn btn-g" style="justify-content:center;grid-column:1/-1" onclick="doSetBadge(${userId},'top')">ğŸ† Ø§Ù„Ø£ÙØ¶Ù„</button>
    </div>`,''
  );
}

function doSetBadge(userId,badge){
  api('/api/admin/users/'+userId+'/badge',{method:'PUT',body:JSON.stringify({badge:badge})}).then(function(){
    closeModal();toast('ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆØ³Ø§Ù… âœ…','success');renderProviders();
  });
}

function toggleUser(id){
  api('/api/admin/users/'+id+'/toggle',{method:'PUT'}).then(function(u){
    toast(u.is_active?'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ âœ…':'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø­Ø³Ø§Ø¨',u.is_active?'success':'error');
    if(currentPage==='providers')renderProviders();else renderClients();
  });
}

function deleteUser(id){
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ'))return;
  api('/api/admin/users/'+id,{method:'DELETE'}).then(function(){toast('ØªÙ… Ø§Ù„Ø­Ø°Ù','error');if(currentPage==='providers')renderProviders();else renderClients();});
}

function notifyUser(userId,name){
  openModal('Ø¥Ø´Ø¹Ø§Ø± Ù„Ù€ '+name,
    `<div class="form-group"><label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input type="text" class="form-inp" id="u-notif-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±"></div>
     <div class="form-group"><label class="form-label">Ø§Ù„Ù†Øµ</label><textarea class="form-ta" id="u-notif-body"></textarea></div>`,
    `<button class="btn btn-ghost" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button><button class="btn btn-p" onclick="doNotifyUser(${userId})">ğŸ”” Ø¥Ø±Ø³Ø§Ù„</button>`
  );
}

function doNotifyUser(userId){
  var title=document.getElementById('u-notif-title').value;
  var body=document.getElementById('u-notif-body').value;
  if(!title||!body){toast('Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù†Øµ','error');return;}
  api('/api/admin/notify',{method:'POST',body:JSON.stringify({user_id:userId,title:title,body:body,type:'admin'})}).then(function(){
    closeModal();toast('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âœ…','success');
  });
}

function addUserModal(role){
  var isProvider=role==='provider';
  openModal('Ø¥Ø¶Ø§ÙØ© '+(isProvider?'Ù…Ø²ÙˆØ¯ Ø®Ø¯Ù…Ø©':'Ø¹Ù…ÙŠÙ„'),
    `<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div class="form-group"><label class="form-label">Ø§Ù„Ø§Ø³Ù… *</label><input type="text" class="form-inp" id="nu-name"></div>
      <div class="form-group"><label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ *</label><input type="email" class="form-inp" id="nu-email"></div>
      <div class="form-group"><label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± *</label><input type="password" class="form-inp" id="nu-pass"></div>
      <div class="form-group"><label class="form-label">Ø§Ù„Ù‡Ø§ØªÙ</label><input type="text" class="form-inp" id="nu-phone"></div>
      <div class="form-group"><label class="form-label">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label><input type="text" class="form-inp" id="nu-city"></div>
    </div>
    ${isProvider?`<div class="form-group"><label class="form-label">Ø§Ù„ØªØ®ØµØµØ§Øª (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©)</label><input type="text" class="form-inp" id="nu-specs" placeholder="ÙƒÙ‡Ø±Ø¨Ø§Ø¡, Ø³Ø¨Ø§ÙƒØ©"></div>`:''}`,
    `<button class="btn btn-ghost" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button><button class="btn btn-p" onclick="doAddUser('${role}')">Ø¥Ø¶Ø§ÙØ©</button>`
  );
}

function doAddUser(role){
  var name=document.getElementById('nu-name').value;
  var email=document.getElementById('nu-email').value;
  var pass=document.getElementById('nu-pass').value;
  if(!name||!email||!pass){toast('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù…Ø·Ù„ÙˆØ¨Ø©','error');return;}
  var specs=document.getElementById('nu-specs')?document.getElementById('nu-specs').value.split(',').map(function(s){return s.trim();}).filter(Boolean):[];
  api('/api/admin/users',{method:'POST',body:JSON.stringify({
    name:name,email:email,password:pass,
    phone:document.getElementById('nu-phone').value,
    city:document.getElementById('nu-city').value,
    role:role,specialties:specs
  })}).then(function(u){
    if(u.message){toast(u.message,'error');return;}
    closeModal();toast('ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…','success');
    if(currentPage==='providers')renderProviders();else renderClients();
  });
}

function editUser(id){
  var u=allUsers.find(function(x){return x.id===id;});if(!u)return;
  openModal('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… â€” '+u.name,
    `<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div class="form-group"><label class="form-label">Ø§Ù„Ø§Ø³Ù…</label><input type="text" class="form-inp" id="eu-name" value="${u.name}"></div>
      <div class="form-group"><label class="form-label">Ø§Ù„Ù‡Ø§ØªÙ</label><input type="text" class="form-inp" id="eu-phone" value="${u.phone||''}"></div>
      <div class="form-group"><label class="form-label">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label><input type="text" class="form-inp" id="eu-city" value="${u.city||''}"></div>
      <div class="form-group"><label class="form-label">Ø§Ù„Ø¯ÙˆØ±</label>
        <select class="form-sel" id="eu-role"><option value="client" ${u.role==='client'?'selected':''}>Ø¹Ù…ÙŠÙ„</option><option value="provider" ${u.role==='provider'?'selected':''}>Ù…Ø²ÙˆØ¯</option><option value="admin" ${u.role==='admin'?'selected':''}>Ù…Ø¯ÙŠØ±</option></select>
      </div>
    </div>
    ${u.role==='provider'?`<div class="form-group"><label class="form-label">Ø§Ù„ØªØ®ØµØµØ§Øª</label><input type="text" class="form-inp" id="eu-specs" value="${u.specialties?u.specialties.join(', '):''}"></div>`:''}`,
    `<button class="btn btn-ghost" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button><button class="btn btn-p" onclick="doEditUser(${id})">Ø­ÙØ¸</button>`
  );
}

function doEditUser(id){
  var u=allUsers.find(function(x){return x.id===id;})||{};
  var specs=document.getElementById('eu-specs')?document.getElementById('eu-specs').value.split(',').map(function(s){return s.trim();}).filter(Boolean):u.specialties;
  api('/api/admin/users/'+id,{method:'PUT',body:JSON.stringify({
    name:document.getElementById('eu-name').value,
    phone:document.getElementById('eu-phone').value,
    city:document.getElementById('eu-city').value,
    role:document.getElementById('eu-role').value,
    badge:u.badge,is_active:u.is_active,
    specialties:specs,bio:u.bio
  })}).then(function(){closeModal();toast('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…','success');if(currentPage==='providers')renderProviders();else renderClients();});
}

function deleteReview(id){
  if(!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…ØŸ'))return;
  api('/api/admin/reviews/'+id,{method:'DELETE'}).then(function(){toast('ØªÙ… Ø§Ù„Ø­Ø°Ù','error');renderReviews();});
}

// Init
showPage('home', document.querySelector('.sb-item.on'));
</script>
</body>
</html>
