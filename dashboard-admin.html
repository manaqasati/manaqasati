<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>مناقصة — لوحة المدير</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
/* ════════════════════════════════════════
   DESIGN SYSTEM
════════════════════════════════════════ */
:root {
  /* Colors */
  --gray-50:#f9fafb;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-300:#d1d5db;
  --gray-400:#9ca3af;--gray-500:#6b7280;--gray-600:#4b5563;--gray-700:#374151;
  --gray-800:#1f2937;--gray-900:#111827;
  --violet-50:#f5f3ff;--violet-100:#ede9fe;--violet-200:#ddd6fe;--violet-300:#c4b5fd;
  --violet-400:#a78bfa;--violet-500:#8b5cf6;--violet-600:#7c3aed;--violet-700:#6d28d9;
  --violet-800:#5b21b6;--violet-900:#4c1d95;
  --amber-50:#fffbeb;--amber-100:#fef3c7;--amber-200:#fde68a;--amber-300:#fcd34d;
  --amber-400:#fbbf24;--amber-500:#f59e0b;--amber-600:#d97706;
  --emerald-50:#ecfdf5;--emerald-100:#d1fae5;--emerald-200:#a7f3d0;
  --emerald-500:#10b981;--emerald-600:#059669;--emerald-700:#047857;
  --red-50:#fef2f2;--red-100:#fee2e2;--red-400:#f87171;--red-500:#ef4444;--red-600:#dc2626;
  --blue-50:#eff6ff;--blue-100:#dbeafe;--blue-500:#3b82f6;--blue-600:#2563eb;
  --orange-50:#fff7ed;--orange-100:#ffedd5;--orange-500:#f97316;--orange-600:#ea580c;

  /* Semantic */
  --bg:#f8f9fb;--surface:#ffffff;--border:#e5e7eb;--border-subtle:#f3f4f6;
  --text-primary:#111827;--text-secondary:#6b7280;--text-tertiary:#9ca3af;
  --brand:#7c3aed;--brand-light:#ede9fe;--brand-dark:#6d28d9;
  --gold:#f59e0b;--gold-light:#fef3c7;

  /* Layout */
  --sidebar:240px;--topbar:52px;

  /* Radius */
  --r-sm:6px;--r-md:8px;--r-lg:12px;--r-xl:16px;--r-full:9999px;

  /* Shadow */
  --shadow-sm:0 1px 2px rgba(0,0,0,.05);
  --shadow-md:0 4px 6px -1px rgba(0,0,0,.07),0 2px 4px -1px rgba(0,0,0,.05);
  --shadow-lg:0 10px 15px -3px rgba(0,0,0,.08),0 4px 6px -2px rgba(0,0,0,.04);
  --shadow-xl:0 20px 25px -5px rgba(0,0,0,.1),0 10px 10px -5px rgba(0,0,0,.04);

  /* Transition */
  --t-fast:100ms ease;--t-base:150ms ease;--t-slow:250ms ease;
}

/* ── Reset ── */
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{-webkit-text-size-adjust:100%}
body{font-family:'Tajawal',sans-serif;font-size:14px;line-height:1.5;color:var(--text-primary);background:var(--bg);display:flex;min-height:100vh;overflow-x:hidden;-webkit-font-smoothing:antialiased}
button{font-family:inherit;cursor:pointer;border:none;background:none}
input,select,textarea{font-family:inherit;font-size:inherit}
a{text-decoration:none;color:inherit}
img{max-width:100%;display:block}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--gray-200);border-radius:var(--r-full)}
::-webkit-scrollbar-thumb:hover{background:var(--gray-300)}

/* ════════════════════════════════════════
   SIDEBAR
════════════════════════════════════════ */
.sidebar{
  width:var(--sidebar);background:var(--gray-900);
  position:fixed;top:0;right:0;bottom:0;z-index:300;
  display:flex;flex-direction:column;
  transition:transform var(--t-slow);
  will-change:transform;
}

/* Logo */
.sidebar-logo{
  height:var(--topbar);display:flex;align-items:center;gap:10px;
  padding:0 16px;border-bottom:1px solid rgba(255,255,255,.06);flex-shrink:0;
}
.logo-mark{
  width:30px;height:30px;border-radius:var(--r-md);
  background:linear-gradient(135deg,var(--amber-500),var(--orange-500));
  display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.logo-mark svg{width:16px;height:16px;stroke:#fff;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.logo-text{font-size:15px;font-weight:900;color:#fff;letter-spacing:-.3px}
.logo-text span{color:var(--amber-400)}

/* User card */
.sidebar-user{
  padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.06);flex-shrink:0;
}
.user-row{display:flex;align-items:center;gap:10px}
.user-avatar{
  width:34px;height:34px;border-radius:var(--r-md);
  background:linear-gradient(135deg,var(--violet-600),var(--violet-400));
  display:flex;align-items:center;justify-content:center;
  font-size:13px;font-weight:800;color:#fff;flex-shrink:0;letter-spacing:-.5px;
}
.user-info{flex:1;min-width:0}
.user-name{font-size:12px;font-weight:700;color:#f9fafb;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.user-role{display:flex;align-items:center;gap:4px;margin-top:2px}
.user-role-dot{width:5px;height:5px;border-radius:50%;background:var(--emerald-500);flex-shrink:0}
.user-role-text{font-size:10px;color:var(--gray-500)}

/* Nav */
.sidebar-nav{flex:1;overflow-y:auto;padding:8px;scrollbar-width:none}
.sidebar-nav::-webkit-scrollbar{display:none}
.nav-section{margin-bottom:4px}
.nav-label{
  font-size:9px;font-weight:700;color:var(--gray-600);letter-spacing:.8px;
  text-transform:uppercase;padding:12px 10px 4px;
}
.nav-item{
  display:flex;align-items:center;gap:9px;
  padding:7px 10px;border-radius:var(--r-md);
  color:var(--gray-400);font-size:12px;font-weight:600;
  cursor:pointer;transition:background var(--t-fast),color var(--t-fast);
  margin-bottom:1px;position:relative;width:100%;text-align:right;
}
.nav-item:hover{background:rgba(255,255,255,.05);color:var(--gray-200)}
.nav-item.active{background:rgba(124,58,237,.15);color:var(--violet-300)}
.nav-item.active::after{
  content:'';position:absolute;right:0;top:20%;bottom:20%;
  width:2px;border-radius:var(--r-full);background:var(--violet-500);
}
.nav-icon{
  width:28px;height:28px;display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.nav-icon svg{width:15px;height:15px;stroke:currentColor;fill:none;stroke-width:1.6;stroke-linecap:round;stroke-linejoin:round}
.nav-label-text{flex:1}
.nav-badge{
  font-size:9px;font-weight:800;padding:1px 6px;border-radius:var(--r-full);
  min-width:18px;text-align:center;flex-shrink:0;
}
.nav-badge-red{background:var(--red-500);color:#fff}
.nav-badge-amber{background:var(--amber-500);color:#fff}
.nav-badge-violet{background:var(--violet-600);color:#fff}

/* Sidebar bottom */
.sidebar-bottom{padding:8px;border-top:1px solid rgba(255,255,255,.06);flex-shrink:0}
.sidebar-version{text-align:center;font-size:9px;color:var(--gray-700);padding:6px 0 0}

/* ════════════════════════════════════════
   MAIN
════════════════════════════════════════ */
.main{margin-right:var(--sidebar);flex:1;display:flex;flex-direction:column;min-height:100vh;max-width:calc(100vw - var(--sidebar))}

/* Topbar */
.topbar{
  height:var(--topbar);background:var(--surface);
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;position:sticky;top:0;z-index:100;flex-shrink:0;
}
.topbar-left{display:flex;align-items:center;gap:8px}
.breadcrumb{display:flex;align-items:center;gap:6px;font-size:12px}
.bc-home{color:var(--text-tertiary);font-weight:500}
.bc-sep{color:var(--gray-300)}
.bc-current{color:var(--text-primary);font-weight:700}
.topbar-right{display:flex;align-items:center;gap:6px}
.topbar-clock{
  font-size:11px;font-weight:700;color:var(--text-secondary);
  background:var(--gray-50);border:1px solid var(--border);
  padding:4px 10px;border-radius:var(--r-sm);font-variant-numeric:tabular-nums;
}
.icon-btn{
  width:32px;height:32px;border-radius:var(--r-md);
  border:1px solid var(--border);background:var(--surface);
  display:flex;align-items:center;justify-content:center;
  color:var(--text-secondary);cursor:pointer;
  transition:all var(--t-fast);position:relative;
}
.icon-btn:hover{background:var(--gray-50);color:var(--text-primary);border-color:var(--gray-300)}
.icon-btn svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:1.6;stroke-linecap:round;stroke-linejoin:round}
.icon-btn-dot{position:absolute;top:4px;left:4px;width:6px;height:6px;border-radius:50%;background:var(--red-500);border:1.5px solid var(--surface)}

/* Page content */
.page-content{padding:20px;flex:1}

/* ════════════════════════════════════════
   PAGE HEADER
════════════════════════════════════════ */
.page-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px;gap:12px;flex-wrap:wrap}
.page-header-left{}
.page-title{font-size:18px;font-weight:900;color:var(--text-primary);letter-spacing:-.3px;line-height:1.2}
.page-subtitle{font-size:12px;color:var(--text-secondary);margin-top:3px;font-weight:500}
.page-header-right{display:flex;gap:8px;align-items:center;flex-shrink:0}

/* ════════════════════════════════════════
   STATS GRID
════════════════════════════════════════ */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-bottom:20px}
.stat-card{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);
  padding:16px;cursor:default;transition:box-shadow var(--t-base),transform var(--t-base);
  position:relative;overflow:hidden;
}
.stat-card:hover{box-shadow:var(--shadow-md);transform:translateY(-1px)}
.stat-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.stat-icon{width:36px;height:36px;border-radius:var(--r-md);display:flex;align-items:center;justify-content:center}
.stat-icon svg{width:16px;height:16px;stroke-width:1.6;stroke-linecap:round;stroke-linejoin:round}
.stat-trend{font-size:10px;font-weight:700;padding:2px 7px;border-radius:var(--r-full)}
.trend-up{background:var(--emerald-100);color:var(--emerald-700)}
.trend-warn{background:var(--orange-100);color:var(--orange-600)}
.trend-neutral{background:var(--gray-100);color:var(--gray-500)}
.stat-value{font-size:24px;font-weight:900;color:var(--text-primary);letter-spacing:-.5px;line-height:1;margin-bottom:3px}
.stat-label{font-size:11px;color:var(--text-secondary);font-weight:500}
.stat-bar{height:2px;background:var(--gray-100);border-radius:var(--r-full);margin-top:12px;overflow:hidden}
.stat-bar-fill{height:100%;border-radius:var(--r-full);transition:width 1.2s cubic-bezier(.4,0,.2,1)}

/* ════════════════════════════════════════
   CARD
════════════════════════════════════════ */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);overflow:hidden;margin-bottom:16px}
.card-header{
  padding:12px 16px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
  gap:12px;flex-wrap:wrap;
}
.card-header-left{display:flex;align-items:center;gap:10px}
.card-icon{width:30px;height:30px;border-radius:var(--r-sm);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.card-icon svg{width:14px;height:14px;stroke-width:1.6;stroke-linecap:round;stroke-linejoin:round}
.card-title{font-size:13px;font-weight:800;color:var(--text-primary)}
.card-subtitle{font-size:10px;color:var(--text-secondary);margin-top:1px}
.card-header-right{display:flex;gap:6px;align-items:center;flex-shrink:0}
.card-body{padding:16px}
.card-footer{padding:10px 16px;border-top:1px solid var(--border-subtle);background:var(--gray-50);display:flex;align-items:center;justify-content:space-between}

/* ════════════════════════════════════════
   BUTTONS
════════════════════════════════════════ */
.btn{
  display:inline-flex;align-items:center;justify-content:center;gap:6px;
  padding:7px 14px;border-radius:var(--r-md);
  font-size:12px;font-weight:700;line-height:1;
  cursor:pointer;border:none;transition:all var(--t-fast);
  white-space:nowrap;user-select:none;
}
.btn:active{transform:scale(.97)}
.btn svg{width:13px;height:13px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0}

.btn-primary{background:var(--violet-600);color:#fff}
.btn-primary:hover{background:var(--violet-700)}
.btn-success{background:var(--emerald-600);color:#fff}
.btn-success:hover{background:var(--emerald-700)}
.btn-danger{background:var(--red-500);color:#fff}
.btn-danger:hover{background:var(--red-600)}
.btn-warning{background:var(--amber-500);color:#fff}
.btn-warning:hover{background:var(--amber-600)}
.btn-info{background:var(--blue-500);color:#fff}
.btn-info:hover{background:var(--blue-600)}
.btn-orange{background:var(--orange-500);color:#fff}
.btn-orange:hover{background:var(--orange-600)}
.btn-ghost{background:var(--surface);color:var(--text-primary);border:1px solid var(--border)}
.btn-ghost:hover{background:var(--gray-50);border-color:var(--gray-300)}
.btn-subtle{background:var(--gray-100);color:var(--text-secondary)}
.btn-subtle:hover{background:var(--gray-200);color:var(--text-primary)}

.btn-sm{padding:5px 10px;font-size:11px;border-radius:var(--r-sm);gap:4px}
.btn-sm svg{width:12px;height:12px}
.btn-xs{padding:3px 8px;font-size:10px;border-radius:var(--r-sm);gap:3px}
.btn-xs svg{width:11px;height:11px}
.btn-icon{padding:7px;border-radius:var(--r-md)}
.btn-icon-sm{padding:5px;border-radius:var(--r-sm)}

/* ════════════════════════════════════════
   BADGES / TAGS
════════════════════════════════════════ */
.badge{
  display:inline-flex;align-items:center;gap:4px;
  padding:2px 8px;border-radius:var(--r-full);
  font-size:10px;font-weight:700;white-space:nowrap;border:1px solid transparent;
}
.badge::before{content:'';width:4px;height:4px;border-radius:50%;flex-shrink:0}

.badge-pending{background:var(--amber-50);color:#92400e;border-color:var(--amber-200)}.badge-pending::before{background:var(--amber-500)}
.badge-open{background:var(--emerald-50);color:var(--emerald-700);border-color:var(--emerald-200)}.badge-open::before{background:var(--emerald-500)}
.badge-progress{background:var(--blue-50);color:var(--blue-600);border-color:var(--blue-100)}.badge-progress::before{background:var(--blue-500)}
.badge-done{background:var(--violet-50);color:var(--violet-700);border-color:var(--violet-200)}.badge-done::before{background:var(--violet-600)}
.badge-rejected{background:var(--red-50);color:var(--red-600);border-color:var(--red-100)}.badge-rejected::before{background:var(--red-500)}
.badge-active{background:var(--emerald-50);color:var(--emerald-700);border-color:var(--emerald-200)}.badge-active::before{background:var(--emerald-500)}
.badge-inactive{background:var(--gray-100);color:var(--gray-500);border-color:var(--gray-200)}.badge-inactive::before{background:var(--gray-400)}
.badge-warning{background:var(--orange-50);color:var(--orange-600);border-color:var(--orange-100)}.badge-warning::before{background:var(--orange-500)}
.badge-reported{background:var(--red-50);color:var(--red-600);border-color:var(--red-100)}.badge-reported::before{background:var(--red-500)}
.badge-pinned{background:var(--amber-50);color:var(--amber-600);border-color:var(--amber-200)}.badge-pinned::before{background:var(--amber-500)}
.badge-hidden{background:var(--gray-100);color:var(--gray-500);border-color:var(--gray-200)}.badge-hidden::before{background:var(--gray-400)}

/* Provider badges */
.pb{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:var(--r-full);font-size:10px;font-weight:700;border:1px solid}
.pb-none{background:var(--gray-50);color:var(--gray-400);border-color:var(--gray-200)}
.pb-verified{background:var(--blue-50);color:var(--blue-600);border-color:var(--blue-100)}
.pb-star{background:var(--amber-50);color:var(--amber-600);border-color:var(--amber-200)}
.pb-partner{background:var(--violet-50);color:var(--violet-700);border-color:var(--violet-200)}
.pb-top{background:var(--emerald-50);color:var(--emerald-700);border-color:var(--emerald-200)}

/* ════════════════════════════════════════
   TABLE
════════════════════════════════════════ */
.table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
.table{width:100%;border-collapse:collapse;min-width:640px}
.table th{
  text-align:right;padding:9px 14px;
  font-size:10px;font-weight:700;color:var(--text-secondary);
  background:var(--gray-50);border-bottom:1px solid var(--border);
  white-space:nowrap;letter-spacing:.3px;text-transform:uppercase;
}
.table td{padding:11px 14px;border-bottom:1px solid var(--border-subtle);vertical-align:middle}
.table tr:last-child td{border-bottom:none}
.table tbody tr{transition:background var(--t-fast)}
.table tbody tr:hover td{background:var(--gray-50)}
.table-avatar{
  width:32px;height:32px;border-radius:var(--r-md);
  color:#fff;font-size:12px;font-weight:800;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.table-name{font-size:13px;font-weight:700;color:var(--text-primary);margin-bottom:1px}
.table-meta{font-size:11px;color:var(--text-tertiary)}
.table-actions{display:flex;gap:4px;align-items:center;flex-wrap:wrap}

/* ════════════════════════════════════════
   FILTER BAR
════════════════════════════════════════ */
.filter-bar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;align-items:center}
.search-box{
  flex:1;min-width:200px;display:flex;align-items:center;gap:8px;
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r-md);padding:0 12px;
  transition:border-color var(--t-fast),box-shadow var(--t-fast);
}
.search-box:focus-within{border-color:var(--gray-400);box-shadow:0 0 0 3px rgba(124,58,237,.06)}
.search-box svg{width:14px;height:14px;stroke:var(--text-tertiary);fill:none;stroke-width:1.6;flex-shrink:0;stroke-linecap:round;stroke-linejoin:round}
.search-box input{
  border:none;outline:none;background:transparent;
  font-size:12px;padding:8px 0;flex:1;color:var(--text-primary);
}
.search-box input::placeholder{color:var(--text-tertiary)}
.filter-select{
  padding:7px 10px;border:1px solid var(--border);border-radius:var(--r-md);
  font-size:12px;font-weight:600;background:var(--surface);color:var(--text-primary);
  outline:none;cursor:pointer;transition:border-color var(--t-fast);
}
.filter-select:focus{border-color:var(--gray-400)}

/* ════════════════════════════════════════
   PROJECT CARD
════════════════════════════════════════ */
.project-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r-lg);padding:16px;margin-bottom:10px;
  transition:box-shadow var(--t-base);position:relative;
  border-right:3px solid transparent;
}
.project-card:hover{box-shadow:var(--shadow-md)}
.pc-pending{border-right-color:var(--amber-400)}
.pc-open{border-right-color:var(--emerald-500)}
.pc-progress{border-right-color:var(--blue-500)}
.pc-done{border-right-color:var(--violet-600)}
.pc-rejected{border-right-color:var(--red-500)}
.project-card-header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:10px}
.project-number{font-size:9px;font-weight:800;color:var(--text-tertiary);font-variant-numeric:tabular-nums;letter-spacing:.5px;margin-bottom:3px}
.project-title{font-size:14px;font-weight:800;color:var(--text-primary);line-height:1.3;letter-spacing:-.2px}
.project-meta{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
.meta-chip{
  display:inline-flex;align-items:center;gap:4px;
  padding:3px 8px;border-radius:var(--r-full);
  background:var(--gray-50);border:1px solid var(--border);
  font-size:10px;font-weight:600;color:var(--text-secondary);
}
.meta-chip svg{width:10px;height:10px;stroke:currentColor;fill:none;stroke-width:2;flex-shrink:0;stroke-linecap:round;stroke-linejoin:round}
.project-desc{
  font-size:12px;color:var(--text-secondary);line-height:1.7;
  padding:10px 12px;background:var(--gray-50);border-radius:var(--r-md);
  border-right:2px solid var(--violet-200);margin-bottom:10px;
}
.project-actions{display:flex;gap:6px;flex-wrap:wrap;align-items:center}

/* ════════════════════════════════════════
   BID CARD
════════════════════════════════════════ */
.bid-card{border:1px solid var(--border);border-radius:var(--r-md);padding:12px;margin-bottom:8px;background:var(--surface);transition:border-color var(--t-fast)}
.bid-card:hover{border-color:var(--gray-300)}
.bid-accepted{border-color:var(--emerald-200);background:var(--emerald-50)}
.bid-rejected{opacity:.65;border-style:dashed}
.bid-header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.bid-avatar{width:34px;height:34px;border-radius:var(--r-md);background:linear-gradient(135deg,var(--violet-600),var(--violet-400));color:#fff;font-size:13px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.bid-name{font-size:13px;font-weight:700;color:var(--text-primary)}
.bid-sub{font-size:10px;color:var(--text-tertiary);margin-top:1px}
.bid-stars{color:var(--amber-400);font-size:11px;letter-spacing:1px}
.bid-details{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
.bid-detail{background:var(--gray-50);border:1px solid var(--border);border-radius:var(--r-sm);padding:5px 10px;font-size:11px}
.bid-detail strong{color:var(--text-primary);font-weight:800}
.bid-detail span{color:var(--text-tertiary)}
.bid-note{font-size:11px;color:var(--text-secondary);background:var(--gray-50);padding:8px 10px;border-radius:var(--r-sm);line-height:1.7;border-right:2px solid var(--violet-200)}
.bid-actions{display:flex;gap:6px;margin-top:8px}

/* ════════════════════════════════════════
   REVIEW CARD
════════════════════════════════════════ */
.review-card{border:1px solid var(--border);border-radius:var(--r-md);padding:14px;margin-bottom:8px;background:var(--surface);transition:all var(--t-base)}
.review-card:hover{border-color:var(--gray-300)}
.review-card.is-pinned{border-color:var(--amber-300);background:var(--amber-50)}
.review-card.is-hidden{opacity:.5;border-style:dashed}
.review-card.is-reported{border-right:2px solid var(--red-500)}
.review-header{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:10px}
.review-parties{display:flex;align-items:center;gap:8px}
.review-avatar{width:30px;height:30px;border-radius:var(--r-md);color:#fff;font-size:12px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.review-arrow{color:var(--text-tertiary)}
.review-party-name{font-size:12px;font-weight:700}
.review-party-role{font-size:9px;color:var(--text-tertiary);margin-top:1px}
.review-rating{display:flex;gap:1px;margin-bottom:6px}
.star-on{color:var(--amber-400);font-size:14px}
.star-off{color:var(--gray-200);font-size:14px}
.review-text{font-size:12px;color:var(--text-secondary);background:var(--gray-50);padding:10px 12px;border-radius:var(--r-md);line-height:1.7;border-right:2px solid var(--violet-200)}
.review-admin-reply{background:var(--violet-50);border:1px solid var(--violet-100);border-radius:var(--r-md);padding:10px 12px;margin-top:8px}
.reply-label{font-size:9px;font-weight:800;color:var(--violet-600);letter-spacing:.4px;margin-bottom:4px;text-transform:uppercase}
.reply-text{font-size:11px;color:var(--violet-800);line-height:1.6}
.review-footer{display:flex;align-items:center;justify-content:space-between;margin-top:10px;flex-wrap:wrap;gap:8px}
.review-date{font-size:10px;color:var(--text-tertiary)}
.review-flags{display:flex;gap:4px}
.review-actions{display:flex;gap:4px;flex-wrap:wrap}

/* ════════════════════════════════════════
   DISPUTE CARD
════════════════════════════════════════ */
.dispute-card{border:1px solid var(--border);border-radius:var(--r-md);padding:14px;margin-bottom:8px;background:var(--surface)}
.dispute-card.open{border-right:3px solid var(--red-500)}
.dispute-card.resolved{border-right:3px solid var(--emerald-500);opacity:.75}
.dispute-title{font-size:13px;font-weight:800;color:var(--text-primary);margin-bottom:2px}
.dispute-meta{font-size:10px;color:var(--text-tertiary)}
.dispute-description{font-size:12px;color:var(--text-secondary);background:var(--gray-50);padding:10px 12px;border-radius:var(--r-md);line-height:1.7;margin:10px 0}
.dispute-parties{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.dispute-party{display:flex;align-items:center;gap:8px;background:var(--gray-50);border:1px solid var(--border);border-radius:var(--r-md);padding:8px 12px;flex:1;min-width:160px}
.dispute-party-avatar{width:28px;height:28px;border-radius:var(--r-sm);color:#fff;font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.dispute-party-name{font-size:12px;font-weight:700}
.dispute-party-role{font-size:10px;color:var(--text-tertiary)}
.dispute-resolution{background:var(--emerald-50);border:1px solid var(--emerald-200);border-radius:var(--r-md);padding:10px 12px;font-size:12px;color:var(--emerald-700);margin-bottom:10px}

/* ════════════════════════════════════════
   LOG ITEM
════════════════════════════════════════ */
.log-item{display:flex;align-items:flex-start;gap:12px;padding:10px 0;border-bottom:1px solid var(--border-subtle)}
.log-item:last-child{border-bottom:none}
.log-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:5px}
.log-body{flex:1;min-width:0}
.log-action{font-size:12px;font-weight:700;color:var(--text-primary)}
.log-detail{font-size:11px;color:var(--text-secondary);margin-top:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.log-time{font-size:10px;color:var(--text-tertiary);flex-shrink:0;margin-top:2px}

/* ════════════════════════════════════════
   MODAL
════════════════════════════════════════ */
.overlay{
  display:none;position:fixed;inset:0;z-index:500;
  background:rgba(0,0,0,.4);backdrop-filter:blur(6px);
  align-items:center;justify-content:center;padding:16px;
}
.overlay.visible{display:flex}
.modal{
  background:var(--surface);border-radius:var(--r-xl);
  width:100%;max-width:640px;max-height:90vh;
  overflow-y:auto;box-shadow:var(--shadow-xl);
  animation:modalIn .2s cubic-bezier(.34,1.56,.64,1);
}
@keyframes modalIn{from{opacity:0;transform:scale(.95) translateY(8px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal::-webkit-scrollbar{width:4px}
.modal-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 18px;border-bottom:1px solid var(--border);
  position:sticky;top:0;background:var(--surface);z-index:2;
  border-radius:var(--r-xl) var(--r-xl) 0 0;
}
.modal-header-left{display:flex;align-items:center;gap:10px}
.modal-icon{width:30px;height:30px;border-radius:var(--r-md);display:flex;align-items:center;justify-content:center}
.modal-icon svg{width:14px;height:14px;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round}
.modal-title{font-size:14px;font-weight:800;color:var(--text-primary);letter-spacing:-.2px}
.modal-close{
  width:28px;height:28px;border-radius:var(--r-md);
  background:var(--gray-100);border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  color:var(--text-secondary);font-size:16px;line-height:1;
  transition:all var(--t-fast);
}
.modal-close:hover{background:var(--red-100);color:var(--red-600)}
.modal-body{padding:18px}
.modal-footer{
  display:flex;gap:8px;justify-content:flex-end;
  padding:12px 18px;border-top:1px solid var(--border);
  background:var(--gray-50);border-radius:0 0 var(--r-xl) var(--r-xl);
}

/* ════════════════════════════════════════
   FORM
════════════════════════════════════════ */
.form-group{display:flex;flex-direction:column;gap:5px;margin-bottom:12px}
.form-label{font-size:11px;font-weight:700;color:var(--text-primary)}
.form-label-hint{color:var(--text-tertiary);font-weight:500;margin-right:4px}
.form-input{
  padding:8px 11px;border:1px solid var(--border);border-radius:var(--r-md);
  font-size:13px;outline:none;background:var(--surface);color:var(--text-primary);
  transition:border-color var(--t-fast),box-shadow var(--t-fast);width:100%;
}
.form-input:focus{border-color:var(--gray-400);box-shadow:0 0 0 3px rgba(124,58,237,.07)}
.form-input::placeholder{color:var(--text-tertiary)}
.form-select{
  padding:8px 11px;border:1px solid var(--border);border-radius:var(--r-md);
  font-size:13px;outline:none;background:var(--surface);color:var(--text-primary);
  cursor:pointer;transition:border-color var(--t-fast);width:100%;
}
.form-select:focus{border-color:var(--gray-400)}
.form-textarea{
  padding:8px 11px;border:1px solid var(--border);border-radius:var(--r-md);
  font-size:13px;outline:none;resize:vertical;min-height:80px;
  transition:border-color var(--t-fast),box-shadow var(--t-fast);width:100%;
  color:var(--text-primary);background:var(--surface);line-height:1.6;
}
.form-textarea:focus{border-color:var(--gray-400);box-shadow:0 0 0 3px rgba(124,58,237,.07)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.form-section{font-size:10px;font-weight:800;color:var(--violet-600);padding:10px 0 6px;border-bottom:1px solid var(--violet-100);margin:4px 0 12px;letter-spacing:.5px;text-transform:uppercase}

/* ════════════════════════════════════════
   SPECS CHECKBOX
════════════════════════════════════════ */
.specs-container{border:1px solid var(--border);border-radius:var(--r-md);overflow:hidden}
.specs-header{padding:8px 12px;background:var(--gray-50);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.specs-header-label{font-size:11px;font-weight:700;color:var(--text-primary)}
.specs-count{font-size:10px;font-weight:700;color:var(--violet-600);background:var(--violet-50);padding:2px 8px;border-radius:var(--r-full);border:1px solid var(--violet-100)}
.specs-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;padding:8px;max-height:190px;overflow-y:auto}
.spec-item{
  display:flex;align-items:center;gap:6px;padding:6px 8px;
  border:1px solid var(--border);border-radius:var(--r-sm);
  cursor:pointer;transition:all var(--t-fast);background:var(--surface);
}
.spec-item:hover{border-color:var(--gray-300);background:var(--gray-50)}
.spec-item.selected{border-color:var(--violet-400);background:var(--violet-50)}
.spec-item input{width:12px;height:12px;accent-color:var(--violet-600);cursor:pointer;flex-shrink:0}
.spec-item label{font-size:11px;font-weight:600;cursor:pointer;color:var(--text-secondary);line-height:1.3}
.spec-item.selected label{color:var(--violet-700);font-weight:700}

/* ════════════════════════════════════════
   IMAGE UPLOAD
════════════════════════════════════════ */
.img-upload{
  border:1.5px dashed var(--gray-300);border-radius:var(--r-md);
  padding:20px;text-align:center;cursor:pointer;
  transition:all var(--t-base);background:var(--gray-50);position:relative;
}
.img-upload:hover,.img-upload.dragging{border-color:var(--violet-400);background:var(--violet-50)}
.img-upload input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.img-upload-icon{width:40px;height:40px;border-radius:var(--r-md);background:var(--violet-100);display:flex;align-items:center;justify-content:center;margin:0 auto 10px}
.img-upload-icon svg{width:18px;height:18px;stroke:var(--violet-600);fill:none;stroke-width:1.6;stroke-linecap:round;stroke-linejoin:round}
.img-upload-title{font-size:12px;font-weight:700;color:var(--text-primary);margin-bottom:3px}
.img-upload-hint{font-size:10px;color:var(--text-tertiary)}
.img-previews{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.img-preview{position:relative;width:72px;height:72px;border-radius:var(--r-md);overflow:hidden;border:1px solid var(--border)}
.img-preview img{width:100%;height:100%;object-fit:cover}
.img-preview-del{
  position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;
  background:var(--red-500);color:#fff;border:none;cursor:pointer;
  font-size:11px;display:flex;align-items:center;justify-content:center;
  font-weight:800;line-height:1;transition:transform var(--t-fast);
}
.img-preview-del:hover{transform:scale(1.1)}

/* ════════════════════════════════════════
   INFO BLOCK
════════════════════════════════════════ */
.info-block{background:var(--gray-50);border-radius:var(--r-md);padding:12px;margin-bottom:10px;border:1px solid var(--border-subtle)}
.info-block-title{font-size:9px;font-weight:800;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px}
.info-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--border-subtle)}
.info-row:last-child{border-bottom:none}
.info-key{font-size:11px;color:var(--text-secondary);font-weight:500}
.info-val{font-size:11px;font-weight:700;color:var(--text-primary);text-align:left}

/* ════════════════════════════════════════
   NOTIFICATION TARGETS
════════════════════════════════════════ */
.notif-targets{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.notif-target{
  padding:6px 14px;border-radius:var(--r-md);border:1px solid var(--border);
  background:var(--surface);font-size:12px;font-weight:600;
  cursor:pointer;transition:all var(--t-fast);color:var(--text-secondary);
}
.notif-target:hover{border-color:var(--gray-300);color:var(--text-primary)}
.notif-target.active{border-color:var(--violet-400);background:var(--violet-600);color:#fff}

/* ════════════════════════════════════════
   PROGRESS / CHART
════════════════════════════════════════ */
.progress-row{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.progress-label{font-size:12px;font-weight:600;color:var(--text-primary);width:130px;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.progress-bar{flex:1;height:6px;border-radius:var(--r-full);background:var(--gray-100);overflow:hidden}
.progress-fill{height:100%;border-radius:var(--r-full);transition:width 1.2s cubic-bezier(.4,0,.2,1)}
.progress-value{font-size:11px;font-weight:700;color:var(--text-secondary);width:30px;text-align:left;flex-shrink:0}

/* ════════════════════════════════════════
   SETTINGS TOGGLE
════════════════════════════════════════ */
.settings-row{display:flex;align-items:center;justify-content:space-between;padding:13px 0;border-bottom:1px solid var(--border-subtle)}
.settings-row:last-child{border-bottom:none}
.settings-info{flex:1;padding-left:16px}
.settings-title{font-size:13px;font-weight:700;color:var(--text-primary)}
.settings-desc{font-size:11px;color:var(--text-secondary);margin-top:2px}
.toggle-switch{
  position:relative;width:36px;height:20px;flex-shrink:0;cursor:pointer;
}
.toggle-switch input{opacity:0;width:0;height:0;position:absolute}
.toggle-track{
  position:absolute;inset:0;border-radius:var(--r-full);
  background:var(--gray-200);transition:background var(--t-base);cursor:pointer;
}
.toggle-thumb{
  position:absolute;top:2px;right:2px;width:16px;height:16px;
  border-radius:50%;background:#fff;box-shadow:var(--shadow-sm);
  transition:transform var(--t-base);
}
.toggle-switch input:checked + .toggle-track{background:var(--emerald-500)}
.toggle-switch input:checked + .toggle-track .toggle-thumb{transform:translateX(-16px)}

/* ════════════════════════════════════════
   ALERT
════════════════════════════════════════ */
.alert{display:flex;align-items:flex-start;gap:10px;padding:10px 12px;border-radius:var(--r-md);margin-bottom:12px;font-size:12px;line-height:1.5}
.alert svg{width:14px;height:14px;flex-shrink:0;margin-top:1px;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round}
.alert-warning{background:var(--orange-50);border:1px solid var(--orange-100);color:#9a3412}
.alert-warning svg{stroke:var(--orange-500)}
.alert-info{background:var(--blue-50);border:1px solid var(--blue-100);color:#1e40af}
.alert-info svg{stroke:var(--blue-500)}
.alert-success{background:var(--emerald-50);border:1px solid var(--emerald-200);color:var(--emerald-700)}
.alert-success svg{stroke:var(--emerald-500)}
.alert-danger{background:var(--red-50);border:1px solid var(--red-100);color:var(--red-600)}
.alert-danger svg{stroke:var(--red-500)}

/* ════════════════════════════════════════
   TOAST
════════════════════════════════════════ */
.toast{
  position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(16px);
  background:var(--gray-900);color:#fff;
  padding:10px 18px;border-radius:var(--r-lg);
  font-size:12px;font-weight:600;z-index:9999;
  opacity:0;transition:all .2s cubic-bezier(.34,1.56,.64,1);
  pointer-events:none;display:flex;align-items:center;gap:8px;
  box-shadow:var(--shadow-xl);white-space:nowrap;
}
.toast.visible{opacity:1;transform:translateX(-50%) translateY(0)}
.toast-icon{width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;flex-shrink:0}
.toast-success{background:var(--emerald-600)}.toast-icon-success{background:rgba(255,255,255,.2)}
.toast-error{background:var(--red-600)}.toast-icon-error{background:rgba(255,255,255,.2)}
.toast-info{background:var(--gray-800)}.toast-icon-info{background:rgba(255,255,255,.1)}

/* ════════════════════════════════════════
   LOADING / EMPTY
════════════════════════════════════════ */
.loading-state{display:flex;flex-direction:column;align-items:center;padding:48px 20px;color:var(--text-tertiary)}
.spinner{width:28px;height:28px;border:2px solid var(--violet-100);border-top-color:var(--violet-600);border-radius:50%;animation:spin .7s linear infinite;margin-bottom:12px}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-size:12px;font-weight:600}

.empty-state{display:flex;flex-direction:column;align-items:center;padding:48px 20px;text-align:center}
.empty-icon{width:48px;height:48px;border-radius:var(--r-lg);background:var(--gray-100);border:1.5px dashed var(--gray-200);display:flex;align-items:center;justify-content:center;margin-bottom:12px}
.empty-icon svg{width:20px;height:20px;stroke:var(--gray-300);fill:none;stroke-width:1.5;stroke-linecap:round;stroke-linejoin:round}
.empty-title{font-size:13px;font-weight:700;color:var(--text-primary);margin-bottom:4px}
.empty-desc{font-size:11px;color:var(--text-secondary)}

/* ════════════════════════════════════════
   PROJECT BANNER (in modal)
════════════════════════════════════════ */
.project-banner{background:var(--gray-900);border-radius:var(--r-lg);padding:16px;margin-bottom:14px}
.banner-number{font-size:9px;font-weight:800;color:rgba(255,255,255,.3);letter-spacing:1px;margin-bottom:4px;font-variant-numeric:tabular-nums}
.banner-title{font-size:15px;font-weight:900;color:#fff;margin-bottom:10px;line-height:1.3;letter-spacing:-.3px}
.banner-meta{display:flex;gap:6px;flex-wrap:wrap}
.banner-chip{font-size:10px;color:rgba(255,255,255,.45);background:rgba(255,255,255,.07);padding:2px 9px;border-radius:var(--r-full);border:1px solid rgba(255,255,255,.08)}

/* ════════════════════════════════════════
   BADGE SELECTOR
════════════════════════════════════════ */
.badge-selector{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.badge-option{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:6px;padding:14px;border:1.5px solid var(--border);border-radius:var(--r-md);
  cursor:pointer;transition:all var(--t-fast);background:var(--surface);
  font-size:12px;font-weight:700;color:var(--text-secondary);
}
.badge-option:hover{border-color:var(--gray-300);background:var(--gray-50)}
.badge-option-icon{font-size:20px}
.badge-option.full{grid-column:1/-1}

/* ════════════════════════════════════════
   LAYOUT UTILITIES
════════════════════════════════════════ */
.two-col{display:grid;grid-template-columns:1.35fr 1fr;gap:16px}
.three-col{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.divider{height:1px;background:var(--border-subtle);margin:12px 0}
.spacer-sm{height:8px}.spacer-md{height:14px}.spacer-lg{height:20px}
.text-muted{color:var(--text-tertiary);font-size:11px}
.monospace{font-variant-numeric:tabular-nums;letter-spacing:.3px}

/* ════════════════════════════════════════
   MOBILE
════════════════════════════════════════ */
.mob-trigger{
  display:none;position:fixed;top:10px;left:10px;z-index:400;
  width:36px;height:36px;border-radius:var(--r-md);
  background:var(--violet-600);border:none;cursor:pointer;
  align-items:center;justify-content:center;box-shadow:var(--shadow-md);
}
.mob-trigger svg{width:16px;height:16px;stroke:#fff;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.mob-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:200}
@media(max-width:960px){
  .sidebar{transform:translateX(110%)}.sidebar.open{transform:translateX(0)}
  .main{margin-right:0}.mob-trigger{display:flex}.mob-overlay.active{display:block}
  .stats-grid{grid-template-columns:repeat(2,1fr)}
  .two-col,.three-col{grid-template-columns:1fr}
  .page-content{padding:14px}
  .topbar{padding:0 14px}
  .form-row,.form-row-3{grid-template-columns:1fr}
  .specs-grid{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>

<button class="mob-trigger" onclick="openSidebar()">
  <svg viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
</button>
<div class="mob-overlay" id="mobOverlay" onclick="closeSidebar()"></div>

<!-- ════ SIDEBAR ════ -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    <div class="logo-mark">
      <svg viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
    </div>
    <span class="logo-text">مناقصة<span>.</span></span>
  </div>

  <div class="sidebar-user">
    <div class="user-row">
      <div class="user-avatar" id="sidebarAvatar">م</div>
      <div class="user-info">
        <div class="user-name" id="sidebarName">المدير</div>
        <div class="user-role">
          <div class="user-role-dot"></div>
          <span class="user-role-text">مدير النظام • متصل الآن</span>
        </div>
      </div>
    </div>
  </div>

  <nav class="sidebar-nav">
    <div class="nav-section">
      <div class="nav-label">عام</div>
      <button class="nav-item active" onclick="navigate('home',this)">
        <div class="nav-icon"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg></div>
        <span class="nav-label-text">لوحة التحكم</span>
      </button>
    </div>

    <div class="nav-section">
      <div class="nav-label">المشاريع</div>
      <button class="nav-item" onclick="navigate('pending',this)">
        <div class="nav-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
        <span class="nav-label-text">قيد المراجعة</span>
        <span class="nav-badge nav-badge-amber" id="navPendingCount">0</span>
      </button>
      <button class="nav-item" onclick="navigate('projects',this)">
        <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div>
        <span class="nav-label-text">كل المشاريع</span>
      </button>
    </div>

    <div class="nav-section">
      <div class="nav-label">المستخدمون</div>
      <button class="nav-item" onclick="navigate('providers',this)">
        <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg></div>
        <span class="nav-label-text">مزودو الخدمة</span>
      </button>
      <button class="nav-item" onclick="navigate('clients',this)">
        <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
        <span class="nav-label-text">العملاء</span>
      </button>
    </div>

    <div class="nav-section">
      <div class="nav-label">التفاعل</div>
      <button class="nav-item" onclick="navigate('reviews',this)">
        <div class="nav-icon"><svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></div>
        <span class="nav-label-text">التقييمات</span>
        <span class="nav-badge nav-badge-red" id="navReportedCount" style="display:none">!</span>
      </button>
      <button class="nav-item" onclick="navigate('disputes',this)">
        <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>
        <span class="nav-label-text">النزاعات</span>
        <span class="nav-badge nav-badge-red" id="navDisputeCount">0</span>
      </button>
      <button class="nav-item" onclick="navigate('notifications',this)">
        <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg></div>
        <span class="nav-label-text">الإشعارات</span>
      </button>
    </div>

    <div class="nav-section">
      <div class="nav-label">التحليل</div>
      <button class="nav-item" onclick="navigate('reports',this)">
        <div class="nav-icon"><svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></div>
        <span class="nav-label-text">التقارير</span>
      </button>
      <button class="nav-item" onclick="navigate('activitylog',this)">
        <div class="nav-icon"><svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div>
        <span class="nav-label-text">سجل النشاط</span>
      </button>
    </div>

    <div class="nav-section">
      <div class="nav-label">النظام</div>
      <button class="nav-item" onclick="navigate('settings',this)">
        <div class="nav-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg></div>
        <span class="nav-label-text">الإعدادات</span>
      </button>
    </div>
  </nav>

  <div class="sidebar-bottom">
    <button class="nav-item" onclick="logout()" style="width:100%;color:var(--red-400)">
      <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></div>
      <span class="nav-label-text">تسجيل الخروج</span>
    </button>
    <div class="sidebar-version">مناقصة Admin • v3.0</div>
  </div>
</aside>

<!-- ════ MAIN ════ -->
<div class="main">
  <header class="topbar">
    <div class="topbar-left">
      <div class="breadcrumb">
        <span class="bc-home">مناقصة</span>
        <span class="bc-sep">/</span>
        <span class="bc-current" id="pageTitle">لوحة التحكم</span>
      </div>
    </div>
    <div class="topbar-right">
      <div class="topbar-clock" id="clock">--:--:--</div>
      <button class="icon-btn" onclick="navigate('notifications',null)" title="الإشعارات">
        <svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
      </button>
    </div>
  </header>

  <main class="page-content" id="pageContent">
    <div class="loading-state"><div class="spinner"></div><div class="loading-text">جاري التحميل…</div></div>
  </main>
</div>

<!-- MODAL -->
<div class="overlay" id="overlay">
  <div class="modal" id="modalEl">
    <div class="modal-header">
      <div class="modal-header-left">
        <div class="modal-icon" id="modalIcon"></div>
        <span class="modal-title" id="modalTitle">—</span>
      </div>
      <button class="modal-close" onclick="closeModal()">×</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-footer" id="modalFooter"></div>
  </div>
</div>

<div class="toast" id="toast">
  <div class="toast-icon" id="toastIcon"></div>
  <span id="toastMsg"></span>
</div>

<script>
/* ════════════════════════════════════════
   CONFIG & STATE
════════════════════════════════════════ */
const API = 'https://manaqasati-production.up.railway.app';
const token = localStorage.getItem('token');
const me = JSON.parse(localStorage.getItem('user') || '{}');

if (!token || me.role !== 'admin') location.href = 'auth.html';

let currentPage = 'home';
let allRequests = [], allUsers = [], allReviews = [], allDisputes = [];
let uploadedImages = {};
let activityLog = [];

/* ════════════════════════════════════════
   CONSTANTS
════════════════════════════════════════ */
const CATEGORIES = ['تبريد وتكييف','كهرباء','سباكة','نجارة','تنظيف','نقل عفش','حدادة','ألمنيوم','مسابح','كاميرات مراقبة','شبكات وإنترنت','مظلات وسواتر','عزل حراري','أبواب','جبس وطباشير','مكافحة حشرات','أخرى'];
const CITIES = ['الرياض','جدة','مكة المكرمة','المدينة المنورة','الدمام','الخبر','الظهران','الأحساء','الطائف','تبوك','بريدة','خميس مشيط','أبها','نجران','جيزان','حائل','ينبع','الجبيل','القطيف','سكاكا','عرعر','الباحة','الرس','رابغ','بيشة','وادي الدواسر','الزلفي','القريات'];
const AVATAR_COLORS = ['#7c3aed','#2563eb','#059669','#d97706','#dc2626','#0891b2','#7e22ce','#b45309'];
const STATUS_BADGE = {pending_review:'badge-pending',open:'badge-open',in_progress:'badge-progress',completed:'badge-done',rejected:'badge-rejected'};
const STATUS_LABEL = {pending_review:'قيد المراجعة',open:'مفتوح',in_progress:'قيد التنفيذ',completed:'مكتمل',rejected:'مرفوض'};
const STATUS_BORDER = {pending_review:'pc-pending',open:'pc-open',in_progress:'pc-progress',completed:'pc-done',rejected:'pc-rejected'};
const BADGE_MAP = {none:{cls:'pb-none',label:'بدون وسام',icon:'—'},verified:{cls:'pb-verified',label:'موثق',icon:'✓'},star:{cls:'pb-star',label:'متميز',icon:'⭐'},partner:{cls:'pb-partner',label:'شريك',icon:'💎'},top:{cls:'pb-top',label:'الأفضل',icon:'🏆'}};

/* ════════════════════════════════════════
   INIT
════════════════════════════════════════ */
document.getElementById('sidebarName').textContent = me.name || 'المدير';
document.getElementById('sidebarAvatar').textContent = (me.name || 'م')[0];
setInterval(() => {
  document.getElementById('clock').textContent = new Date().toLocaleTimeString('ar-SA', {hour12:false});
}, 1000);

/* ════════════════════════════════════════
   CORE UTILS
════════════════════════════════════════ */
async function apiFetch(path, options = {}) {
  try {
    const res = await fetch(API + path, {
      headers: {'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json'},
      ...options
    });
    return await res.json();
  } catch { return {}; }
}

let toastTimer;
function showToast(msg, type = 'info') {
  const el = document.getElementById('toast');
  const icon = document.getElementById('toastIcon');
  const text = document.getElementById('toastMsg');
  el.className = `toast toast-${type}`;
  icon.className = `toast-icon toast-icon-${type}`;
  icon.textContent = type === 'success' ? '✓' : type === 'error' ? '✕' : 'i';
  text.textContent = msg;
  el.classList.add('visible');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('visible'), 3200);
}

function openModal(title, body, footer, iconSvg, iconBg = 'var(--violet-100)') {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalBody').innerHTML = body;
  document.getElementById('modalFooter').innerHTML = footer || '';
  const ic = document.getElementById('modalIcon');
  ic.innerHTML = iconSvg || '';
  ic.style.background = iconBg;
  if (iconSvg) { const s = ic.querySelector('svg'); if (s) { s.style.width='14px'; s.style.height='14px'; s.style.strokeWidth='1.8'; s.style.fill='none'; s.style.strokeLinecap='round'; s.style.strokeLinejoin='round'; } }
  document.getElementById('overlay').classList.add('visible');
}

function closeModal() { document.getElementById('overlay').classList.remove('visible'); }

function navigate(page, btn) {
  currentPage = page;
  document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
  if (btn) btn.classList.add('active');
  const titles = {home:'لوحة التحكم',pending:'قيد المراجعة',projects:'المشاريع',providers:'مزودو الخدمة',clients:'العملاء',reviews:'التقييمات',disputes:'النزاعات',notifications:'الإشعارات',reports:'التقارير',activitylog:'سجل النشاط',settings:'الإعدادات'};
  document.getElementById('pageTitle').textContent = titles[page] || page;
  const pages = {home:renderHome,pending:renderPending,projects:renderProjects,providers:renderProviders,clients:renderClients,reviews:renderReviews,disputes:renderDisputes,notifications:renderNotifications,reports:renderReports,activitylog:renderActivityLog,settings:renderSettings};
  if (pages[page]) pages[page]();
  closeSidebar();
}

function openSidebar() { document.getElementById('sidebar').classList.add('open'); document.getElementById('mobOverlay').classList.add('active'); }
function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('mobOverlay').classList.remove('active'); }
function logout() { localStorage.clear(); location.href = 'auth.html'; }
function setContent(html) { document.getElementById('pageContent').innerHTML = html; }
function showLoading() { setContent(`<div class="loading-state"><div class="spinner"></div><div class="loading-text">جاري التحميل…</div></div>`); }

function addLog(action, detail, color = '#7c3aed') {
  activityLog.unshift({ action, detail, color, time: new Date().toLocaleTimeString('ar-SA') });
  if (activityLog.length > 200) activityLog.pop();
}

function reload() {
  const pages = {home:renderHome,pending:renderPending,projects:renderProjects,providers:renderProviders,clients:renderClients,reviews:renderReviews,disputes:renderDisputes,reports:renderReports,activitylog:renderActivityLog};
  if (pages[currentPage]) pages[currentPage]();
}

/* ════════════════════════════════════════
   HELPERS: city, specs, images
════════════════════════════════════════ */
function cityOptions(selected = '') {
  return `<option value="">اختر المدينة</option>` +
    CITIES.map(c => `<option value="${c}" ${c===selected?'selected':''}>${c}</option>`).join('') +
    `<option value="أخرى" ${'أخرى'===selected?'selected':''}>أخرى</option>`;
}

function specsCheckboxes(selected = []) {
  const cnt = selected.length;
  return `<div class="specs-container">
    <div class="specs-header">
      <span class="specs-header-label">التخصصات</span>
      <span class="specs-count" id="specCount">${cnt} محدد</span>
    </div>
    <div class="specs-grid">
      ${CATEGORIES.map((c,i) => {
        const on = selected.includes(c);
        return `<div class="spec-item${on?' selected':''}" onclick="toggleSpec(this)">
          <input type="checkbox" id="spec_${i}" value="${c}" ${on?'checked':''} onchange="updateSpecCount()">
          <label for="spec_${i}">${c}</label>
        </div>`;
      }).join('')}
    </div>
  </div>`;
}

function toggleSpec(el) {
  el.classList.toggle('selected');
  el.querySelector('input').checked = el.classList.contains('selected');
  updateSpecCount();
}
function updateSpecCount() {
  const cnt = document.querySelectorAll('.spec-item.selected').length;
  const el = document.getElementById('specCount');
  if (el) el.textContent = `${cnt} محدد`;
}
function getSelectedSpecs() {
  return [...document.querySelectorAll('.spec-item.selected input')].map(i => i.value);
}

function imageUploadHTML(id) {
  return `<div class="img-upload" id="imgUp_${id}">
    <input type="file" accept="image/*" multiple onchange="handleImages(this,'${id}')">
    <div class="img-upload-icon">
      <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
    </div>
    <div class="img-upload-title">اسحب الصور أو انقر للرفع</div>
    <div class="img-upload-hint">PNG, JPG, WEBP — حتى 5 صور</div>
  </div>
  <div class="img-previews" id="imgPrev_${id}"></div>`;
}

function handleImages(input, id) {
  const files = [...input.files];
  if (!uploadedImages[id]) uploadedImages[id] = [];
  files.forEach(f => {
    if (uploadedImages[id].length >= 5) return;
    const reader = new FileReader();
    reader.onload = e => { uploadedImages[id].push(e.target.result); renderImagePreviews(id); };
    reader.readAsDataURL(f);
  });
}
function renderImagePreviews(id) {
  const el = document.getElementById(`imgPrev_${id}`);
  if (!el) return;
  el.innerHTML = (uploadedImages[id] || []).map((src, i) =>
    `<div class="img-preview"><img src="${src}" alt=""><button class="img-preview-del" onclick="removeImage('${id}',${i})">×</button></div>`
  ).join('');
}
function removeImage(id, i) { uploadedImages[id].splice(i, 1); renderImagePreviews(id); }

function avatarColor(id) { return AVATAR_COLORS[(id || 0) % AVATAR_COLORS.length]; }
function avatarLetter(name) { return (name || '؟')[0]; }
function starsHtml(n) { return '★'.repeat(Math.max(0,Math.round(n))) + '☆'.repeat(Math.max(0,5-Math.round(n))); }
function formatDate(d) { return d ? new Date(d).toLocaleDateString('ar-SA') : '—'; }
function formatPrice(p) { return p ? Number(p).toLocaleString('ar-SA') + ' ر.س' : '—'; }

function projectCardHtml(r, showApprove = false) {
  const borderCls = STATUS_BORDER[r.status] || '';
  const actions = [];
  actions.push(`<button class="btn btn-subtle btn-sm" onclick="viewProject(${r.id})"><svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>تفاصيل</button>`);
  if (r.status === 'pending_review' || showApprove) {
    actions.push(`<button class="btn btn-success btn-sm" onclick="approveProject(${r.id})"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>موافقة</button>`);
    actions.push(`<button class="btn btn-danger btn-sm" onclick="rejectProject(${r.id})"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>رفض</button>`);
  }
  if (r.status === 'open' || r.status === 'in_progress') {
    actions.push(`<button class="btn btn-subtle btn-sm" onclick="manualAssign(${r.id})"><svg viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>إسناد</button>`);
  }
  if (r.status === 'in_progress') {
    actions.push(`<button class="btn btn-warning btn-sm" onclick="completeProject(${r.id})"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>إكمال</button>`);
  }
  actions.push(`<button class="btn btn-subtle btn-sm" onclick="editProjectModal(${r.id})"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>تعديل</button>`);
  if (['open','in_progress','pending_review'].includes(r.status)) {
    actions.push(`<button class="btn btn-orange btn-sm" onclick="openDisputeModal(${r.id})"><svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>نزاع</button>`);
  }
  actions.push(`<button class="btn btn-danger btn-sm" onclick="deleteProject(${r.id})"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>حذف</button>`);

  return `<div class="project-card ${borderCls}">
    <div class="project-card-header">
      <div>
        <div class="project-number monospace">${r.project_number || '#' + r.id}</div>
        <div class="project-title">${r.title}</div>
      </div>
      <span class="badge ${STATUS_BADGE[r.status] || ''}">${STATUS_LABEL[r.status] || r.status}</span>
    </div>
    <div class="project-meta">
      <span class="meta-chip"><svg viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13S3 17 3 10a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>${r.city || '—'}</span>
      <span class="meta-chip"><svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>${r.category || 'عام'}</span>
      ${r.budget_max ? `<span class="meta-chip"><svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>${Number(r.budget_max).toLocaleString()} ر.س</span>` : ''}
      ${r.deadline ? `<span class="meta-chip"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>${r.deadline}</span>` : ''}
      <span class="meta-chip"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>${r.bid_count || 0} عرض</span>
      ${r.client_name ? `<span class="meta-chip"><svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>${r.client_name}</span>` : ''}
    </div>
    ${r.description ? `<div class="project-desc">${r.description.slice(0,200)}${r.description.length>200?'…':''}</div>` : ''}
    <div class="project-actions">${actions.join('')}</div>
  </div>`;
}

/* ════════════════════════════════════════
   HOME PAGE
════════════════════════════════════════ */
async function renderHome() {
  showLoading();
  const [stats, recentProjects] = await Promise.all([
    apiFetch('/api/admin/stats'),
    apiFetch('/api/admin/requests')
  ]);
  const s = stats || {};
  const req = recentProjects || [];
  const pendingCount = req.filter(r => r.status === 'pending_review').length;
  document.getElementById('navPendingCount').textContent = pendingCount;

  const completionRate = req.length ? Math.round((s.completed||0)/req.length*100) : 0;
  const winRate = s.bids ? Math.round((s.completed||0)/s.bids*100) : 0;

  setContent(`
    <div class="page-header">
      <div class="page-header-left">
        <div class="page-title">مرحباً، ${me.name || 'مدير'} 👋</div>
        <div class="page-subtitle">نظرة عامة على أداء المنصة اليوم</div>
      </div>
    </div>

    <div class="stats-grid">
      ${statCard('إجمالي المستخدمين', s.users||0, '#7c3aed','var(--violet-100)', userIcon(), 100, 'var(--violet-600)', 'نشط', 'trend-up')}
      ${statCard('مزودو الخدمة', s.providers||0, '#2563eb','var(--blue-100)', providerIcon(), s.users?Math.round((s.providers||0)/s.users*100):0, 'var(--blue-500)', `${s.users?Math.round((s.providers||0)/s.users*100):0}% من المستخدمين`, 'trend-up')}
      ${statCard('إجمالي المشاريع', s.requests||0, '#059669','var(--emerald-100)', projectIcon(), 100, 'var(--emerald-600)', `${completionRate}% معدل إكمال`, 'trend-up')}
      ${statCard('قيد المراجعة', pendingCount, '#d97706','var(--amber-100)', clockIcon(), req.length?Math.round(pendingCount/req.length*100):0, 'var(--amber-500)', 'بانتظار المراجعة', pendingCount?'trend-warn':'trend-neutral')}
      ${statCard('مكتملة', s.completed||0, '#059669','var(--emerald-100)', checkIcon(), completionRate, 'var(--emerald-600)', `${completionRate}% من الكل`, 'trend-up')}
      ${statCard('إجمالي العروض', s.bids||0, '#7c3aed','var(--violet-100)', sendIcon(), 100, 'var(--violet-600)', `${winRate}% نسبة فوز`, 'trend-up')}
    </div>

    <div class="two-col">
      <div class="card">
        <div class="card-header">
          <div class="card-header-left">
            <div class="card-icon" style="background:var(--amber-100)">
              <svg viewBox="0 0 24 24" fill="none" stroke="var(--amber-600)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            </div>
            <div>
              <div class="card-title">قيد المراجعة</div>
              <div class="card-subtitle">تحتاج مراجعتك الآن</div>
            </div>
          </div>
          <button class="btn btn-subtle btn-sm" onclick="navigate('pending',null)">عرض الكل</button>
        </div>
        <div class="card-body" id="homePending">
          <div class="loading-state"><div class="spinner"></div></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-header-left">
            <div class="card-icon" style="background:var(--blue-100)">
              <svg viewBox="0 0 24 24" fill="none" stroke="var(--blue-600)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
            </div>
            <div class="card-title">آخر الأنشطة</div>
          </div>
        </div>
        <div class="card-body" id="homeActivity">
          <div class="loading-state"><div class="spinner"></div></div>
        </div>
      </div>
    </div>
  `);

  // Load pending
  const pending = req.filter(r => r.status === 'pending_review').slice(0, 4);
  const hp = document.getElementById('homePending');
  if (hp) {
    hp.innerHTML = pending.length
      ? pending.map(r => projectCardHtml(r, true)).join('')
      : `<div class="empty-state"><div class="empty-icon"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="empty-title">لا يوجد طلبات معلقة ✅</div><div class="empty-desc">كل الطلبات تمت مراجعتها</div></div>`;
  }

  // Load activity
  const ha = document.getElementById('homeActivity');
  if (ha) {
    const recent = req.slice(0, 9);
    const dotColors = {open:'#059669',in_progress:'#3b82f6',completed:'#7c3aed',pending_review:'#f59e0b',rejected:'#ef4444'};
    ha.innerHTML = recent.length
      ? recent.map(r => `<div class="log-item"><div class="log-dot" style="background:${dotColors[r.status]||'#9ca3af'}"></div><div class="log-body"><div class="log-action">${r.title}</div><div class="log-detail">${r.client_name||'—'} • ${r.city||'—'}</div></div><span class="badge ${STATUS_BADGE[r.status]||''}">${STATUS_LABEL[r.status]||r.status}</span></div>`).join('')
      : `<div class="empty-state"><div class="empty-desc">لا يوجد نشاط</div></div>`;
  }
}

function statCard(label, value, iconColor, iconBg, iconSvg, pct, barColor, trend, trendCls) {
  return `<div class="stat-card">
    <div class="stat-card-header">
      <div class="stat-icon" style="background:${iconBg}">
        <svg viewBox="0 0 24 24" fill="none" stroke="${iconColor}" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">${iconSvg}</svg>
      </div>
      <span class="stat-trend ${trendCls}">${trend}</span>
    </div>
    <div class="stat-value">${value.toLocaleString()}</div>
    <div class="stat-label">${label}</div>
    <div class="stat-bar"><div class="stat-bar-fill" style="width:${Math.min(pct,100)}%;background:${barColor}"></div></div>
  </div>`;
}

/* SVG path shortcuts */
function userIcon(){return`<path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/>`}
function providerIcon(){return`<path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/>`}
function projectIcon(){return`<path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/>`}
function clockIcon(){return`<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>`}
function checkIcon(){return`<polyline points="20 6 9 17 4 12"/>`}
function sendIcon(){return`<line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>`}
function starIcon(){return`<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>`}
function alertIcon(){return`<path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>`}
function editIcon(){return`<path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>`}
function trashIcon(){return`<polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/>`}

/* ════════════════════════════════════════
   PENDING
════════════════════════════════════════ */
async function renderPending() {
  showLoading();
  const data = await apiFetch('/api/admin/requests?status=pending_review');
  const list = data || [];
  document.getElementById('navPendingCount').textContent = list.length;
  setContent(`
    <div class="page-header">
      <div class="page-header-left">
        <div class="page-title">قيد المراجعة</div>
        <div class="page-subtitle">${list.length} مشروع ينتظر مراجعتك</div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <div class="card-header-left">
          <div class="card-icon" style="background:var(--amber-100)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--amber-600)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">${clockIcon()}</svg></div>
          <div><div class="card-title">الطلبات المعلقة</div></div>
        </div>
        <span class="badge badge-pending">${list.length} طلب</span>
      </div>
      <div class="card-body">
        ${list.length
          ? list.map(r => projectCardHtml(r, true)).join('')
          : `<div class="empty-state"><div class="empty-icon"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="empty-title">كل الطلبات تمت مراجعتها ✅</div><div class="empty-desc">لا توجد مشاريع معلقة حالياً</div></div>`}
      </div>
    </div>
  `);
}

/* ════════════════════════════════════════
   ALL PROJECTS
════════════════════════════════════════ */
async function renderProjects() {
  showLoading();
  const data = await apiFetch('/api/admin/requests');
  allRequests = data || [];
  setContent(`
    <div class="page-header">
      <div class="page-header-left">
        <div class="page-title">كل المشاريع</div>
        <div class="page-subtitle">${allRequests.length} مشروع إجمالاً</div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <div class="card-header-left">
          <div class="card-icon" style="background:var(--violet-100)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--violet-600)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">${projectIcon()}</svg></div>
          <div class="card-title">المشاريع</div>
        </div>
        <div class="card-header-right">
          <select class="filter-select" id="fStatus" onchange="filterProjects()">
            <option value="">كل الحالات</option>
            <option value="pending_review">قيد المراجعة</option>
            <option value="open">مفتوح</option>
            <option value="in_progress">قيد التنفيذ</option>
            <option value="completed">مكتمل</option>
            <option value="rejected">مرفوض</option>
          </select>
        </div>
      </div>
      <div class="card-body">
        <div class="filter-bar">
          <div class="search-box">
            <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input type="text" id="fQuery" placeholder="ابحث بالعنوان أو رقم المشروع أو العميل…" oninput="filterProjects()">
          </div>
          <select class="filter-select" id="fCategory" onchange="filterProjects()">
            <option value="">كل التصنيفات</option>
            ${CATEGORIES.map(c=>`<option value="${c}">${c}</option>`).join('')}
          </select>
          <select class="filter-select" id="fCity" onchange="filterProjects()">
            <option value="">كل المدن</option>
            ${CITIES.map(c=>`<option value="${c}">${c}</option>`).join('')}
          </select>
        </div>
        <div id="projectsList">${renderProjectsList(allRequests)}</div>
      </div>
    </div>
  `);
}

function filterProjects() {
  const q = (document.getElementById('fQuery')?.value || '').toLowerCase();
  const st = document.getElementById('fStatus')?.value || '';
  const cat = document.getElementById('fCategory')?.value || '';
  const ci = document.getElementById('fCity')?.value || '';
  const filtered = allRequests.filter(r =>
    (!q || r.title.toLowerCase().includes(q) || (r.client_name||'').toLowerCase().includes(q) || (r.project_number||'').toLowerCase().includes(q)) &&
    (!st || r.status === st) && (!cat || r.category === cat) && (!ci || r.city === ci)
  );
  const el = document.getElementById('projectsList');
  if (el) el.innerHTML = renderProjectsList(filtered);
}

function renderProjectsList(list) {
  if (!list.length) return `<div class="empty-state"><div class="empty-icon"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></div><div class="empty-title">لا يوجد نتائج</div><div class="empty-desc">جرب تعديل فلاتر البحث</div></div>`;
  return list.map(r => projectCardHtml(r)).join('');
}

/* ════════════════════════════════════════
   PROJECT ACTIONS
════════════════════════════════════════ */
async function approveProject(id) {
  await apiFetch(`/api/admin/requests/${id}/review`, {method:'PUT', body:JSON.stringify({status:'open',admin_notes:'تمت الموافقة من المدير'})});
  showToast('تمت الموافقة ونُشر المشروع ✅', 'success');
  addLog('موافقة على مشروع', `#${id}`, '#059669');
  reload();
}

function rejectProject(id) {
  openModal('رفض المشروع',
    `<div class="alert alert-warning"><svg viewBox="0 0 24 24">${alertIcon()}</svg>سيُرسَل إشعار للعميل بسبب الرفض</div>
     <div class="form-group"><label class="form-label">سبب الرفض <span class="form-label-hint">*</span></label><textarea class="form-textarea" id="rejectReason" placeholder="اكتب سبب الرفض بوضوح ليصل للعميل…" style="min-height:100px"></textarea></div>`,
    `<button class="btn btn-ghost" onclick="closeModal()">إلغاء</button>
     <button class="btn btn-danger" onclick="confirmReject(${id})"><svg viewBox="0 0 24 24">${trashIcon()}</svg>تأكيد الرفض</button>`,
    `<svg viewBox="0 0 24 24" stroke="var(--red-500)">${alertIcon()}</svg>`, 'var(--red-100)'
  );
}

async function confirmReject(id) {
  const reason = document.getElementById('rejectReason')?.value?.trim() || 'لا يستوفي شروط النشر';
  await apiFetch(`/api/admin/requests/${id}/review`, {method:'PUT', body:JSON.stringify({status:'rejected',admin_notes:reason})});
  closeModal(); showToast('تم رفض المشروع', 'error');
  addLog('رفض مشروع', `#${id}: ${reason}`, '#ef4444'); reload();
}

async function completeProject(id) {
  if (!confirm('إكمال هذا المشروع؟ سيُشعَر الطرفان.')) return;
  await apiFetch(`/api/admin/requests/${id}/complete`, {method:'PUT'});
  showToast('تم إكمال المشروع ✅', 'success');
  addLog('إكمال مشروع', `#${id}`, '#7c3aed'); reload();
}

async function deleteProject(id) {
  if (!confirm('حذف هذا المشروع نهائياً؟ لا يمكن التراجع.')) return;
  await apiFetch(`/api/admin/requests/${id}`, {method:'DELETE'});
  showToast('تم الحذف', 'error');
  addLog('حذف مشروع', `#${id}`, '#ef4444'); reload();
}

async function manualAssign(reqId) {
  const providers = await apiFetch('/api/admin/providers');
  if (!providers?.length) { showToast('لا يوجد مزودون متاحون', 'error'); return; }
  openModal('إسناد يدوي للمشروع',
    `<div class="alert alert-info"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>سيُسنَد المشروع للمزود المختار ويتغير إلى "قيد التنفيذ"</div>
     <div class="form-group"><label class="form-label">اختر المزود</label>
       <select class="form-select" id="assignProvider">
         ${providers.map(p=>`<option value="${p.id}">${p.name}${p.city?' — '+p.city:''}${p.avg_rating?' ⭐'+Number(p.avg_rating).toFixed(1):''}</option>`).join('')}
       </select>
     </div>
     <div class="form-group"><label class="form-label">ملاحظة <span class="form-label-hint">اختياري</span></label><textarea class="form-textarea" id="assignNote" placeholder="ملاحظة اختيارية…"></textarea></div>`,
    `<button class="btn btn-ghost" onclick="closeModal()">إلغاء</button>
     <button class="btn btn-primary" onclick="confirmAssign(${reqId})"><svg viewBox="0 0 24 24">${providerIcon()}</svg>تأكيد الإسناد</button>`,
    `<svg viewBox="0 0 24 24" stroke="var(--violet-600)">${providerIcon()}</svg>`, 'var(--violet-100)'
  );
}

async function confirmAssign(reqId) {
  const pId = document.getElementById('assignProvider')?.value;
  const note = document.getElementById('assignNote')?.value || 'تم الإسناد يدوياً من المدير';
  await apiFetch(`/api/admin/requests/${reqId}`, {method:'PUT', body:JSON.stringify({assigned_provider_id:pId, status:'in_progress', admin_notes:note})});
  closeModal(); showToast('تم الإسناد ✅', 'success');
  addLog('إسناد يدوي', `المشروع #${reqId}`, '#2563eb'); reload();
}

async function viewProject(id) {
  const [project, bids] = await Promise.all([apiFetch(`/api/requests/${id}`), apiFetch(`/api/requests/${id}/bids`)]);
  const r = project || {}; const b = bids || [];

  const bidsHtml = b.length ? `
    <div class="form-section">العروض المقدمة (${b.length})</div>
    ${b.map(bid => {
      const cls = bid.status==='accepted'?'bid-accepted':bid.status==='rejected'?'bid-rejected':'';
      return `<div class="bid-card ${cls}">
        <div class="bid-header">
          <div class="bid-avatar">${avatarLetter(bid.provider_name)}</div>
          <div style="flex:1">
            <div class="bid-name">${bid.provider_name||'—'}${bid.status==='accepted'?' <span class="badge badge-open" style="font-size:9px">✓ مقبول</span>':bid.status==='rejected'?' <span class="badge badge-rejected" style="font-size:9px">مرفوض</span>':''}</div>
            <div class="bid-sub">📍 ${bid.provider_city||'—'}</div>
            <div class="bid-stars" style="color:var(--amber-400)">${starsHtml(bid.avg_rating||0)}</div>
          </div>
          ${bid.status==='pending'?`<div class="bid-actions">
            <button class="btn btn-success btn-xs" onclick="acceptBid(${bid.id},${id})"><svg viewBox="0 0 24 24">${checkIcon()}</svg>قبول</button>
            <button class="btn btn-danger btn-xs" onclick="rejectBid(${bid.id},${id})"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>رفض</button>
            <button class="btn btn-subtle btn-xs" onclick="editBidModal(${bid.id})"><svg viewBox="0 0 24 24">${editIcon()}</svg></button>
          </div>`:''}
        </div>
        <div class="bid-details">
          <div class="bid-detail"><span>السعر: </span><strong>${Number(bid.price).toLocaleString()} ر.س</strong></div>
          <div class="bid-detail"><span>المدة: </span><strong>${bid.days} يوم</strong></div>
          ${bid.created_at?`<div class="bid-detail"><span>التاريخ: </span><strong>${formatDate(bid.created_at)}</strong></div>`:''}
        </div>
        ${bid.note?`<div class="bid-note">${bid.note}</div>`:''}
      </div>`;
    }).join('')}` : `<div class="empty-state" style="padding:20px"><div class="empty-desc">لم يُقدَّم أي عرض بعد</div></div>`;

  openModal(`تفاصيل المشروع`,
    `<div class="project-banner">
       <div class="banner-number monospace">${r.project_number||'#'+r.id}</div>
       <div class="banner-title">${r.title||'—'}</div>
       <div class="banner-meta">
         <span class="badge ${STATUS_BADGE[r.status]||''}">${STATUS_LABEL[r.status]||r.status}</span>
         <span class="banner-chip">📂 ${r.category||'—'}</span>
         ${r.city?`<span class="banner-chip">📍 ${r.city}</span>`:''}
         ${r.address?`<span class="banner-chip">📌 ${r.address}</span>`:''}
       </div>
     </div>
     <div class="info-block">
       <div class="info-block-title">معلومات المشروع</div>
       <div class="info-row"><span class="info-key">الميزانية القصوى</span><span class="info-val">${formatPrice(r.budget_max)}</span></div>
       <div class="info-row"><span class="info-key">الموعد النهائي</span><span class="info-val">${r.deadline||'غير محدد'}</span></div>
       <div class="info-row"><span class="info-key">عدد العروض</span><span class="info-val">${r.bid_count||0}</span></div>
     </div>
     <div class="info-block">
       <div class="info-block-title">الأطراف</div>
       <div class="info-row"><span class="info-key">العميل</span><span class="info-val">${r.client_name||'—'}${r.client_phone?' — '+r.client_phone:''}</span></div>
       ${r.provider_name?`<div class="info-row"><span class="info-key">المزود</span><span class="info-val" style="color:var(--emerald-600)">🔧 ${r.provider_name}</span></div>`:''}
       ${r.assigned_at?`<div class="info-row"><span class="info-key">تاريخ الإسناد</span><span class="info-val">${formatDate(r.assigned_at)}</span></div>`:''}
     </div>
     ${r.description?`<div class="info-block"><div class="info-block-title">تفاصيل المشروع</div><div style="font-size:12px;line-height:1.8;color:var(--text-secondary)">${r.description}</div></div>`:''}
     ${r.admin_notes?`<div style="background:var(--amber-50);border:1px solid var(--amber-200);border-radius:var(--r-md);padding:12px;margin-bottom:10px"><div style="font-size:9px;font-weight:800;color:var(--amber-600);margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px">ملاحظات المدير</div><div style="font-size:12px;color:var(--text-secondary)">${r.admin_notes}</div></div>`:''}
     ${bidsHtml}`,
    `${r.status==='pending_review'?`<button class="btn btn-success" onclick="closeModal();approveProject(${r.id})"><svg viewBox="0 0 24 24">${checkIcon()}</svg>موافقة</button><button class="btn btn-danger" onclick="closeModal();rejectProject(${r.id})">رفض</button>`:''}
     ${r.status==='in_progress'?`<button class="btn btn-warning" onclick="closeModal();completeProject(${r.id})">إكمال</button>`:''}
     <button class="btn btn-ghost" onclick="closeModal();editProjectModal(${r.id})"><svg viewBox="0 0 24 24">${editIcon()}</svg>تعديل</button>
     <button class="btn btn-ghost" onclick="closeModal()">إغلاق</button>`,
    `<svg viewBox="0 0 24 24" stroke="var(--violet-600)">${projectIcon()}</svg>`, 'var(--violet-100)'
  );
}

async function acceptBid(bidId, reqId) { await apiFetch(`/api/bids/${bidId}/accept`,{method:'PUT'}); showToast('تم قبول العرض ✅','success'); closeModal(); setTimeout(()=>viewProject(reqId),300); }
async function rejectBid(bidId, reqId) { await apiFetch(`/api/bids/${bidId}/reject`,{method:'PUT'}); showToast('تم رفض العرض','error'); closeModal(); setTimeout(()=>viewProject(reqId),300); }

function editBidModal(bidId) {
  openModal('تعديل العرض',
    `<div class="form-row">
       <div class="form-group"><label class="form-label">السعر (ر.س)</label><input type="number" class="form-input" id="editBidPrice" placeholder="السعر الجديد"></div>
       <div class="form-group"><label class="form-label">المدة (أيام)</label><input type="number" class="form-input" id="editBidDays" placeholder="عدد الأيام"></div>
     </div>
     <div class="form-group"><label class="form-label">ملاحظة</label><textarea class="form-textarea" id="editBidNote" placeholder="ملاحظة اختيارية…"></textarea></div>`,
    `<button class="btn btn-ghost" onclick="closeModal()">إلغاء</button>
     <button class="btn btn-primary" onclick="saveEditBid(${bidId})"><svg viewBox="0 0 24 24">${editIcon()}</svg>حفظ</button>`,
    `<svg viewBox="0 0 24 24" stroke="var(--violet-600)">${editIcon()}</svg>`, 'var(--violet-100)'
  );
}
async function saveEditBid(id) {
  const price = document.getElementById('editBidPrice')?.value;
  const days = document.getElementById('editBidDays')?.value;
  const note = document.getElementById('editBidNote')?.value;
  if (!price && !days) { showToast('أدخل السعر أو المدة','error'); return; }
  await apiFetch(`/api/bids/${id}`, {method:'PUT', body:JSON.stringify({price:price||undefined,days:days||undefined,note:note||undefined})});
  closeModal(); showToast('تم التعديل ✅','success');
}

function editProjectModal(id) {
  const r = allRequests.find(x => x.id === id);
  if (!r) { apiFetch(`/api/requests/${id}`).then(r2 => showEditProject(r2)); return; }
  showEditProject(r);
}
function showEditProject(r) {
  uploadedImages['editReq'] = [];
  openModal(`تعديل — ${r.project_number||'#'+r.id}`,
    `<div class="form-section">معلومات المشروع</div>
     <div class="form-group"><label class="form-label">العنوان <span class="form-label-hint">*</span></label><input type="text" class="form-input" id="erTitle" value="${r.title||''}"></div>
     <div class="form-group"><label class="form-label">التفاصيل</label><textarea class="form-textarea" id="erDesc">${r.description||''}</textarea></div>
     <div class="form-row">
       <div class="form-group"><label class="form-label">التصنيف</label><select class="form-select" id="erCat">${CATEGORIES.map(c=>`<option value="${c}" ${r.category===c?'selected':''}>${c}</option>`).join('')}</select></div>
       <div class="form-group"><label class="form-label">المدينة</label><select class="form-select" id="erCity">${cityOptions(r.city)}</select></div>
     </div>
     <div class="form-group"><label class="form-label">العنوان التفصيلي</label><input type="text" class="form-input" id="erAddr" value="${r.address||''}" placeholder="حي، شارع، رقم المبنى…"></div>
     <div class="form-row">
       <div class="form-group"><label class="form-label">الميزانية القصوى (ر.س)</label><input type="number" class="form-input" id="erBudget" value="${r.budget_max||''}"></div>
       <div class="form-group"><label class="form-label">الموعد النهائي</label><input type="date" class="form-input" id="erDeadline" value="${r.deadline||''}"></div>
     </div>
     <div class="form-section">ملاحظات المدير</div>
     <div class="form-group"><textarea class="form-textarea" id="erNotes">${r.admin_notes||''}</textarea></div>
     <div class="form-section">صور المشروع</div>
     ${imageUploadHTML('editReq')}`,
    `<button class="btn btn-ghost" onclick="closeModal()">إلغاء</button>
     <button class="btn btn-primary" onclick="saveEditProject(${r.id})"><svg viewBox="0 0 24 24">${editIcon()}</svg>حفظ التغييرات</button>`,
    `<svg viewBox="0 0 24 24" stroke="var(--violet-600)">${editIcon()}</svg>`, 'var(--violet-100)'
  );
}
async function saveEditProject(id) {
  const body = {
    title: document.getElementById('erTitle')?.value,
    description: document.getElementById('erDesc')?.value,
    category: document.getElementById('erCat')?.value,
    city: document.getElementById('erCity')?.value,
    address: document.getElementById('erAddr')?.value,
    budget_max: document.getElementById('erBudget')?.value || null,
    deadline: document.getElementById('erDeadline')?.value || null,
    admin_notes: document.getElementById('erNotes')?.value
  };
  await apiFetch(`/api/admin/requests/${id}`, {method:'PUT', body:JSON.stringify(body)});
  closeModal(); showToast('تم الحفظ ✅','success');
  addLog('تعديل مشروع',`#${id}`,'#f97316'); reload();
}

function openDisputeModal(reqId) {
  openModal('فتح نزاع',
    `<div class="alert alert-warning"><svg viewBox="0 0 24 24">${alertIcon()}</svg>سيُشعَر العميل والمزود بفتح النزاع</div>
     <div class="form-group"><label class="form-label">عنوان النزاع <span class="form-label-hint">*</span></label><input type="text" class="form-input" id="disTitle" placeholder="وصف مختصر"></div>
     <div class="form-group"><label class="form-label">التفاصيل</label><textarea class="form-textarea" id="disDesc" placeholder="اشرح سبب فتح النزاع…"></textarea></div>`,
    `<button class="btn btn-ghost" onclick="closeModal()">إلغاء</button>
     <button class="btn btn-orange" onclick="confirmOpenDispute(${reqId})"><svg viewBox="0 0 24 24">${alertIcon()}</svg>فتح النزاع</button>`,
    `<svg viewBox="0 0 24 24" stroke="var(--orange-500)">${alertIcon()}</svg>`, 'var(--orange-100)'
  );
}
async function confirmOpenDispute(reqId) {
  const title = document.getElementById('disTitle')?.value?.trim();
  if (!title) { showToast('اكتب عنوان النزاع','error'); return; }
  await apiFetch('/api/admin/disputes', {method:'POST', body:JSON.stringify({request_id:reqId, title, description:document.getElementById('disDesc')?.value})});
  closeModal(); showToast('تم فتح النزاع ✅','success');
  addLog('فتح نزاع',`المشروع #${reqId}`,'#ef4444');
}

/* ════════════════════════════════════════
   PROVIDERS
════════════════════════════════════════ */
async function renderProviders() {
  showLoading();
  const data = await apiFetch('/api/admin/users');
  allUsers = (data || []).filter(u => u.role === 'provider');
  setContent(`
    <div class="page-header">
      <div class="page-header-left">
        <div class="page-title">مزودو الخدمة</div>
        <div class="page-subtitle">${allUsers.length} مزود مسجل</div>
      </div>
      <div class="page-header-right">
        <button class="btn btn-primary" onclick="addUserModal('provider')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>إضافة مزود</button>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <div class="card-header-left">
          <div class="card-icon" style="background:var(--violet-100)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--violet-600)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">${providerIcon()}</svg></div>
          <div class="card-title">المزودون</div>
        </div>
      </div>
      <div class="card-body">
        <div class="filter-bar">
          <div class="search-box">
            <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input type="text" id="pfQ" placeholder="بحث بالاسم أو البريد أو المدينة…" oninput="filterProviders()">
          </div>
          <select class="filter-select" id="pfCat" onchange="filterProviders()">
            <option value="">كل التخصصات</option>
            ${CATEGORIES.map(c=>`<option value="${c}">${c}</option>`).join('')}
          </select>
          <select class="filter-select" id="pfCity" onchange="filterProviders()">
            <option value="">كل المدن</option>
            ${CITIES.map(c=>`<option value="${c}">${c}</option>`).join('')}
          </select>
          <select class="filter-select" id="pfBadge" onchange="filterProviders()">
            <option value="">كل الأوسمة</option>
            <option value="none">بدون وسام</option>
            <option value="verified">موثق</option>
            <option value="star">متميز</option>
            <option value="partner">شريك</option>
            <option value="top">الأفضل</option>
          </select>
          <select class="filter-select" id="pfStatus" onchange="filterProviders()">
            <option value="">كل الحالات</option>
            <option value="1">نشط</option>
            <option value="0">موقوف</option>
          </select>
        </div>
        <div id="providersList">${renderProvidersTable(allUsers)}</div>
      </div>
    </div>
  `);
}

function filterProviders() {
  const q = (document.getElementById('pfQ')?.value||'').toLowerCase();
  const cat = document.getElementById('pfCat')?.value||'';
  const city = document.getElementById('pfCity')?.value||'';
  const badge = document.getElementById('pfBadge')?.value||'';
  const status = document.getElementById('pfStatus')?.value||'';
  const filtered = allUsers.filter(u =>
    (!q || u.name.toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q) || (u.city||'').toLowerCase().includes(q)) &&
    (!cat || (u.specialties||[]).includes(cat)) &&
    (!city || u.city === city) &&
    (!badge || (u.badge||'none') === badge) &&
    (status === '' || (u.is_active?'1':'0') === status)
  );
  const el = document.getElementById('providersList');
  if (el) el.innerHTML = renderProvidersTable(filtered);
}

function renderProvidersTable(list) {
  if (!list.length) return `<div class="empty-state"><div class="empty-icon"><svg viewBox="0 0 24 24">${providerIcon()}</svg></div><div class="empty-title">لا يوجد مزودون</div></div>`;
  return `<div class="table-wrap"><table class="table">
    <thead><tr>
      <th>المزود</th><th>التخصصات</th><th>المدينة</th><th>التقييم</th><th>الوسام</th><th>الحالة</th><th>إجراءات</th>
    </tr></thead>
    <tbody>${list.map(u => {
      const bg = avatarColor(u.id);
      const b = BADGE_MAP[u.badge||'none'] || BADGE_MAP.none;
      const specs = (u.specialties||[]).slice(0,2).join(' · ') + ((u.specialties||[]).length>2?` +${(u.specialties||[]).length-2}`:'') || '—';
      const rating = u.avg_rating ? `<span style="color:var(--amber-400)">${starsHtml(u.avg_rating)}</span> <span class="text-muted">(${u.review_count||0})</span>` : '<span class="text-muted">—</span>';
      return `<tr>
        <td><div style="display:flex;align-items:center;gap:10px">
          <div class="table-avatar" style="background:${bg}">${avatarLetter(u.name)}</div>
          <div>
            <div class="table-name">${u.name}</div>
            <div class="table-meta">${u.email}</div>
            ${u.phone?`<div class="table-meta">${u.phone}</div>`:''}
          </div>
        </div></td>
        <td style="font-size:11px;max-width:160px;color:var(--text-secondary)">${specs}</td>
        <td><span style="font-size:12px;font-weight:600">${u.city||'—'}</span></td>
        <td style="font-size:11px">${rating}</td>
        <td><span class="pb ${b.cls}">${b.icon} ${b.label}</span></td>
        <td><span class="badge ${u.is_active?'badge-active':'badge-inactive'}">${u.is_active?'نشط':'موقوف'}</span></td>
        <td><div class="table-actions">
          <button class="btn btn-subtle btn-xs" onclick="viewUser(${u.id})"><svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
          <button class="btn btn-subtle btn-xs" onclick="editUserModal(${u.id})"><svg viewBox="0 0 24 24">${editIcon()}</svg></button>
          <button class="btn btn-warning btn-xs" onclick="setBadgeModal(${u.id},'${u.name}')"><svg viewBox="0 0 24 24">${starIcon()}</svg></button>
          <button class="btn ${u.is_active?'btn-danger':'btn-success'} btn-xs" onclick="toggleUser(${u.id})">${u.is_active?'إيقاف':'تفعيل'}</button>
          <button class="btn btn-orange btn-xs" onclick="sendWarningModal(${u.id},'${u.name}')"><svg viewBox="0 0 24 24">${alertIcon()}</svg></button>
          <button class="btn btn-subtle btn-xs" onclick="notifyUserModal(${u.id},'${u.name}')"><svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg></button>
          <button class="btn btn-danger btn-xs" onclick="deleteUser(${u.id})"><svg viewBox="0 0 24 24">${trashIcon()}</svg></button>
        </div></td>
      </tr>`;
    }).join('')}</tbody>
  </table></div>`;
}

/* ════════════════════════════════════════
   CLIENTS
════════════════════════════════════════ */
async function renderClients() {
  showLoading();
  const data = await apiFetch('/api/admin/users');
  allUsers = (data||[]).filter(u => u.role === 'client');
  setContent(`
    <div class="page-header">
      <div class="page-header-left">
        <div class="page-title">العملاء</div>
        <div class="page-subtitle">${allUsers.length} عميل مسجل</div>
      </div>
      <div class="page-header-right">
        <button class="btn btn-primary" onclick="addUserModal('client')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>إضافة عميل</button>
      </div>
    </div>
    <div class="card">
      <div class="card-body">
        <div class="filter-bar">
          <div class="search-box">
            <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input type="text" id="cfQ" placeholder="بحث بالاسم أو البريد…" oninput="filterClients()">
          </div>
          <select class="filter-select" id="cfCity" onchange="filterClients()">
            <option value="">كل المدن</option>
            ${CITIES.map(c=>`<option value="${c}">${c}</option>`).join('')}
          </select>
          <select class="filter-select" id="cfStatus" onchange="filterClients()">
            <option value="">كل الحالات</option>
            <option value="1">نشط</option>
            <option value="0">موقوف</option>
          </select>
        </div>
        <div id="clientsList">${renderClientsTable(allUsers)}</div>
      </div>
    </div>
  `);
}

function filterClients() {
  const q = (document.getElementById('cfQ')?.value||'').toLowerCase();
  const city = document.getElementById('cfCity')?.value||'';
  const status = document.getElementById('cfStatus')?.value||'';
  const filtered = allUsers.filter(u =>
    (!q || u.name.toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q)) &&
    (!city || u.city === city) &&
    (status==='' || (u.is_active?'1':'0')===status)
  );
  const el = document.getElementById('clientsList');
  if (el) el.innerHTML = renderClientsTable(filtered);
}

function renderClientsTable(list) {
  if (!list.length) return `<div class="empty-state"><div class="empty-icon"><svg viewBox="0 0 24 24">${userIcon()}</svg></div><div class="empty-title">لا يوجد عملاء</div></div>`;
  return `<div class="table-wrap"><table class="table">
    <thead><tr><th>العميل</th><th>الجوال</th><th>المدينة</th><th>المشاريع</th><th>تاريخ التسجيل</th><th>الحالة</th><th>إجراءات</th></tr></thead>
    <tbody>${list.map(u => {
      const bg = avatarColor(u.id);
      return `<tr>
        <td><div style="display:flex;align-items:center;gap:10px">
          <div class="table-avatar" style="background:${bg}">${avatarLetter(u.name)}</div>
          <div><div class="table-name">${u.name}</div><div class="table-meta">${u.email}</div></div>
        </div></td>
        <td class="text-muted">${u.phone||'—'}</td>
        <td style="font-size:12px;font-weight:600">${u.city||'—'}</td>
        <td><span style="font-size:13px;font-weight:800;color:var(--violet-600)">${u.request_count||0}</span></td>
        <td class="text-muted">${formatDate(u.created_at)}</td>
        <td><span class="badge ${u.is_active?'badge-active':'badge-inactive'}">${u.is_active?'نشط':'موقوف'}</span></td>
        <td><div class="table-actions">
          <button class="btn btn-subtle btn-xs" onclick="viewUser(${u.id})"><svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
          <button class="btn btn-subtle btn-xs" onclick="editUserModal(${u.id})"><svg viewBox="0 0 24 24">${editIcon()}</svg></button>
          <button class="btn ${u.is_active?'btn-danger':'btn-success'} btn-xs" onclick="toggleUser(${u.id})">${u.is_active?'إيقاف':'تفعيل'}</button>
          <button class="btn btn-orange btn-xs" onclick="sendWarningModal(${u.id},'${u.name}')">⚠</button>
          <button class="btn btn-subtle btn-xs" onclick="notifyUserModal(${u.id},'${u.name}')">🔔</button>
          <button class="btn btn-danger btn-xs" onclick="deleteUser(${u.id})"><svg viewBox="0 0 24 24">${trashIcon()}</svg></button>
        </div></td>
      </tr>`;
    }).join('')}</tbody>
  </table></div>`;
}

/* ════════════════════════════════════════
   USER ACTIONS
════════════════════════════════════════ */
function viewUser(id) {
  const u = allUsers.find(x => x.id === id);
  if (!u) return;
  const b = BADGE_MAP[u.badge||'none'] || BADGE_MAP.none;
  const bg = avatarColor(u.id);
  openModal(`ملف — ${u.name}`,
    `<div style="background:var(--gray-900);border-radius:var(--r-lg);padding:16px;margin-bottom:14px;display:flex;align-items:center;gap:12px">
       <div style="width:46px;height:46px;border-radius:var(--r-lg);background:${bg};color:#fff;font-size:18px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0">${avatarLetter(u.name)}</div>
       <div><div style="font-size:15px;font-weight:900;color:#fff;letter-spacing:-.3px">${u.name}</div>
       <div style="font-size:11px;color:rgba(255,255,255,.35);margin-top:2px">${u.email}</div>
       <div style="display:flex;gap:5px;margin-top:7px">
         <span class="badge ${u.is_active?'badge-active':'badge-inactive'}">${u.is_active?'نشط':'موقوف'}</span>
         <span class="pb ${b.cls}">${b.icon} ${b.label}</span>
       </div></div>
     </div>
     <div class="info-block">
       <div class="info-block-title">بيانات الحساب</div>
       <div class="info-row"><span class="info-key">الجوال</span><span class="info-val">${u.phone||'—'}</span></div>
       <div class="info-row"><span class="info-key">المدينة</span><span class="info-val">${u.city||'—'}</span></div>
       <div class="info-row"><span class="info-key">الدور</span><span class="info-val">${u.role==='provider'?'مزود خدمة':u.role==='client'?'عميل':'مدير'}</span></div>
       <div class="info-row"><span class="info-key">تاريخ التسجيل</span><span class="info-val">${formatDate(u.created_at)}</span></div>
     </div>
     ${u.role==='provider'&&(u.specialties||[]).length?`<div class="info-block"><div class="info-block-title">التخصصات</div><div style="display:flex;gap:5px;flex-wrap:wrap;padding-top:4px">${(u.specialties||[]).map(s=>`<span style="background:var(--violet-50);color:var(--violet-700);padding:3px 9px;border-radius:var(--r-full);font-size:10px;font-weight:700;border:1px solid var(--violet-200)">${s}</span>`).join('')}</div></div>`:''}
     ${u.bio?`<div class="info-block"><div class="info-block-title">نبذة</div><div style="font-size:12px;line-height:1.8;color:var(--text-secondary)">${u.bio}</div></div>`:''}`,
    `<button class="btn btn-ghost" onclick="closeModal();editUserModal(${id})"><svg viewBox="0 0 24 24">${editIcon()}</svg>تعديل</button>
     <button class="btn btn-ghost" onclick="closeModal()">إغلاق</button>`,
    `<svg viewBox="0 0 24 24" stroke="var(--violet-600)">${userIcon()}</svg>`, 'var(--violet-100)'
  );
}

function addUserModal(role) {
  const isProv = role === 'provider';
  uploadedImages['newUser'] = [];
  openModal(`إضافة ${isProv?'مزود خدمة':'عميل'}`,
    `<div class="form-section">البيانات الأساسية</div>
     <div class="form-row">
       <div class="form-group"><label class="form-label">الاسم <span class="form-label-hint">*</span></label><input type="text" class="form-input" id="nuName" placeholder="الاسم الكامل"></div>
       <div class="form-group"><label class="form-label">البريد الإلكتروني <span class="form-label-hint">*</span></label><input type="email" class="form-input" id="nuEmail"></div>
     </div>
     <div class="form-row">
       <div class="form-group"><label class="form-label">كلمة المرور <span class="form-label-hint">*</span></label><input type="password" class="form-input" id="nuPass"></div>
       <div class="form-group"><label class="form-label">الجوال</label><input type="text" class="form-input" id="nuPhone" placeholder="05xxxxxxxx"></div>
     </div>
     <div class="form-row">
       <div class="form-group"><label class="form-label">المدينة</label><select class="form-select" id="nuCity">${cityOptions()}</select></div>
       <div class="form-group"><label class="form-label">الدور</label><select class="form-select" id="nuRole" onchange="toggleProviderFields(this.value)"><option value="client" ${!isProv?'selected':''}>عميل</option><option value="provider" ${isProv?'selected':''}>مزود خدمة</option><option value="admin">مدير</option></select></div>
     </div>
     <div id="providerFields" style="${isProv?'':'display:none'}">
       <div class="form-section">بيانات المزود</div>
       <div class="form-group"><label class="form-label">التخصصات</label><div style="margin-top:5px">${specsCheckboxes([])}</div></div>
       <div class="form-group"><label class="form-label">نبذة مختصرة</label><textarea class="form-textarea" id="nuBio" placeholder="نبذة عن خبراتك وأعمالك…"></textarea></div>
       <div class="form-section">صور الأعمال</div>
       ${imageUploadHTML('newUser')}
     </div>`,
    `<button class="btn btn-ghost" onclick="closeModal()">إلغاء</button>
     <button class="btn btn-primary" onclick="saveNewUser()"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>إضافة</button>`,
    `<svg viewBox="0 0 24 24" stroke="var(--emerald-600)"><path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>`, 'var(--emerald-100)'
  );
}
function toggleProviderFields(role) {
  const el = document.getElementById('providerFields');
  if (el) el.style.display = role === 'provider' ? '' : 'none';
}
async function saveNewUser() {
  const name = document.getElementById('nuName')?.value?.trim();
  const email = document.getElementById('nuEmail')?.value?.trim();
  const pass = document.getElementById('nuPass')?.value;
  const role = document.getElementById('nuRole')?.value;
  if (!name||!email||!pass) { showToast('اكمل البيانات المطلوبة','error'); return; }
  const res = await apiFetch('/api/admin/users', {method:'POST', body:JSON.stringify({
    name, email, password:pass,
    phone: document.getElementById('nuPhone')?.value||'',
    city: document.getElementById('nuCity')?.value||'',
    role,
    specialties: role==='provider' ? getSelectedSpecs() : [],
    bio: role==='provider' ? document.getElementById('nuBio')?.value||'' : ''
  })});
  if (res.message && !res.id) { showToast(res.message,'error'); return; }
  closeModal(); showToast('تم الإضافة ✅','success');
  addLog('إضافة مستخدم',`${name} (${role})`,'#059669'); reload();
}

function editUserModal(id) {
  const u = allUsers.find(x => x.id === id);
  if (!u) { showToast('لم يُعثر على المستخدم','error'); return; }
  const isProv = u.role === 'provider';
  uploadedImages['editUser'] = [];
  openModal(`تعديل — ${u.name}`,
    `<div class="form-section">البيانات الأساسية</div>
     <div class="form-row">
       <div class="form-group"><label class="form-label">الاسم</label><input type="text" class="form-input" id="euName" value="${u.name||''}"></div>
       <div class="form-group"><label class="form-label">الجوال</label><input type="text" class="form-input" id="euPhone" value="${u.phone||''}"></div>
     </div>
     <div class="form-row">
       <div class="form-group"><label class="form-label">المدينة</label><select class="form-select" id="euCity">${cityOptions(u.city)}</select></div>
       <div class="form-group"><label class="form-label">الدور</label><select class="form-select" id="euRole" onchange="toggleProviderFields(this.value)"><option value="client" ${u.role==='client'?'selected':''}>عميل</option><option value="provider" ${u.role==='provider'?'selected':''}>مزود خدمة</option><option value="admin" ${u.role==='admin'?'selected':''}>مدير</option></select></div>
     </div>
     <div id="providerFields" style="${isProv?'':'display:none'}">
       <div class="form-section">بيانات المزود</div>
       <div class="form-group"><label class="form-label">التخصصات</label><div style="margin-top:5px">${specsCheckboxes(u.specialties||[])}</div></div>
       <div class="form-group"><label class="form-label">نبذة</label><textarea class="form-textarea" id="euBio">${u.bio||''}</textarea></div>
       <div class="form-section">صور الأعمال</div>${imageUploadHTML('editUser')}
     </div>
     <div class="form-section">الوسام والصلاحية</div>
     <div class="form-row">
       <div class="form-group"><label class="form-label">الوسام</label>
         <select class="form-select" id="euBadge">
           <option value="none" ${(!u.badge||u.badge==='none')?'selected':''}>🚫 بدون وسام</option>
           <option value="verified" ${u.badge==='verified'?'selected':''}>✓ موثق</option>
           <option value="star" ${u.badge==='star'?'selected':''}>⭐ متميز</option>
           <option value="partner" ${u.badge==='partner'?'selected':''}>💎 شريك</option>
           <option value="top" ${u.badge==='top'?'selected':''}>🏆 الأفضل</option>
         </select>
       </div>
       <div class="form-group"><label class="form-label">حالة الحساب</label>
         <select class="form-select" id="euActive">
           <option value="1" ${u.is_active!==false?'selected':''}>✅ نشط</option>
           <option value="0" ${u.is_active===false?'selected':''}>🚫 موقوف</option>
         </select>
       </div>
     </div>`,
    `<button class="btn btn-ghost" onclick="closeModal()">إلغاء</button>
     <button class="btn btn-primary" onclick="saveEditUser(${id})"><svg viewBox="0 0 24 24">${editIcon()}</svg>حفظ التغييرات</button>`,
    `<svg viewBox="0 0 24 24" stroke="var(--violet-600)">${editIcon()}</svg>`, 'var(--violet-100)'
  );
}
async function saveEditUser(id) {
  const u = allUsers.find(x => x.id === id) || {};
  const role = document.getElementById('euRole')?.value;
  const res = await apiFetch(`/api/admin/users/${id}`, {method:'PUT', body:JSON.stringify({
    name: document.getElementById('euName')?.value,
    phone: document.getElementById('euPhone')?.value,
    city: document.getElementById('euCity')?.value,
    role,
    badge: document.getElementById('euBadge')?.value,
    is_active: document.getElementById('euActive')?.value === '1',
    specialties: role==='provider' ? getSelectedSpecs() : (u.specialties||[]),
    bio: document.getElementById('euBio') ? document.getElementById('euBio').value : (u.bio||'')
  })});
  if (res.message && !res.id) { showToast(res.message,'error'); return; }
  closeModal(); showToast('تم الحفظ ✅','success');
  addLog('تعديل مستخدم', u.name||'', '#f97316'); reload();
}

function setBadgeModal(userId, name) {
  openModal(`وسام — ${name}`,
    `<div class="badge-selector">
       <button class="badge-option" onclick="saveBadge(${userId},'none')"><span class="badge-option-icon">🚫</span>بدون وسام</button>
       <button class="badge-option" style="border-color:var(--blue-200);color:var(--blue-600)" onclick="saveBadge(${userId},'verified')"><span class="badge-option-icon">✓</span>موثق</button>
       <button class="badge-option" style="border-color:var(--amber-200);color:var(--amber-600)" onclick="saveBadge(${userId},'star')"><span class="badge-option-icon">⭐</span>متميز</button>
       <button class="badge-option" style="border-color:var(--violet-200);color:var(--violet-700)" onclick="saveBadge(${userId},'partner')"><span class="badge-option-icon">💎</span>شريك</button>
       <button class="badge-option full" style="border-color:var(--emerald-200);color:var(--emerald-700)" onclick="saveBadge(${userId},'top')"><span class="badge-option-icon">🏆</span>الأفضل</button>
     </div>`, '',
    `<svg viewBox="0 0 24 24" stroke="var(--amber-600)">${starIcon()}</svg>`, 'var(--amber-100)'
  );
}
async function saveBadge(userId, badge) {
  await apiFetch(`/api/admin/users/${userId}/badge`, {method:'PUT', body:JSON.stringify({badge})});
  closeModal(); showToast('تم تعيين الوسام ✅','success');
  addLog('وسام', `المستخدم #${userId} — ${badge}`, '#f59e0b'); reload();
}

async function toggleUser(id) {
  const res = await apiFetch(`/api/admin/users/${id}/toggle`, {method:'PUT'});
  showToast(res.is_active ? 'تم التفعيل ✅' : 'تم الإيقاف', 'success');
  addLog(res.is_active?'تفعيل حساب':'إيقاف حساب', `#${id}`, res.is_active?'#059669':'#ef4444'); reload();
}

async function deleteUser(id) {
  if (!confirm('حذف هذا المستخدم نهائياً؟')) return;
  await apiFetch(`/api/admin/users/${id}`, {method:'DELETE'});
  showToast('تم الحذف','error');
  addLog('حذف مستخدم', `#${id}`, '#ef4444'); reload();
}

function sendWarningModal(userId, name) {
  openModal(`تحذير رسمي — ${name}`,
    `<div class="alert alert-warning"><svg viewBox="0 0 24 24">${alertIcon()}</svg>سيُسجَّل هذا التحذير في ملف المستخدم ويُرسَل له إشعار فوري</div>
     <div class="form-group"><label class="form-label">نوع المخالفة <span class="form-label-hint">*</span></label>
       <select class="form-select" id="warnType">
         <option>سلوك غير لائق</option>
         <option>مخالفة شروط الاستخدام</option>
         <option>تأخر في تنفيذ العمل</option>
         <option>معلومات مضللة</option>
         <option>أخرى</option>
       </select>
     </div>
     <div class="form-group"><label class="form-label">تفاصيل إضافية</label><textarea class="form-textarea" id="warnDetail" placeholder="اكتب تفاصيل التحذير…"></textarea></div>`,
    `<button class="btn btn-ghost" onclick="closeModal()">إلغاء</button>
     <button class="btn btn-orange" onclick="sendWarning(${userId})"><svg viewBox="0 0 24 24">${alertIcon()}</svg>إرسال التحذير</button>`,
    `<svg viewBox="0 0 24 24" stroke="var(--orange-500)">${alertIcon()}</svg>`, 'var(--orange-100)'
  );
}
async function sendWarning(userId) {
  const type = document.getElementById('warnType')?.value;
  const detail = document.getElementById('warnDetail')?.value;
  await apiFetch('/api/admin/notify', {method:'POST', body:JSON.stringify({user_id:userId, title:`⚠️ تحذير رسمي: ${type}`, body:detail||type, type:'warning'})});
  closeModal(); showToast('تم إرسال التحذير ✅','success');
  addLog('تحذير رسمي', `المستخدم #${userId} — ${type}`, '#f97316');
}

function notifyUserModal(userId, name) {
  openModal(`إشعار — ${name}`,
    `<div class="form-group"><label class="form-label">العنوان <span class="form-label-hint">*</span></label><input type="text" class="form-input" id="unTitle" placeholder="عنوان الإشعار"></div>
     <div class="form-group"><label class="form-label">النص <span class="form-label-hint">*</span></label><textarea class="form-textarea" id="unBody" placeholder="نص الإشعار…"></textarea></div>`,
    `<button class="btn btn-ghost" onclick="closeModal()">إلغاء</button>
     <button class="btn btn-primary" onclick="sendUserNotif(${userId})"><svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>إرسال</button>`,
    `<svg viewBox="0 0 24 24" stroke="var(--violet-600)"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>`, 'var(--violet-100)'
  );
}
async function sendUserNotif(userId) {
  const title = document.getElementById('unTitle')?.value?.trim();
  const body = document.getElementById('unBody')?.value?.trim();
  if (!title||!body) { showToast('اكمل البيانات','error'); return; }
  await apiFetch('/api/admin/notify', {method:'POST', body:JSON.stringify({user_id:userId, title, body, type:'admin'})});
  closeModal(); showToast('تم الإرسال ✅','success');
}

/* ════════════════════════════════════════
   REVIEWS
════════════════════════════════════════ */
async function renderReviews() {
  showLoading();
  const data = await apiFetch('/api/admin/reviews');
  allReviews = data || [];
  const reported = allReviews.filter(r => r.reported).length;
  const rBadge = document.getElementById('navReportedCount');
  if (rBadge) { rBadge.style.display = reported ? '' : 'none'; if(reported) rBadge.textContent = reported; }

  setContent(`
    <div class="page-header">
      <div class="page-header-left">
        <div class="page-title">إدارة التقييمات</div>
        <div class="page-subtitle">تحكم كامل بتقييمات المنصة</div>
      </div>
      ${reported ? `<div class="page-header-right"><span class="badge badge-reported">${reported} مُبلَّغ عنه</span></div>` : ''}
    </div>
    <div class="card">
      <div class="card-header">
        <div class="card-header-left">
          <div class="card-icon" style="background:var(--amber-100)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--amber-600)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">${starIcon()}</svg></div>
          <div><div class="card-title">التقييمات</div><div class="card-subtitle">${allReviews.length} تقييم إجمالاً</div></div>
        </div>
        <div class="card-header-right">
          <select class="filter-select" id="rvFilter" onchange="filterReviews()">
            <option value="">الكل</option>
            <option value="visible">ظاهرة</option>
            <option value="hidden">مخفية</option>
            <option value="pinned">مثبتة</option>
            <option value="reported">مُبلَّغ عنها</option>
          </select>
          <select class="filter-select" id="rvStars" onchange="filterReviews()">
            <option value="">كل النجوم</option>
            ${[5,4,3,2,1].map(n=>`<option value="${n}">${n} ★</option>`).join('')}
          </select>
        </div>
      </div>
      <div class="card-body">
        <div class="filter-bar">
          <div class="search-box">
            <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input type="text" id="rvSearch" placeholder="بحث باسم المقيِّم أو المقيَّم…" oninput="filterReviews()">
          </div>
        </div>
        <div id="reviewsList">${renderReviewsList(allReviews)}</div>
      </div>
    </div>
  `);
}

function filterReviews() {
  const q = (document.getElementById('rvSearch')?.value||'').toLowerCase();
  const filter = document.getElementById('rvFilter')?.value||'';
  const stars = document.getElementById('rvStars')?.value||'';
  const filtered = allReviews.filter(r =>
    (!q || (r.reviewer_name||'').toLowerCase().includes(q) || (r.reviewed_name||'').toLowerCase().includes(q)) &&
    (!stars || r.rating == stars) &&
    (!filter || filter==='visible' && !r.hidden && !r.pinned ||
      filter==='hidden' && r.hidden || filter==='pinned' && r.pinned || filter==='reported' && r.reported)
  );
  const el = document.getElementById('reviewsList');
  if (el) el.innerHTML = renderReviewsList(filtered);
}

function renderReviewsList(list) {
  if (!list.length) return `<div class="empty-state"><div class="empty-icon"><svg viewBox="0 0 24 24">${starIcon()}</svg></div><div class="empty-title">لا يوجد تقييمات</div></div>`;
  return list.map(r => {
    const bg1 = avatarColor(r.reviewer_id||1);
    const bg2 = avatarColor(r.reviewed_id||2);
    const cls = [r.pinned?'is-pinned':'', r.hidden?'is-hidden':'', r.reported?'is-reported':''].filter(Boolean).join(' ');
    const date = formatDate(r.created_at);
    return `<div class="review-card ${cls}" id="rev_${r.id}">
      <div class="review-header">
        <div>
          <div class="review-parties">
            <div class="review-avatar" style="background:${bg1}">${avatarLetter(r.reviewer_name)}</div>
            <div><div class="review-party-name">${r.reviewer_name||'—'}</div><div class="review-party-role">المقيِّم</div></div>
            <span class="review-arrow">←</span>
            <div class="review-avatar" style="background:${bg2}">${avatarLetter(r.reviewed_name)}</div>
            <div><div class="review-party-name">${r.reviewed_name||'—'}</div><div class="review-party-role">المقيَّم</div></div>
          </div>
          <div style="display:flex;align-items:center;gap:6px;margin-top:6px">
            <div class="review-rating">${[1,2,3,4,5].map(i=>`<span class="${i<=r.rating?'star-on':'star-off'}">★</span>`).join('')}</div>
            <span style="font-size:9px;font-weight:700;color:var(--violet-600);font-variant-numeric:tabular-nums;letter-spacing:.3px;background:var(--violet-50);padding:2px 7px;border-radius:var(--r-full);border:1px solid var(--violet-100)">${r.project_number||'#'+r.request_id}</span>
            ${r.reported ? `<span class="badge badge-reported">مُبلَّغ عنه</span>` : ''}
            ${r.pinned ? `<span class="badge badge-pinned">📌 مثبت</span>` : ''}
            ${r.hidden ? `<span class="badge badge-hidden">🙈 مخفي</span>` : ''}
          </div>
        </div>
        <div class="review-date">${date}</div>
      </div>
      ${r.comment ? `<div class="review-text">${r.comment}</div>` : ''}
      ${r.admin_reply ? `<div class="review-admin-reply"><div class="reply-label">رد الإدارة</div><div class="reply-text">${r.admin_reply}</div></div>` : ''}
      <div class="review-footer">
        <div class="review-flags"></div>
        <div class="review-actions">
          <button class="btn btn-warning btn-xs" onclick="replyReviewModal(${r.id})">${r.admin_reply?'✏️ تعديل الرد':'💬 رد'}</button>
          <button class="btn btn-subtle btn-xs" onclick="togglePinReview(${r.id},${!r.pin
ned})">${r.pinned?'📌 إلغاء التثبيت':'📌 تثبيت'}</button>
          <button class="btn btn-subtle btn-xs" onclick="toggleHideReview(${r.id},${!r.hidden})">${r.hidden?'👁 إظهار':'🙈 إخفاء'}</button>
          ${r.reported?`<button class="btn btn-orange btn-xs" onclick="resolveReport(${r.id})">✓ حل الإبلاغ</button>`:''}
          <button class="btn btn-danger btn-xs" onclick="deleteReview(${r.id})"><svg viewBox="0 0 24 24">${trashIcon()}</svg></button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function replyReviewModal(id) {
  const r = allReviews.find(x => x.id === id);
  openModal('رد على التقييم',
    `${r?.comment ? `<div class="review-text" style="margin-bottom:12px">${r.comment}</div>` : ''}
     <div class="form-group"><label class="form-label">رد الإدارة <span class="form-label-hint">*</span></label>
       <textarea class="form-textarea" id="replyBody" style="min-height:100px" placeholder="اكتب رد الإدارة الذي سيظهر للعموم…">${r?.admin_reply||''}</textarea>
     </div>`,
    `<button class="btn btn-ghost" onclick="closeModal()">إلغاء</button>
     <button class="btn btn-warning" onclick="saveReplyReview(${id})"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>نشر الرد</button>`,
    `<svg viewBox="0 0 24 24" stroke="var(--amber-600)"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>`, 'var(--amber-100)'
  );
}
async function saveReplyReview(id) {
  const reply = document.getElementById('replyBody')?.value?.trim();
  if (!reply) { showToast('اكتب الرد','error'); return; }
  await apiFetch(`/api/admin/reviews/${id}/reply`, {method:'PUT', body:JSON.stringify({reply})});
  closeModal(); showToast('تم نشر الرد ✅','success');
  addLog('رد على تقييم',`#${id}`,'#f59e0b'); renderReviews();
}
async function togglePinReview(id, pin) {
  await apiFetch(`/api/admin/reviews/${id}/pin`, {method:'PUT', body:JSON.stringify({pinned:pin})});
  showToast(pin ? 'تم التثبيت 📌' : 'تم إلغاء التثبيت','success'); renderReviews();
}
async function toggleHideReview(id, hide) {
  await apiFetch(`/api/admin/reviews/${id}/hide`, {method:'PUT', body:JSON.stringify({hidden:hide})});
  showToast(hide ? 'تم الإخفاء 🙈' : 'تم الإظهار 👁','success'); renderReviews();
}
async function resolveReport(id) {
  await apiFetch(`/api/admin/reviews/${id}/resolve`, {method:'PUT'});
  showToast('تم حل الإبلاغ ✅','success');
  addLog('حل إبلاغ',`#${id}`,'#059669'); renderReviews();
}
async function deleteReview(id) {
  if (!confirm('حذف هذا التقييم نهائياً؟')) return;
  await apiFetch(`/api/admin/reviews/${id}`, {method:'DELETE'});
  showToast('تم الحذف','error');
  addLog('حذف تقييم',`#${id}`,'#ef4444'); renderReviews();
}

/* ════════════════════════════════════════
   DISPUTES
════════════════════════════════════════ */
async function renderDisputes() {
  showLoading();
  const data = await apiFetch('/api/admin/disputes');
  allDisputes = data || [];
  const open = allDisputes.filter(d => d.status === 'open').length;
  const navBadge = document.getElementById('navDisputeCount');
  if (navBadge) navBadge.textContent = open;

  setContent(`
    <div class="page-header">
      <div class="page-header-left">
        <div class="page-title">النزاعات</div>
        <div class="page-subtitle">${open} نزاع مفتوح</div>
      </div>
      <div class="page-header-right">
        <select class="filter-select" id="dfStatus" onchange="filterDisputes()">
          <option value="">كل الحالات</option>
          <option value="open">مفتوحة</option>
          <option value="resolved">محلولة</option>
        </select>
      </div>
    </div>
    <div id="disputesList">${renderDisputesList(allDisputes)}</div>
  `);
}

function filterDisputes() {
  const st = document.getElementById('dfStatus')?.value || '';
  const filtered = st ? allDisputes.filter(d => d.status === st) : allDisputes;
  const el = document.getElementById('disputesList');
  if (el) el.innerHTML = renderDisputesList(filtered);
}

function renderDisputesList(list) {
  if (!list.length) return `<div class="card"><div class="card-body"><div class="empty-state"><div class="empty-icon"><svg viewBox="0 0 24 24">${alertIcon()}</svg></div><div class="empty-title">لا يوجد نزاعات ✅</div></div></div></div>`;
  return list.map(d => {
    const bg1 = avatarColor(d.client_id||1);
    const bg2 = avatarColor(d.provider_id||2);
    return `<div class="dispute-card ${d.status}">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:8px;flex-wrap:wrap">
        <div>
          <div class="dispute-title">${d.title}</div>
          <div class="dispute-meta">${d.project_number||'#'+d.request_id} • ${formatDate(d.created_at)}</div>
        </div>
        <span class="badge ${d.status==='open'?'badge-rejected':'badge-open'}">${d.status==='open'?'مفتوح':'محلول'}</span>
      </div>
      ${d.description ? `<div class="dispute-description">${d.description}</div>` : ''}
      <div class="dispute-parties">
        <div class="dispute-party">
          <div class="dispute-party-avatar" style="background:${bg1}">${avatarLetter(d.client_name)}</div>
          <div><div class="dispute-party-name">${d.client_name||'—'}</div><div class="dispute-party-role">العميل</div></div>
        </div>
        <div style="display:flex;align-items:center;padding:0 6px;color:var(--text-tertiary);font-size:18px">⇆</div>
        <div class="dispute-party">
          <div class="dispute-party-avatar" style="background:${bg2}">${avatarLetter(d.provider_name)}</div>
          <div><div class="dispute-party-name">${d.provider_name||'—'}</div><div class="dispute-party-role">المزود</div></div>
        </div>
      </div>
      ${d.resolution ? `<div class="dispute-resolution">✓ القرار: ${d.resolution}</div>` : ''}
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        ${d.status==='open' ? `
          <button class="btn btn-success btn-sm" onclick="resolveDisputeModal(${d.id})"><svg viewBox="0 0 24 24">${checkIcon()}</svg>حل النزاع</button>
          <button class="btn btn-info btn-sm" onclick="notifyBothModal(${d.client_id},${d.provider_id})"><svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>إشعار الطرفين</button>
        ` : ''}
        <button class="btn btn-subtle btn-sm" onclick="viewProject(${d.request_id})"><svg viewBox="0 0 24 24">${projectIcon()}</svg>المشروع</button>
      </div>
    </div>`;
  }).join('');
}

function resolveDisputeModal(id) {
  openModal('حل النزاع',
    `<div class="form-group"><label class="form-label">قرار الحل <span class="form-label-hint">*</span></label>
       <select class="form-select" id="rdSide">
         <option value="client">لصالح العميل</option>
         <option value="provider">لصالح المزود</option>
         <option value="mutual">تسوية مشتركة</option>
       </select>
     </div>
     <div class="form-group"><label class="form-label">تفاصيل القرار</label>
       <textarea class="form-textarea" id="rdResolution" placeholder="اكتب قرار الحل بوضوح…"></textarea>
     </div>`,
    `<button class="btn btn-ghost" onclick="closeModal()">إلغاء</button>
     <button class="btn btn-success" onclick="confirmResolveDispute(${id})"><svg viewBox="0 0 24 24">${checkIcon()}</svg>تأكيد الحل</button>`,
    `<svg viewBox="0 0 24 24" stroke="var(--emerald-600)">${checkIcon()}</svg>`, 'var(--emerald-100)'
  );
}
async function confirmResolveDispute(id) {
  const side = document.getElementById('rdSide')?.value;
  const resolution = document.getElementById('rdResolution')?.value?.trim() || side;
  await apiFetch(`/api/admin/disputes/${id}/resolve`, {method:'PUT', body:JSON.stringify({resolution, decision:side})});
  closeModal(); showToast('تم حل النزاع ✅','success');
  addLog('حل نزاع',`#${id}`,'#059669'); renderDisputes();
}

function notifyBothModal(cId, pId) {
  openModal('إشعار الطرفين',
    `<div class="alert alert-info"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>سيُرسَل الإشعار للعميل والمزود في آنٍ واحد</div>
     <div class="form-group"><label class="form-label">العنوان <span class="form-label-hint">*</span></label><input type="text" class="form-input" id="nbTitle" placeholder="موضوع الإشعار"></div>
     <div class="form-group"><label class="form-label">النص <span class="form-label-hint">*</span></label><textarea class="form-textarea" id="nbBody"></textarea></div>`,
    `<button class="btn btn-ghost" onclick="closeModal()">إلغاء</button>
     <button class="btn btn-primary" onclick="confirmNotifyBoth(${cId},${pId})"><svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>إرسال للطرفين</button>`,
    `<svg viewBox="0 0 24 24" stroke="var(--violet-600)"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/></svg>`, 'var(--violet-100)'
  );
}
async function confirmNotifyBoth(cId, pId) {
  const title = document.getElementById('nbTitle')?.value?.trim();
  const body = document.getElementById('nbBody')?.value?.trim();
  if (!title||!body) { showToast('اكمل البيانات','error'); return; }
  await Promise.all([
    apiFetch('/api/admin/notify', {method:'POST', body:JSON.stringify({user_id:cId, title, body, type:'admin'})}),
    apiFetch('/api/admin/notify', {method:'POST', body:JSON.stringify({user_id:pId, title, body, type:'admin'})})
  ]);
  closeModal(); showToast('تم الإرسال للطرفين ✅','success');
}

/* ════════════════════════════════════════
   NOTIFICATIONS
════════════════════════════════════════ */
function renderNotifications() {
  setContent(`
    <div class="page-header">
      <div class="page-header-left">
        <div class="page-title">إرسال إشعارات</div>
        <div class="page-subtitle">تواصل مع مستخدمي المنصة</div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <div class="card-header-left">
          <div class="card-icon" style="background:var(--violet-100)">
            <svg viewBox="0 0 24 24" fill="none" stroke="var(--violet-600)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
          </div>
          <div><div class="card-title">إشعار جماعي</div><div class="card-subtitle">يصل لكل المستخدمين المحددين فوراً</div></div>
        </div>
      </div>
      <div class="card-body">
        <div class="form-group">
          <label class="form-label">المستهدفون</label>
          <div class="notif-targets">
            <button class="notif-target active" onclick="setNotifTarget(this,'')">👥 الجميع</button>
            <button class="notif-target" onclick="setNotifTarget(this,'provider')">🔧 مزودو الخدمة</button>
            <button class="notif-target" onclick="setNotifTarget(this,'client')">👤 العملاء</button>
          </div>
          <input type="hidden" id="notifRole" value="">
        </div>
        <div class="divider"></div>
        <div class="form-group"><label class="form-label">عنوان الإشعار <span class="form-label-hint">*</span></label><input type="text" class="form-input" id="notifTitle" placeholder="عنوان واضح وجذاب"></div>
        <div class="form-group"><label class="form-label">نص الإشعار <span class="form-label-hint">*</span></label><textarea class="form-textarea" id="notifBody" placeholder="اكتب نص الإشعار هنا…" style="min-height:110px"></textarea></div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-primary" onclick="sendBroadcast()">
            <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
            إرسال
          </button>
          <button class="btn btn-subtle" onclick="document.getElementById('notifTitle').value='';document.getElementById('notifBody').value=''">مسح</button>
        </div>
      </div>
    </div>
  `);
}
function setNotifTarget(btn, role) {
  document.querySelectorAll('.notif-target').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('notifRole').value = role;
}
async function sendBroadcast() {
  const title = document.getElementById('notifTitle')?.value?.trim();
  const body = document.getElementById('notifBody')?.value?.trim();
  const role = document.getElementById('notifRole')?.value;
  if (!title||!body) { showToast('اكمل البيانات','error'); return; }
  await apiFetch('/api/admin/notify', {method:'POST', body:JSON.stringify({title, body, role:role||undefined, type:'admin'})});
  showToast('تم الإرسال بنجاح ✅','success');
  addLog('إشعار جماعي', title + (role ? ` ← ${role==='provider'?'المزودون':'العملاء'}` : ''), '#7c3aed');
  document.getElementById('notifTitle').value = '';
  document.getElementById('notifBody').value = '';
}

/* ════════════════════════════════════════
   REPORTS
════════════════════════════════════════ */
async function renderReports() {
  showLoading();
  const [stats, requests] = await Promise.all([apiFetch('/api/admin/stats'), apiFetch('/api/admin/requests')]);
  const s = stats || {};
  const reqs = requests || [];

  const cityCount = {}, catCount = {};
  reqs.forEach(r => {
    if (r.city) cityCount[r.city] = (cityCount[r.city]||0)+1;
    if (r.category) catCount[r.category] = (catCount[r.category]||0)+1;
  });
  const topCities = Object.entries(cityCount).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const topCats = Object.entries(catCount).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const maxCity = topCities[0]?.[1] || 1;
  const maxCat = topCats[0]?.[1] || 1;
  const completionRate = reqs.length ? Math.round((s.completed||0)/reqs.length*100) : 0;

  setContent(`
    <div class="page-header">
      <div class="page-header-left">
        <div class="page-title">التقارير والإحصائيات</div>
        <div class="page-subtitle">نظرة شاملة على أداء المنصة</div>
      </div>
    </div>

    <div class="stats-grid" style="grid-template-columns:repeat(4,1fr)">
      ${miniStat('معدل الإكمال', completionRate+'%', '#059669', 'var(--emerald-100)')}
      ${miniStat('متوسط العروض', reqs.length ? Math.round((s.bids||0)/reqs.length) : 0, '#7c3aed', 'var(--violet-100)')}
      ${miniStat('مشاريع نشطة', (s.open||0)+(s.in_progress||0), '#2563eb', 'var(--blue-100)')}
      ${miniStat('مرفوضة', s.rejected||0, '#dc2626', 'var(--red-100)')}
    </div>

    <div class="two-col">
      <div class="card">
        <div class="card-header">
          <div class="card-header-left">
            <div class="card-icon" style="background:var(--blue-100)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--blue-600)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></div>
            <div><div class="card-title">أكثر المدن طلباً</div></div>
          </div>
        </div>
        <div class="card-body">
          ${topCities.map(([city, count]) => `
            <div class="progress-row">
              <div class="progress-label">${city}</div>
              <div class="progress-bar"><div class="progress-fill" style="width:${Math.round(count/maxCity*100)}%;background:var(--blue-500)"></div></div>
              <div class="progress-value">${count}</div>
            </div>`).join('')}
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-header-left">
            <div class="card-icon" style="background:var(--violet-100)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--violet-600)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></div>
            <div><div class="card-title">أكثر التصنيفات طلباً</div></div>
          </div>
        </div>
        <div class="card-body">
          ${topCats.map(([cat, count]) => `
            <div class="progress-row">
              <div class="progress-label">${cat}</div>
              <div class="progress-bar"><div class="progress-fill" style="width:${Math.round(count/maxCat*100)}%;background:var(--violet-600)"></div></div>
              <div class="progress-value">${count}</div>
            </div>`).join('')}
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-header-left">
          <div class="card-icon" style="background:var(--emerald-100)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--emerald-600)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div>
          <div><div class="card-title">توزيع حالات المشاريع</div></div>
        </div>
      </div>
      <div class="card-body">
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;text-align:center">
          ${[
            {label:'قيد المراجعة', key:'pending_review', color:'#f59e0b', bg:'var(--amber-50)'},
            {label:'مفتوح', key:'open', color:'#059669', bg:'var(--emerald-50)'},
            {label:'قيد التنفيذ', key:'in_progress', color:'#2563eb', bg:'var(--blue-50)'},
            {label:'مكتمل', key:'completed', color:'#7c3aed', bg:'var(--violet-50)'},
            {label:'مرفوض', key:'rejected', color:'#dc2626', bg:'var(--red-50)'},
          ].map(item => `
            <div style="background:${item.bg};border-radius:var(--r-lg);padding:16px;border:1px solid ${item.bg}">
              <div style="font-size:22px;font-weight:900;color:${item.color};margin-bottom:4px">${s[item.key]||0}</div>
              <div style="font-size:10px;font-weight:600;color:var(--text-secondary)">${item.label}</div>
              <div style="font-size:9px;color:var(--text-tertiary);margin-top:2px">${reqs.length?Math.round((s[item.key]||0)/reqs.length*100):0}%</div>
            </div>`).join('')}
        </div>
      </div>
    </div>
  `);
}

function miniStat(label, value, color, bg) {
  return `<div class="stat-card">
    <div style="font-size:26px;font-weight:900;color:${color};margin-bottom:4px;letter-spacing:-.5px">${value}</div>
    <div class="stat-label">${label}</div>
  </div>`;
}

/* ════════════════════════════════════════
   ACTIVITY LOG
════════════════════════════════════════ */
function renderActivityLog() {
  setContent(`
    <div class="page-header">
      <div class="page-header-left">
        <div class="page-title">سجل النشاط</div>
        <div class="page-subtitle">جميع الإجراءات التي قمت بها في هذه الجلسة</div>
      </div>
      <div class="page-header-right">
        <button class="btn btn-subtle btn-sm" onclick="activityLog=[];renderActivityLog()">مسح السجل</button>
      </div>
    </div>
    <div class="card">
      <div class="card-body">
        ${activityLog.length
          ? activityLog.map(l => `
            <div class="log-item">
              <div class="log-dot" style="background:${l.color}"></div>
              <div class="log-body">
                <div class="log-action">${l.action}</div>
                <div class="log-detail">${l.detail}</div>
              </div>
              <div class="log-time">${l.time}</div>
            </div>`).join('')
          : `<div class="empty-state">
               <div class="empty-icon"><svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div>
               <div class="empty-title">السجل فارغ</div>
               <div class="empty-desc">ستظهر هنا كل الإجراءات التي تتخذها</div>
             </div>`}
      </div>
    </div>
  `);
}

/* ════════════════════════════════════════
   SETTINGS
════════════════════════════════════════ */
function renderSettings() {
  setContent(`
    <div class="page-header">
      <div class="page-header-left">
        <div class="page-title">إعدادات المنصة</div>
        <div class="page-subtitle">تحكم في سلوك وإعدادات منصة مناقصة</div>
      </div>
    </div>

    <div class="two-col">
      <div>
        <div class="card">
          <div class="card-header">
            <div class="card-header-left">
              <div class="card-icon" style="background:var(--violet-100)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--violet-600)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg></div>
              <div class="card-title">إعدادات عامة</div>
            </div>
          </div>
          <div class="card-body">
            ${settingRow('مراجعة المشاريع قبل النشر','كل مشروع يمر بمراجعة المدير قبل ظهوره', true)}
            ${settingRow('التسجيل التلقائي للمزودين','السماح بتسجيل مزودين جدد بدون مراجعة', false)}
            ${settingRow('إشعارات البريد الإلكتروني','إرسال إشعارات للمدير عبر البريد', true)}
            ${settingRow('وضع الصيانة','إيقاف الموقع مؤقتاً للصيانة', false)}
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-header-left">
              <div class="card-icon" style="background:var(--amber-100)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--amber-600)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg></div>
              <div class="card-title">إعدادات المشاريع</div>
            </div>
          </div>
          <div class="card-body">
            <div class="form-group"><label class="form-label">الحد الأدنى للميزانية (ر.س)</label><input type="number" class="form-input" value="100"></div>
            <div class="form-group"><label class="form-label">الحد الأقصى لعدد العروض</label><input type="number" class="form-input" value="20"></div>
            <div class="form-group"><label class="form-label">مدة بقاء المشروع المفتوح (أيام)</label><input type="number" class="form-input" value="30"></div>
            <button class="btn btn-primary btn-sm" onclick="showToast('تم حفظ الإعدادات ✅','success')">
              <svg viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
              حفظ الإعدادات
            </button>
          </div>
        </div>
      </div>

      <div>
        <div class="card">
          <div class="card-header">
            <div class="card-header-left">
              <div class="card-icon" style="background:var(--emerald-100)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--emerald-600)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></div>
              <div class="card-title">الأمان</div>
            </div>
          </div>
          <div class="card-body">
            ${settingRow('التحقق برقم الجوال (OTP)','إلزامي عند التسجيل الجديد', true)}
            ${settingRow('Rate Limiting','حماية API من الطلبات المفرطة', true)}
            ${settingRow('التحقق من البريد الإلكتروني','تأكيد البريد عند التسجيل', false)}
            ${settingRow('تسجيل دخول ذو عاملين','للمدير فقط', false)}
          </div>
        </div>

        <div class="card" style="border-color:var(--red-100)">
          <div class="card-header" style="background:var(--red-50)">
            <div class="card-header-left">
              <div class="card-icon" style="background:var(--red-100)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--red-500)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>
              <div class="card-title" style="color:var(--red-600)">منطقة الخطر</div>
            </div>
          </div>
          <div class="card-body">
            <div class="settings-row">
              <div class="settings-info">
                <div class="settings-title" style="color:var(--red-600)">حذف البيانات التجريبية</div>
                <div class="settings-desc">حذف كل المستخدمين والمشاريع التجريبية</div>
              </div>
              <button class="btn btn-danger btn-sm" onclick="showToast('هذه العملية غير متاحة حالياً','error')">حذف</button>
            </div>
            <div class="settings-row">
              <div class="settings-info">
                <div class="settings-title" style="color:var(--red-600)">إعادة تعيين الإحصائيات</div>
                <div class="settings-desc">مسح جميع الإحصائيات والسجلات</div>
              </div>
              <button class="btn btn-danger btn-sm" onclick="showToast('هذه العملية غير متاحة حالياً','error')">إعادة تعيين</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  `);
}

function settingRow(title, desc, defaultOn) {
  const id = 'tog_' + Math.random().toString(36).slice(2);
  return `<div class="settings-row">
    <label class="toggle-switch" for="${id}">
      <input type="checkbox" id="${id}" ${defaultOn?'checked':''} onchange="showToast('تم الحفظ ✅','success')">
      <div class="toggle-track"><div class="toggle-thumb"></div></div>
    </label>
    <div class="settings-info">
      <div class="settings-title">${title}</div>
      <div class="settings-desc">${desc}</div>
    </div>
  </div>`;
}

/* ════════════════════════════════════════
   OVERLAY CLOSE ON BACKDROP
════════════════════════════════════════ */
document.getElementById('overlay').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

/* ════════════════════════════════════════
   BOOT
════════════════════════════════════════ */
navigate('home', document.querySelector('.nav-item.active'));
</script>
</body>
</html>
