<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ù†Ø§Ù‚ØµØ© â€“ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø²ÙˆØ¯</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Tajawal',sans-serif;background:#f1f5f9;min-height:100vh;display:flex}
.side{width:240px;background:#065f46;min-height:100vh;padding:24px 0;position:fixed;right:0;top:0}
.side-logo{padding:0 20px 24px;border-bottom:1px solid rgba(255,255,255,0.1)}
.side-logo h1{font-size:22px;font-weight:900;color:#fff}
.side-logo h1 span{color:#6ee7b7}
.side-logo p{font-size:11px;color:#a7f3d0;margin-top:3px}
.menu{padding:16px 0}
.menu-item{display:flex;align-items:center;gap:10px;padding:12px 20px;color:#d1fae5;cursor:pointer;transition:.2s;font-size:14px;font-weight:600;border:none;background:none;width:100%;text-align:right;font-family:'Tajawal',sans-serif}
.menu-item:hover{background:rgba(255,255,255,0.08);color:#fff}
.menu-item.on{background:rgba(255,255,255,0.12);color:#fff;border-right:3px solid #6ee7b7}
.ic{font-size:18px;width:24px}
.main{margin-right:240px;flex:1;padding:24px}
.topbar{background:#fff;border-radius:12px;padding:16px 20px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
.topbar h2{font-size:18px;font-weight:800;color:#065f46}
.logout{background:#fee2e2;color:#dc2626;padding:7px 14px;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;border:none;font-family:'Tajawal',sans-serif}
.page{display:none}
.page.on{display:block}
.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:20px}
.stat{background:#fff;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.06);text-align:center}
.stat-ic{font-size:28px;margin-bottom:6px}
.stat-n{font-size:26px;font-weight:900;color:#065f46}
.stat-t{font-size:13px;color:#64748b;margin-top:3px;font-weight:600}
.card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:16px}
.card h3{font-size:16px;font-weight:800;color:#065f46;margin-bottom:16px;padding-bottom:10px;border-bottom:1px solid #f1f5f9}
.req-card{border:1px solid #e2e8f0;border-radius:10px;padding:16px;margin-bottom:12px}
.req-title{font-size:15px;font-weight:800;color:#1e293b;margin-bottom:6px}
.req-meta{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px}
.req-meta span{font-size:12px;color:#64748b}
.btn-bid{background:linear-gradient(135deg,#059669,#065f46);color:#fff;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;border:none;font-family:'Tajawal',sans-serif}
.tag{padding:3px 10px;border-radius:20px;font-size:12px;font-weight:700}
.tag-pending{background:#fef3c7;color:#d97706}
.tag-accepted{background:#dcfce7;color:#16a34a}
.empty{text-align:center;padding:40px;color:#94a3b8;font-size:15px}
.loading{text-align:center;padding:30px;color:#64748b}
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:100;align-items:center;justify-content:center}
.overlay.show{display:flex}
.modal{background:#fff;border-radius:16px;padding:28px;width:100%;max-width:460px}
.modal h3{font-size:17px;font-weight:800;color:#065f46;margin-bottom:18px}
.g{margin-bottom:14px}
.g label{display:block;font-size:14px;font-weight:700;color:#065f46;margin-bottom:5px}
.g input,.g textarea{width:100%;padding:11px 13px;border:1.5px solid #e2e8f0;border-radius:9px;font-family:'Tajawal',sans-serif;font-size:14px;outline:none}
.g input:focus,.g textarea:focus{border-color:#059669}
.g textarea{min-height:80px;resize:vertical}
.modal-btns{display:flex;gap:10px;margin-top:6px}
.btn-submit{flex:1;padding:12px;background:linear-gradient(135deg,#059669,#065f46);color:#fff;border:none;border-radius:9px;font-family:'Tajawal',sans-serif;font-size:15px;font-weight:800;cursor:pointer}
.btn-submit:disabled{opacity:.65;cursor:not-allowed}
.btn-cancel{padding:12px 18px;background:#f1f5f9;color:#64748b;border:none;border-radius:9px;font-family:'Tajawal',sans-serif;font-size:15px;font-weight:700;cursor:pointer}
.msg{padding:10px 14px;border-radius:8px;font-size:14px;font-weight:600;margin-bottom:14px;display:none}
.msg.ok{background:#dcfce7;color:#16a34a;display:block}
.msg.err{background:#fee2e2;color:#dc2626;display:block}
</style>
</head>
<body>

<div class="side">
  <div class="side-logo">
    <h1>Ù…Ù†Ø§Ù‚ØµØ©<span>.</span></h1>
    <p id="userName">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</p>
  </div>
  <div class="menu">
    <button class="menu-item on" onclick="show('home',this)"><span class="ic">ğŸ </span> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button class="menu-item" onclick="show('available',this)"><span class="ic">ğŸ“‹</span> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</button>
    <button class="menu-item" onclick="show('mybids',this)"><span class="ic">ğŸ’°</span> Ø¹Ø±ÙˆØ¶ÙŠ</button>
  </div>
</div>

<div class="main">
  <div class="topbar">
    <h2 id="pageTitle">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
    <button class="logout" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
  </div>

  <!-- Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
  <div class="page on" id="page-home">
    <div class="stats">
      <div class="stat"><div class="stat-ic">ğŸ“‹</div><div class="stat-n" id="s-available">0</div><div class="stat-t">Ø·Ù„Ø¨Ø§Øª Ù…ØªØ§Ø­Ø©</div></div>
      <div class="stat"><div class="stat-ic">ğŸ“¤</div><div class="stat-n" id="s-mybids">0</div><div class="stat-t">Ø¹Ø±ÙˆØ¶ÙŠ</div></div>
      <div class="stat"><div class="stat-ic">âœ…</div><div class="stat-n" id="s-accepted">0</div><div class="stat-t">Ø¹Ø±ÙˆØ¶ Ù…Ù‚Ø¨ÙˆÙ„Ø©</div></div>
    </div>
    <div class="card">
      <h3>Ø¢Ø®Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h3>
      <div id="home-reqs"><div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
    </div>
  </div>

  <!-- Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© -->
  <div class="page" id="page-available">
    <div class="card">
      <h3>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h3>
      <div id="all-reqs"><div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
    </div>
  </div>

  <!-- Ø¹Ø±ÙˆØ¶ÙŠ -->
  <div class="page" id="page-mybids">
    <div class="card">
      <h3>Ø¹Ø±ÙˆØ¶ÙŠ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©</h3>
      <div id="my-bids"><div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
    </div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø¹Ø±Ø¶ -->
<div class="overlay" id="bidOverlay">
  <div class="modal">
    <h3>ğŸ’° ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±Ø¶</h3>
    <div class="msg" id="bid-msg"></div>
    <div class="g"><label>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­ (Ø±.Ø³) *</label><input type="number" id="b-price" placeholder="500"></div>
    <div class="g"><label>Ù…Ø¯Ø© Ø§Ù„ØªÙ†ÙÙŠØ° (Ø£ÙŠØ§Ù…) *</label><input type="number" id="b-days" placeholder="3"></div>
    <div class="g"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="b-note" placeholder="Ø§Ø´Ø±Ø­ Ø¹Ø±Ø¶Ùƒ..."></textarea></div>
    <div class="modal-btns">
      <button class="btn-submit" id="b-btn" onclick="submitBid()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶ ğŸš€</button>
      <button class="btn-cancel" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<script>
var API='https://manaqasati-production.up.railway.app';
var user=JSON.parse(localStorage.getItem('user')||'{}');
if(!user.id){location.href='auth.html';}
document.getElementById('userName').textContent='Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ '+user.name;
var selectedReqId=null;

function show(page,el){
  document.querySelectorAll('.page').forEach(function(p){p.className='page';});
  document.querySelectorAll('.menu-item').forEach(function(m){m.className='menu-item';});
  document.getElementById('page-'+page).className='page on';
  if(el)el.className='menu-item on';
  var titles={home:'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',available:'Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©',mybids:'Ø¹Ø±ÙˆØ¶ÙŠ'};
  document.getElementById('pageTitle').textContent=titles[page]||'';
  if(page==='available')loadAvailable();
  if(page==='mybids')loadMyBids();
  if(page==='home')loadHome();
}

function logout(){localStorage.clear();location.href='auth.html';}

function openBid(reqId){
  selectedReqId=reqId;
  document.getElementById('b-price').value='';
  document.getElementById('b-days').value='';
  document.getElementById('b-note').value='';
  document.getElementById('bid-msg').className='msg';
  document.getElementById('bidOverlay').className='overlay show';
}

function closeModal(){
  document.getElementById('bidOverlay').className='overlay';
}

function loadHome(){
  fetch(API+'/api/requests')
  .then(function(r){return r.json();})
  .then(function(reqs){
    document.getElementById('s-available').textContent=reqs.length;
    if(!reqs.length){document.getElementById('home-reqs').innerHTML='<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯</div>';return;}
    var html='';
    reqs.slice(0,3).forEach(function(r){
      html+='<div class="req-card"><div class="req-title">'+r.title+'</div><div class="req-meta"><span>ğŸ“ '+(r.city||'â€“')+'</span><span>ğŸ—‚ï¸ '+(r.category||'â€“')+'</span><span>ğŸ’° '+(r.budget_max?r.budget_max+' Ø±.Ø³':'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')+'</span></div><button class="btn-bid" onclick="openBid('+r.id+')">ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±Ø¶</button></div>';
    });
    document.getElementById('home-reqs').innerHTML=html;
  }).catch(function(){document.getElementById('home-reqs').innerHTML='<div class="empty">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>';});

  fetch(API+'/api/bids')
  .then(function(r){return r.json();})
  .then(function(bids){
    var mine=bids.filter(function(b){return b.provider_id==user.id;});
    document.getElementById('s-mybids').textContent=mine.length;
    document.getElementById('s-accepted').textContent=mine.filter(function(b){return b.status==='accepted';}).length;
  }).catch(function(){});
}

function loadAvailable(){
  document.getElementById('all-reqs').innerHTML='<div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
  fetch(API+'/api/requests')
  .then(function(r){return r.json();})
  .then(function(reqs){
    if(!reqs.length){document.getElementById('all-reqs').innerHTML='<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯</div>';return;}
    var html='';
    reqs.forEach(function(r){
      html+='<div class="req-card"><div class="req-title">'+r.title+'</div><div class="req-meta"><span>ğŸ“ '+(r.city||'â€“')+'</span><span>ğŸ—‚ï¸ '+(r.category||'â€“')+'</span><span>ğŸ’° '+(r.budget_max?r.budget_max+' Ø±.Ø³':'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')+'</span><span>ğŸ‘¤ '+(r.client_name||'â€“')+'</span></div>'+(r.description?'<p style="font-size:13px;color:#475569;margin-bottom:10px">'+r.description+'</p>':'')+'<button class="btn-bid" onclick="openBid('+r.id+')">ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±Ø¶ ğŸ’°</button></div>';
    });
    document.getElementById('all-reqs').innerHTML=html;
  }).catch(function(){document.getElementById('all-reqs').innerHTML='<div class="empty">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>';});
}

function loadMyBids(){
  document.getElementById('my-bids').innerHTML='<div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
  fetch(API+'/api/bids')
  .then(function(r){return r.json();})
  .then(function(bids){
    var mine=bids.filter(function(b){return b.provider_id==user.id;});
    if(!mine.length){document.getElementById('my-bids').innerHTML='<div class="empty">Ù„Ù… ØªÙ‚Ø¯Ù… Ø£ÙŠ Ø¹Ø±ÙˆØ¶ Ø¨Ø¹Ø¯</div>';return;}
    var html='';
    mine.forEach(function(b){
      var tag=b.status==='accepted'?'<span class="tag tag-accepted">Ù…Ù‚Ø¨ÙˆÙ„</span>':'<span class="tag tag-pending">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span>';
      html+='<div class="req-card"><div class="req-title">Ø·Ù„Ø¨ Ø±Ù‚Ù… #'+b.request_id+'</div><div class="req-meta"><span>ğŸ’° '+b.price+' Ø±.Ø³</span><span>â±ï¸ '+b.days+' Ø£ÙŠØ§Ù…</span>'+tag+'<span>ğŸ“… '+new Date(b.created_at).toLocaleDateString('ar')+'</span></div>'+(b.note?'<p style="font-size:13px;color:#475569;margin-top:6px">'+b.note+'</p>':'')+'</div>';
    });
    document.getElementById('my-bids').innerHTML=html;
  }).catch(function(){document.getElementById('my-bids').innerHTML='<div class="empty">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>';});
}

function submitBid(){
  var price=document.getElementById('b-price').value;
  var days=document.getElementById('b-days').value;
  var note=document.getElementById('b-note').value;
  if(!price||!days){showBidMsg('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ù…Ø¯Ø©','err');return;}
  var btn=document.getElementById('b-btn');
  btn.disabled=true;btn.textContent='Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
  fetch(API+'/api/bids',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({request_id:selectedReqId,provider_id:user.id,price:parseInt(price),days:parseInt(days),note:note})})
  .then(function(r){return r.json().then(function(d){return{ok:r.ok,d:d};});})
  .then(function(r){
    if(r.ok){showBidMsg('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶Ùƒ Ø¨Ù†Ø¬Ø§Ø­!','ok');setTimeout(function(){closeModal();},1500);}
    else{showBidMsg(r.d.message||'Ø­Ø¯Ø« Ø®Ø·Ø£','err');}
    btn.disabled=false;btn.textContent='Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶ ğŸš€';
  }).catch(function(){showBidMsg('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„','err');btn.disabled=false;btn.textContent='Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶ ğŸš€';});
}

function showBidMsg(t,c){var e=document.getElementById('bid-msg');e.textContent=t;e.className='msg '+c;}

loadHome();
</script>
</body>
</html>
