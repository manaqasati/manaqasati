<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø²ÙˆØ¯ â€“ Ù…Ù†Ø§Ù‚ØµØ©</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
<style>
:root{
  --p:#7c3aed;--p2:#6d28d9;--pl:#ede9fe;--pm:#ddd6fe;
  --gold:#f59e0b;--gold2:#d97706;--gl:#fef3c7;
  --text:#111827;--sub:#6b7280;--b2:#e5e7eb;--bg:#f9fafb;--w:#fff;
  --red:#ef4444;--rl:#fee2e2;--gn:#16a34a;--gnl:#dcfce7;
  --blue:#3b82f6;--bl:#dbeafe;--or:#f97316;--ol:#ffedd5;
  --sb:248px;--top:52px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Tajawal',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:14px}
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-thumb{background:#d1d5db;border-radius:4px}

/* â•â•â• SIDEBAR â•â•â• */
.sb{width:var(--sb);background:#111827;position:fixed;top:0;right:0;bottom:0;z-index:200;display:flex;flex-direction:column;transition:transform .25s}
.sb-top{padding:0 14px;height:var(--top);display:flex;align-items:center;gap:9px;border-bottom:1px solid rgba(255,255,255,.06)}
.sb-ic{width:28px;height:28px;border-radius:7px;background:linear-gradient(135deg,#f59e0b,#f97316);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.sb-brand{font-size:15px;font-weight:900;color:#fff}.sb-brand em{color:#f59e0b;font-style:normal}
.sb-user{padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.05)}
.sb-user-top{display:flex;align-items:center;gap:9px;margin-bottom:8px}
.sb-av{width:36px;height:36px;border-radius:9px;background:linear-gradient(135deg,#7c3aed,#a855f7);color:#fff;font-size:14px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;position:relative}
.sb-av-dot{position:absolute;bottom:-2px;left:-2px;width:10px;height:10px;border-radius:50%;border:2px solid #111827}
.sb-nm{font-size:12px;font-weight:700;color:#f3f4f6}
.sb-rl{font-size:10px;color:#6b7280;margin-top:1px}
.sb-avail{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,.04);border-radius:6px;padding:5px 8px}
.sb-avail-lbl{font-size:10px;color:#9ca3af;font-weight:600}
.sb-tog{width:28px;height:15px;border-radius:20px;border:none;cursor:pointer;position:relative;transition:.2s;flex-shrink:0}
.sb-tog::after{content:'';position:absolute;top:2px;width:11px;height:11px;border-radius:50%;background:#fff;transition:.2s}
.sb-tog.on{background:var(--gn)}.sb-tog.on::after{right:2px}
.sb-tog.off{background:#374151}.sb-tog.off::after{right:15px}
.sb-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;padding:8px 14px;border-bottom:1px solid rgba(255,255,255,.05)}
.sb-stat{text-align:center;padding:5px 0}
.sb-stat-val{font-size:13px;font-weight:900;color:#fff}
.sb-stat-lbl{font-size:9px;color:#6b7280;margin-top:1px}
.sb-nav{flex:1;padding:6px 8px;overflow-y:auto;scrollbar-width:none}
.sb-nav::-webkit-scrollbar{display:none}
.sb-grp{font-size:9px;font-weight:700;color:#4b5563;letter-spacing:.8px;padding:10px 8px 4px;text-transform:uppercase}
.sbi{display:flex;align-items:center;gap:8px;padding:7px 9px;border-radius:7px;cursor:pointer;transition:.12s;margin-bottom:1px;border:none;background:transparent;width:100%;font-family:'Tajawal',sans-serif;text-align:right;color:#9ca3af;position:relative}
.sbi:hover{background:rgba(255,255,255,.05);color:#e5e7eb}
.sbi.on{background:rgba(124,58,237,.15);color:#c4b5fd}
.sbi.on::before{content:'';position:absolute;right:0;top:25%;height:50%;width:2px;background:#7c3aed;border-radius:0 2px 2px 0}
.sbi i{width:28px;height:28px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.sbi i svg{width:15px;height:15px;stroke:currentColor;fill:none;stroke-width:1.5}
.sbi-lbl{font-size:12px;font-weight:600;flex:1;text-align:right}
.sbi.on .sbi-lbl{font-weight:700}
.sb-dot{background:#ef4444;color:#fff;font-size:9px;font-weight:800;padding:1px 5px;border-radius:20px;min-width:17px;text-align:center}
.sb-dot-gold{background:var(--gold)}
.sb-bot{padding:8px;border-top:1px solid rgba(255,255,255,.05)}
.sb-ver{text-align:center;font-size:9px;color:#374151;padding:5px 0 0}

/* â•â•â• MAIN â•â•â• */
.main{margin-right:var(--sb);flex:1;display:flex;flex-direction:column;min-height:100vh}
.topbar{background:var(--w);border-bottom:1px solid var(--b2);padding:0 20px;height:var(--top);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.tb-crumb{display:flex;align-items:center;gap:5px;font-size:12px}
.tb-crumb-h{color:var(--sub)}.tb-crumb-s{color:#d1d5db;font-size:10px}.tb-crumb-c{color:var(--text);font-weight:700}
.tb-r{display:flex;align-items:center;gap:6px}
.tb-clk{font-size:11px;font-weight:600;color:var(--sub);background:var(--bg);padding:4px 10px;border-radius:6px;border:1px solid var(--b2)}
.tb-ic{width:32px;height:32px;border-radius:7px;border:1px solid var(--b2);background:var(--w);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.12s;color:var(--sub);position:relative}
.tb-ic:hover{background:var(--bg);color:var(--text)}
.tb-ic svg{width:15px;height:15px;stroke:currentColor;fill:none;stroke-width:1.5}
.tb-notif-dot{position:absolute;top:5px;left:5px;width:6px;height:6px;border-radius:50%;background:var(--red);border:1.5px solid var(--w)}
.content{padding:18px 20px;flex:1}

/* â•â•â• PAGE HEADER â•â•â• */
.pghd{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:10px}
.pghd-t{font-size:16px;font-weight:900}
.pghd-s{font-size:11px;color:var(--sub);margin-top:2px}
.pghd-r{display:flex;gap:7px}

/* â•â•â• STATS â•â•â• */
.sgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;margin-bottom:18px}
.sc{background:var(--w);border:1px solid var(--b2);border-radius:10px;padding:14px;transition:.15s;position:relative;overflow:hidden}
.sc:hover{box-shadow:0 2px 12px rgba(0,0,0,.06)}
.sc-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.sc-ico{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center}
.sc-ico svg{width:16px;height:16px;stroke-width:1.5}
.sc-tr{font-size:9px;font-weight:700;padding:2px 6px;border-radius:20px}
.tup{background:#dcfce7;color:#16a34a}.twn{background:#ffedd5;color:#ea580c}
.sc-val{font-size:22px;font-weight:900;line-height:1;margin-bottom:2px}
.sc-lbl{font-size:11px;color:var(--sub)}
.sc-bar{height:2px;border-radius:2px;margin-top:10px;background:var(--b2);overflow:hidden}
.sc-bf{height:100%;border-radius:2px;transition:width 1.2s ease}

/* â•â•â• CARD â•â•â• */
.card{background:var(--w);border:1px solid var(--b2);border-radius:10px;overflow:hidden;margin-bottom:14px}
.card-hd{padding:12px 16px;border-bottom:1px solid var(--b2);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}
.card-hd-l{display:flex;align-items:center;gap:9px}
.card-hd-ic{width:28px;height:28px;border-radius:7px;display:flex;align-items:center;justify-content:center}
.card-hd-ic svg{width:13px;height:13px;stroke-width:1.5}
.card-title{font-size:13px;font-weight:800}
.card-sub{font-size:10px;color:var(--sub)}
.card-body{padding:14px 16px}

/* â•â•â• TABLE â•â•â• */
.tw{overflow-x:auto}
.tbl{width:100%;border-collapse:collapse;min-width:600px}
.tbl th{text-align:right;padding:8px 12px;color:var(--sub);font-weight:700;font-size:10px;background:var(--bg);border-bottom:1px solid var(--b2);white-space:nowrap}
.tbl td{padding:10px 12px;border-bottom:1px solid var(--b2);vertical-align:middle;font-size:12px}
.tbl tr:last-child td{border-bottom:none}
.tbl tr:hover td{background:#fafafa}

/* â•â•â• TAGS â•â•â• */
.tag{padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700;display:inline-flex;align-items:center;gap:3px;white-space:nowrap;border:1px solid}
.tag::before{content:'';width:4px;height:4px;border-radius:50%;flex-shrink:0}
.t-pend{background:#fefce8;color:#a16207;border-color:#fef08a}.t-pend::before{background:#ca8a04}
.t-open{background:var(--gnl);color:var(--gn);border-color:#bbf7d0}.t-open::before{background:var(--gn)}
.t-prog{background:var(--bl);color:#1d4ed8;border-color:#bfdbfe}.t-prog::before{background:var(--blue)}
.t-done{background:var(--pl);color:var(--p2);border-color:var(--pm)}.t-done::before{background:var(--p)}
.t-rej{background:var(--rl);color:#b91c1c;border-color:#fecaca}.t-rej::before{background:var(--red)}
.t-acc{background:var(--gnl);color:var(--gn);border-color:#bbf7d0}.t-acc::before{background:var(--gn)}
.t-saved{background:var(--gl);color:var(--gold2);border-color:#fcd34d}.t-saved::before{background:var(--gold)}

/* â•â•â• BUTTONS â•â•â• */
.btn{padding:7px 13px;border-radius:7px;font-family:'Tajawal',sans-serif;font-size:12px;font-weight:700;cursor:pointer;border:none;transition:.12s;display:inline-flex;align-items:center;gap:5px;white-space:nowrap}
.btn:active{transform:scale(.97)}
.btn svg{width:13px;height:13px;stroke:currentColor;fill:none;stroke-width:1.8;flex-shrink:0}
.btn-p{background:var(--p);color:#fff}.btn-p:hover{background:var(--p2)}
.btn-g{background:var(--gn);color:#fff}.btn-g:hover{background:#15803d}
.btn-r{background:var(--red);color:#fff}.btn-r:hover{background:#dc2626}
.btn-gold{background:var(--gold);color:#fff}.btn-gold:hover{background:var(--gold2)}
.btn-b{background:var(--blue);color:#fff}.btn-b:hover{background:#2563eb}
.btn-ghost{background:var(--w);color:var(--text);border:1px solid var(--b2)}.btn-ghost:hover{border-color:#9ca3af}
.btn-light{background:var(--bg);color:var(--sub);border:1px solid var(--b2)}.btn-light:hover{color:var(--text)}
.btn-sm{padding:5px 10px;font-size:11px;border-radius:6px}
.btn-xs{padding:3px 7px;font-size:10px;border-radius:5px}
.btn-save{background:var(--gl);color:var(--gold2);border:1px solid #fcd34d}.btn-save:hover{background:#fef08a}
.btn-save.saved{background:var(--gold);color:#fff;border-color:var(--gold)}

/* â•â•â• FILTER â•â•â• */
.fbar{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
.sbox{flex:1;min-width:180px;display:flex;align-items:center;gap:6px;background:var(--bg);border:1px solid var(--b2);border-radius:7px;padding:0 10px;transition:.12s}
.sbox:focus-within{border-color:#9ca3af;background:var(--w)}
.sbox svg{width:13px;height:13px;stroke:var(--sub);fill:none;stroke-width:1.8;flex-shrink:0}
.sbox input{border:none;outline:none;background:transparent;font-family:'Tajawal',sans-serif;font-size:12px;padding:7px 0;flex:1;color:var(--text)}
.fsel{padding:7px 9px;border:1px solid var(--b2);border-radius:7px;font-family:'Tajawal',sans-serif;font-size:12px;font-weight:600;background:var(--w);color:var(--text);outline:none;cursor:pointer}

/* â•â•â• PROJECT CARD â•â•â• */
.pc{background:var(--w);border:1px solid var(--b2);border-radius:10px;padding:14px;margin-bottom:9px;transition:.15s;position:relative;padding-right:18px}
.pc::before{content:'';position:absolute;right:0;top:0;bottom:0;width:3px;border-radius:0 10px 10px 0}
.pc-open::before{background:var(--gn)}.pc-prog::before{background:var(--blue)}.pc-done::before{background:var(--p)}.pc-saved::before{background:var(--gold)}
.pc:hover{box-shadow:0 2px 12px rgba(0,0,0,.06)}
.pc-hd{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:7px}
.pc-num{font-size:9px;font-weight:700;color:var(--sub);font-family:monospace;margin-bottom:2px}
.pc-title{font-size:13px;font-weight:800;line-height:1.3}
.pc-meta{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:9px}
.pm{font-size:10px;color:var(--sub);background:var(--bg);padding:2px 7px;border-radius:20px;display:flex;align-items:center;gap:3px;font-weight:500;border:1px solid var(--b2)}
.pc-desc{font-size:11px;color:#4b5563;line-height:1.7;margin-bottom:9px;padding:8px 10px;background:var(--bg);border-radius:7px;border-right:2px solid var(--pm)}
.pc-acts{display:flex;gap:5px;flex-wrap:wrap;align-items:center}
.pc-new-badge{position:absolute;top:10px;left:10px;background:var(--p);color:#fff;font-size:9px;font-weight:800;padding:2px 6px;border-radius:20px}

/* â•â•â• BID FORM â•â•â• */
.bid-form{background:var(--bg);border:1px solid var(--b2);border-radius:8px;padding:12px;margin-top:10px}
.bid-form-t{font-size:11px;font-weight:800;color:var(--p);margin-bottom:10px}

/* â•â•â• OFFER CARD â•â•â• */
.offer-c{border:1px solid var(--b2);border-radius:9px;padding:12px;margin-bottom:8px;background:var(--w);transition:.12s}
.offer-c:hover{border-color:#d1d5db}
.offer-acc{border-color:#86efac;background:#f0fdf4}
.offer-rej{opacity:.6;border-style:dashed}
.offer-pend{border-color:var(--pm)}
.offer-hd{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:8px}
.offer-proj{font-size:12px;font-weight:800}
.offer-num{font-size:9px;font-weight:700;color:var(--sub);font-family:monospace;margin-bottom:2px}
.offer-info{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:7px}
.offer-ii{background:var(--bg);border-radius:6px;padding:4px 9px;font-size:11px;font-weight:700;border:1px solid var(--b2)}
.offer-ii span{color:var(--sub);font-weight:500;margin-left:2px}
.offer-note{font-size:11px;color:#4b5563;background:var(--bg);padding:7px 9px;border-radius:6px;line-height:1.6;border-right:2px solid var(--pm)}

/* â•â•â• REVIEW CARD â•â•â• */
.rev-c{border:1px solid var(--b2);border-radius:9px;padding:12px;margin-bottom:8px;background:var(--w)}
.rev-hd{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:7px}
.rev-av{width:28px;height:28px;border-radius:7px;color:#fff;font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.rev-nm{font-size:12px;font-weight:700}
.rev-sub{font-size:10px;color:var(--sub)}
.rev-stars{color:#f59e0b;font-size:13px}
.rev-txt{font-size:12px;color:#4b5563;background:var(--bg);padding:9px 11px;border-radius:7px;line-height:1.7;border-right:2px solid var(--pm)}
.rev-reply{font-size:11px;color:var(--p2);background:var(--pl);padding:7px 10px;border-radius:7px;margin-top:6px;border-right:2px solid var(--p)}
.rev-reply-lbl{font-size:9px;font-weight:800;color:var(--p);margin-bottom:2px}

/* â•â•â• PROGRESS TRACKER â•â•â• */
.tracker{display:flex;align-items:center;gap:0;margin:14px 0}
.tracker-step{display:flex;flex-direction:column;align-items:center;flex:1;position:relative}
.tracker-step:not(:last-child)::after{content:'';position:absolute;top:14px;left:-50%;right:50%;height:2px;background:var(--b2);z-index:0}
.tracker-step.done:not(:last-child)::after{background:var(--p)}
.tracker-dot{width:28px;height:28px;border-radius:50%;border:2px solid var(--b2);background:var(--w);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;z-index:1;transition:.2s}
.tracker-step.done .tracker-dot{background:var(--p);border-color:var(--p);color:#fff}
.tracker-step.cur .tracker-dot{background:var(--w);border-color:var(--p);color:var(--p);box-shadow:0 0 0 3px var(--pl)}
.tracker-lbl{font-size:9px;font-weight:600;color:var(--sub);margin-top:5px;text-align:center;white-space:nowrap}
.tracker-step.done .tracker-lbl{color:var(--p);font-weight:700}
.tracker-step.cur .tracker-lbl{color:var(--p2);font-weight:800}

/* â•â•â• WALLET â•â•â• */
.wallet-card{background:#111827;border-radius:10px;padding:18px;margin-bottom:14px;position:relative;overflow:hidden}
.wallet-card::before{content:'';position:absolute;top:-20px;left:-20px;width:120px;height:120px;border-radius:50%;background:rgba(124,58,237,.15)}
.wallet-card::after{content:'';position:absolute;bottom:-30px;right:-10px;width:100px;height:100px;border-radius:50%;background:rgba(245,158,11,.08)}
.wallet-lbl{font-size:10px;font-weight:700;color:rgba(255,255,255,.35);letter-spacing:.8px;text-transform:uppercase;margin-bottom:5px}
.wallet-val{font-size:28px;font-weight:900;color:#fff;margin-bottom:4px}
.wallet-sub{font-size:11px;color:rgba(255,255,255,.35)}
.wallet-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:14px}
.wallet-stat{background:rgba(255,255,255,.06);border-radius:7px;padding:8px 10px}
.wallet-stat-val{font-size:13px;font-weight:800;color:#fff}
.wallet-stat-lbl{font-size:9px;color:rgba(255,255,255,.35);margin-top:1px}

/* â•â•â• NOTIF ITEM â•â•â• */
.notif-item{display:flex;gap:10px;padding:11px 0;border-bottom:1px solid var(--b2);cursor:pointer;transition:.12s}
.notif-item:last-child{border-bottom:none}
.notif-item:hover{background:var(--bg);margin:0 -16px;padding:11px 16px}
.notif-item.unread .notif-body{font-weight:700}
.notif-ic{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:15px}
.notif-title{font-size:12px;font-weight:700;margin-bottom:2px}
.notif-body{font-size:11px;color:var(--sub);line-height:1.5}
.notif-time{font-size:9px;color:var(--sub);margin-top:3px;white-space:nowrap}
.notif-dot{width:6px;height:6px;border-radius:50%;background:var(--p);flex-shrink:0;margin-top:4px}

/* â•â•â• PROFILE â•â•â• */
.profile-banner{background:#111827;border-radius:10px;padding:18px;margin-bottom:14px;display:flex;align-items:center;gap:14px}
.profile-av{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--p),#a855f7);color:#fff;font-size:22px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.profile-nm{font-size:16px;font-weight:900;color:#fff;margin-bottom:3px}
.profile-email{font-size:11px;color:rgba(255,255,255,.35)}
.profile-badges{display:flex;gap:5px;margin-top:7px;flex-wrap:wrap}

/* â•â•â• MODAL â•â•â• */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:500;align-items:center;justify-content:center;backdrop-filter:blur(5px);padding:14px}
.overlay.show{display:flex}
.modal{background:var(--w);border-radius:12px;width:100%;max-width:600px;max-height:92vh;overflow-y:auto;box-shadow:0 16px 50px rgba(0,0,0,.18)}
.modal::-webkit-scrollbar{width:3px}
.modal-hd{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--b2);position:sticky;top:0;background:var(--w);z-index:2;border-radius:12px 12px 0 0}
.modal-hd-l{display:flex;align-items:center;gap:9px}
.modal-hd-ic{width:30px;height:30px;border-radius:7px;display:flex;align-items:center;justify-content:center}
.modal-hd-ic svg{width:14px;height:14px;stroke-width:1.8}
.modal-title{font-size:13px;font-weight:800}
.modal-x{width:28px;height:28px;border-radius:6px;background:var(--bg);border:1px solid var(--b2);cursor:pointer;font-size:17px;color:var(--sub);display:flex;align-items:center;justify-content:center;transition:.12s;line-height:1}
.modal-x:hover{background:var(--rl);border-color:#fca5a5;color:var(--red)}
.modal-body{padding:18px}
.modal-ft{display:flex;gap:7px;justify-content:flex-end;padding:12px 18px;border-top:1px solid var(--b2);background:var(--bg);border-radius:0 0 12px 12px}

/* â•â•â• FORM â•â•â• */
.fg{display:flex;flex-direction:column;gap:4px;margin-bottom:11px}
.fl{font-size:11px;font-weight:700;color:var(--text)}
.fl em{color:var(--sub);font-style:normal;font-weight:500;margin-right:3px}
.fi{padding:8px 10px;border:1px solid var(--b2);border-radius:7px;font-family:'Tajawal',sans-serif;font-size:13px;outline:none;background:var(--w);color:var(--text);transition:.12s;width:100%}
.fi:focus{border-color:#9ca3af;box-shadow:0 0 0 2px rgba(124,58,237,.07)}
.fsel2{padding:8px 10px;border:1px solid var(--b2);border-radius:7px;font-family:'Tajawal',sans-serif;font-size:13px;outline:none;background:var(--w);cursor:pointer;transition:.12s;width:100%}
.fsel2:focus{border-color:#9ca3af}
.fta{padding:8px 10px;border:1px solid var(--b2);border-radius:7px;font-family:'Tajawal',sans-serif;font-size:13px;outline:none;resize:vertical;min-height:80px;transition:.12s;width:100%}
.fta:focus{border-color:#9ca3af;box-shadow:0 0 0 2px rgba(124,58,237,.07)}
.f2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.fsec{font-size:10px;font-weight:800;color:var(--p);padding:9px 0 5px;border-bottom:1px solid var(--pm);margin:3px 0 10px;letter-spacing:.3px;text-transform:uppercase}

/* â•â•â• SPECS â•â•â• */
.specs-box{border:1px solid var(--b2);border-radius:8px;background:var(--bg)}
.specs-hd{padding:7px 11px;border-bottom:1px solid var(--b2);display:flex;align-items:center;justify-content:space-between}
.specs-cnt{font-size:10px;font-weight:700;color:var(--p);background:var(--pl);padding:2px 7px;border-radius:20px}
.specs-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;padding:9px;max-height:185px;overflow-y:auto}
.spec-it{display:flex;align-items:center;gap:5px;padding:5px 8px;border:1px solid var(--b2);border-radius:6px;cursor:pointer;transition:.1s;background:var(--w)}
.spec-it:hover{border-color:#9ca3af}
.spec-it.on{border-color:var(--p);background:var(--pl)}
.spec-it input{width:12px;height:12px;accent-color:var(--p);cursor:pointer;flex-shrink:0}
.spec-it label{font-size:11px;font-weight:600;cursor:pointer}
.spec-it.on label{color:var(--p2);font-weight:700}

/* â•â•â• IMG UPLOAD â•â•â• */
.img-up{border:1.5px dashed var(--b2);border-radius:8px;padding:18px;text-align:center;cursor:pointer;transition:.15s;background:var(--bg);position:relative}
.img-up:hover{border-color:var(--p);background:var(--pl)}
.img-up input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.img-up-ic{width:36px;height:36px;border-radius:9px;background:var(--pl);display:flex;align-items:center;justify-content:center;margin:0 auto 7px}
.img-up-ic svg{width:17px;height:17px;stroke:var(--p);fill:none;stroke-width:1.8}
.img-up-t{font-size:12px;font-weight:700;margin-bottom:2px}
.img-up-s{font-size:10px;color:var(--sub)}
.imgs-prev{display:flex;gap:6px;flex-wrap:wrap;margin-top:9px}
.img-p{position:relative;width:68px;height:68px;border-radius:7px;overflow:hidden;border:1px solid var(--b2)}
.img-p img{width:100%;height:100%;object-fit:cover}
.img-p-del{position:absolute;top:3px;left:3px;width:15px;height:15px;border-radius:50%;background:var(--red);color:#fff;border:none;cursor:pointer;font-size:9px;display:flex;align-items:center;justify-content:center;font-weight:900}

/* â•â•â• INFO ROWS â•â•â• */
.ib{background:var(--bg);border-radius:8px;padding:11px;margin-bottom:9px}
.ib-t{font-size:9px;font-weight:800;color:var(--sub);text-transform:uppercase;letter-spacing:.7px;margin-bottom:7px}
.ir{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--b2)}
.ir:last-child{border-bottom:none}
.ir-k{font-size:11px;color:var(--sub)}
.ir-v{font-size:11px;font-weight:700}

/* â•â•â• TOAST â•â•â• */
.toast{position:fixed;bottom:22px;left:50%;transform:translateX(-50%) translateY(12px);background:#111827;color:#fff;padding:9px 18px;border-radius:9px;font-size:12px;font-weight:600;z-index:999;opacity:0;transition:.22s;pointer-events:none;display:flex;align-items:center;gap:7px}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* â•â•â• LOADING/EMPTY â•â•â• */
.loading{text-align:center;padding:38px;color:var(--sub)}
.spin{width:28px;height:28px;border:2px solid var(--pm);border-top-color:var(--p);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 9px}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:38px 18px}
.empty-ic{width:46px;height:46px;border-radius:10px;background:var(--bg);border:1.5px dashed var(--b2);display:flex;align-items:center;justify-content:center;margin:0 auto 9px}
.empty-ic svg{width:20px;height:20px;stroke:var(--b2);fill:none;stroke-width:1.5}
.empty h4{font-size:12px;font-weight:700;margin-bottom:3px}
.empty p{font-size:11px;color:var(--sub)}

/* â•â•â• MOBILE â•â•â• */
.mob-btn{display:none;position:fixed;top:10px;left:10px;z-index:300;width:34px;height:34px;border-radius:8px;background:var(--p);border:none;cursor:pointer;align-items:center;justify-content:center}
.mob-btn svg{width:16px;height:16px;stroke:#fff;fill:none;stroke-width:2}
.mob-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:190}
@media(max-width:900px){
  .sb{transform:translateX(110%)}.sb.open{transform:translateX(0)}
  .main{margin-right:0}.mob-btn{display:flex}.mob-ov.show{display:block}
  .sgrid{grid-template-columns:repeat(2,1fr)}.content{padding:12px 14px}
  .topbar{padding:0 12px}.f2{grid-template-columns:1fr}
  .specs-grid{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
<button class="mob-btn" onclick="toggleSb()">
  <svg viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
</button>
<div class="mob-ov" id="mobOv" onclick="toggleSb()"></div>

<nav class="sb" id="sb">
  <div class="sb-top">
    <div class="sb-ic">âš¡</div>
    <div class="sb-brand">Ù…Ù†Ø§Ù‚ØµØ©<em>.</em></div>
  </div>
  <div class="sb-user">
    <div class="sb-user-top">
      <div class="sb-av" id="sb-av">
        Ù…
        <div class="sb-av-dot" id="avail-dot" style="background:#22c55e"></div>
      </div>
      <div>
        <div class="sb-nm" id="sb-name">Ø§Ù„Ù…Ø²ÙˆØ¯</div>
        <div class="sb-rl" id="sb-city">Ù…Ø²ÙˆØ¯ Ø®Ø¯Ù…Ø©</div>
      </div>
    </div>
    <div class="sb-avail">
      <span class="sb-avail-lbl" id="avail-lbl">ğŸŸ¢ Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù†</span>
      <button class="sb-tog on" id="avail-tog" onclick="toggleAvail()"></button>
    </div>
  </div>
  <div class="sb-stats">
    <div class="sb-stat"><div class="sb-stat-val" id="sb-rating">â€”</div><div class="sb-stat-lbl">ØªÙ‚ÙŠÙŠÙ…ÙŠ</div></div>
    <div class="sb-stat"><div class="sb-stat-val" id="sb-done">0</div><div class="sb-stat-lbl">Ù…ÙƒØªÙ…Ù„</div></div>
    <div class="sb-stat"><div class="sb-stat-val" id="sb-win">â€”</div><div class="sb-stat-lbl">Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ²</div></div>
  </div>
  <div class="sb-nav">
    <div class="sb-grp">Ø¹Ø§Ù…</div>
    <button class="sbi on" onclick="go('home',this)">
      <i data-lucide="layout-dashboard"></i><span class="sbi-lbl">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
    </button>
    <div class="sb-grp">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</div>
    <button class="sbi" onclick="go('browse',this)">
      <i data-lucide="search"></i><span class="sbi-lbl">ØªØµÙØ­ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</span>
    </button>
    <button class="sbi" onclick="go('saved',this)">
      <i data-lucide="bookmark"></i><span class="sbi-lbl">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡ØªÙ…</span>
      <span class="sb-dot sb-dot-gold" id="sb-saved-cnt" style="display:none">0</span>
    </button>
    <button class="sbi" onclick="go('mybids',this)">
      <i data-lucide="send"></i><span class="sbi-lbl">Ø¹Ø±ÙˆØ¶ÙŠ</span>
      <span class="sb-dot" id="sb-bids-cnt">0</span>
    </button>
    <button class="sbi" onclick="go('active',this)">
      <i data-lucide="zap"></i><span class="sbi-lbl">Ù…Ø´Ø§Ø±ÙŠØ¹ÙŠ Ø§Ù„Ù†Ø´Ø·Ø©</span>
    </button>
    <button class="sbi" onclick="go('history',this)">
      <i data-lucide="archive"></i><span class="sbi-lbl">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…Ù„</span>
    </button>
    <div class="sb-grp">Ø§Ù„ØªÙØ§Ø¹Ù„</div>
    <button class="sbi" onclick="go('reviews',this)">
      <i data-lucide="star"></i><span class="sbi-lbl">ØªÙ‚ÙŠÙŠÙ…Ø§ØªÙŠ</span>
    </button>
    <button class="sbi" onclick="go('notifs',this)">
      <i data-lucide="bell"></i><span class="sbi-lbl">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span>
      <span class="sb-dot" id="sb-notif-cnt" style="display:none">0</span>
    </button>
    <div class="sb-grp">Ø§Ù„Ø­Ø³Ø§Ø¨</div>
    <button class="sbi" onclick="go('wallet',this)">
      <i data-lucide="credit-card"></i><span class="sbi-lbl">Ø§Ù„Ù…Ø­ÙØ¸Ø©</span>
    </button>
    <button class="sbi" onclick="go('profile',this)">
      <i data-lucide="user-circle"></i><span class="sbi-lbl">Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</span>
    </button>
  </div>
  <div class="sb-bot">
    <button class="sbi" onclick="logout()" style="width:100%">
      <i data-lucide="log-out"></i><span class="sbi-lbl">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
    </button>
    <div class="sb-ver">Ù…Ù†Ø§Ù‚ØµØ© Provider v3.0</div>
  </div>
</nav>

<div class="main">
  <div class="topbar">
    <div class="tb-crumb">
      <span class="tb-crumb-h">Ù…Ù†Ø§Ù‚ØµØ©</span>
      <span class="tb-crumb-s">â€º</span>
      <span class="tb-crumb-c" id="pg-title">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
    </div>
    <div class="tb-r">
      <div class="tb-clk" id="clock">--:--:--</div>
      <button class="tb-ic" onclick="go('notifs',null)">
        <svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
        <div class="tb-notif-dot" id="notif-dot" style="display:none"></div>
      </button>
    </div>
  </div>
  <div class="content" id="content">
    <div class="loading"><div class="spin"></div></div>
  </div>
</div>

<div class="overlay" id="overlay">
  <div class="modal">
    <div class="modal-hd">
      <div class="modal-hd-l">
        <div class="modal-hd-ic" id="m-ic"></div>
        <div class="modal-title" id="m-title">-</div>
      </div>
      <button class="modal-x" onclick="closeM()">Ã—</button>
    </div>
    <div class="modal-body" id="m-body"></div>
    <div class="modal-ft" id="m-ft"></div>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
var API='https://manaqasati-production.up.railway.app';
var token=localStorage.getItem('token');
var me=JSON.parse(localStorage.getItem('user')||'{}');
var curPage='home';
var savedIds=JSON.parse(localStorage.getItem('saved_ids')||'[]');
var allReqs=[],myBids=[],myNotifs=[];
var imgData={};
var isAvail=true;

if(!token||me.role!=='provider'){window.location.href='auth.html';}

/* â”€â”€ INIT â”€â”€ */
document.getElementById('sb-name').textContent=me.name||'Ø§Ù„Ù…Ø²ÙˆØ¯';
document.getElementById('sb-av').textContent=(me.name||'Ù…').charAt(0);
if(me.city)document.getElementById('sb-city').textContent='ğŸ“ '+me.city;
setInterval(function(){document.getElementById('clock').textContent=new Date().toLocaleTimeString('ar-SA');},1000);

/* â”€â”€ CONSTANTS â”€â”€ */
var CATS=['ØªØ¨Ø±ÙŠØ¯ ÙˆØªÙƒÙŠÙŠÙ','ÙƒÙ‡Ø±Ø¨Ø§Ø¡','Ø³Ø¨Ø§ÙƒØ©','Ù†Ø¬Ø§Ø±Ø©','ØªÙ†Ø¸ÙŠÙ','Ù†Ù‚Ù„ Ø¹ÙØ´','Ø­Ø¯Ø§Ø¯Ø©','Ø£Ù„Ù…Ù†ÙŠÙˆÙ…','Ù…Ø³Ø§Ø¨Ø­','ÙƒØ§Ù…ÙŠØ±Ø§Øª Ù…Ø±Ø§Ù‚Ø¨Ø©','Ø´Ø¨ÙƒØ§Øª ÙˆØ¥Ù†ØªØ±Ù†Øª','Ù…Ø¸Ù„Ø§Øª ÙˆØ³ÙˆØ§ØªØ±','Ø¹Ø²Ù„ Ø­Ø±Ø§Ø±ÙŠ','Ø£Ø¨ÙˆØ§Ø¨','Ø¬Ø¨Ø³ ÙˆØ·Ø¨Ø§Ø´ÙŠØ±','Ù…ÙƒØ§ÙØ­Ø© Ø­Ø´Ø±Ø§Øª','Ø£Ø®Ø±Ù‰'];
var CITIES=['Ø§Ù„Ø±ÙŠØ§Ø¶','Ø¬Ø¯Ø©','Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©','Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©','Ø§Ù„Ø¯Ù…Ø§Ù…','Ø§Ù„Ø®Ø¨Ø±','Ø§Ù„Ø¸Ù‡Ø±Ø§Ù†','Ø§Ù„Ø£Ø­Ø³Ø§Ø¡','Ø§Ù„Ø·Ø§Ø¦Ù','ØªØ¨ÙˆÙƒ','Ø¨Ø±ÙŠØ¯Ø©','Ø®Ù…ÙŠØ³ Ù…Ø´ÙŠØ·','Ø£Ø¨Ù‡Ø§','Ù†Ø¬Ø±Ø§Ù†','Ø¬ÙŠØ²Ø§Ù†','Ø­Ø§Ø¦Ù„','ÙŠÙ†Ø¨Ø¹','Ø§Ù„Ø¬Ø¨ÙŠÙ„','Ø§Ù„Ù‚Ø·ÙŠÙ','Ø³ÙƒØ§ÙƒØ§','Ø¹Ø±Ø¹Ø±','Ø§Ù„Ø¨Ø§Ø­Ø©','Ø§Ù„Ø±Ø³','Ø±Ø§Ø¨Øº','Ø¨ÙŠØ´Ø©','ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¯ÙˆØ§Ø³Ø±','Ø§Ù„Ø²Ù„ÙÙŠ','Ø§Ù„Ù‚Ø±ÙŠØ§Øª'];
var COLORS=['#7c3aed','#2563eb','#16a34a','#d97706','#dc2626','#0891b2','#7e22ce','#9d174d'];
var SL={pending_review:'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',open:'Ù…ÙØªÙˆØ­',in_progress:'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°',completed:'Ù…ÙƒØªÙ…Ù„',rejected:'Ù…Ø±ÙÙˆØ¶'};
var ST={pending_review:'t-pend',open:'t-open',in_progress:'t-prog',completed:'t-done',rejected:'t-rej'};

/* â”€â”€ HELPERS â”€â”€ */
function api(p,o){return fetch(API+p,Object.assign({headers:{'Authorization':'Bearer '+token,'Content-Type':'application/json'}},o)).then(function(r){return r.json();}).catch(function(){return{};});}
function toast(msg,type){
  var t=document.getElementById('toast');
  t.innerHTML='<span>'+(type==='success'?'âœ“':type==='error'?'âœ•':'â„¹')+'</span> '+msg;
  t.style.background=type==='error'?'#dc2626':type==='success'?'#16a34a':'#111827';
  t.className='toast show';setTimeout(function(){t.className='toast';},3000);
}
function closeM(){document.getElementById('overlay').className='overlay';}
function openM(title,body,ft,icSvg,icBg){
  document.getElementById('m-title').textContent=title;
  document.getElementById('m-body').innerHTML=body;
  document.getElementById('m-ft').innerHTML=ft||'';
  var ic=document.getElementById('m-ic');
  ic.innerHTML=icSvg||'';ic.style.background=icBg||'var(--pl)';
  document.getElementById('overlay').className='overlay show';
}
function toggleSb(){document.getElementById('sb').classList.toggle('open');document.getElementById('mobOv').classList.toggle('show');}
function logout(){localStorage.clear();window.location.href='auth.html';}
function go(page,btn){
  curPage=page;
  document.querySelectorAll('.sbi').forEach(function(i){i.classList.remove('on');});
  if(btn)btn.classList.add('on');
  var T={home:'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',browse:'ØªØµÙØ­ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹',saved:'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡ØªÙ…',mybids:'Ø¹Ø±ÙˆØ¶ÙŠ',active:'Ù…Ø´Ø§Ø±ÙŠØ¹ÙŠ Ø§Ù„Ù†Ø´Ø·Ø©',history:'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…Ù„',reviews:'ØªÙ‚ÙŠÙŠÙ…Ø§ØªÙŠ',notifs:'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª',wallet:'Ø§Ù„Ù…Ø­ÙØ¸Ø©',profile:'Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ'};
  document.getElementById('pg-title').textContent=T[page]||page;
  var P={home:pgHome,browse:pgBrowse,saved:pgSaved,mybids:pgMyBids,active:pgActive,history:pgHistory,reviews:pgReviews,notifs:pgNotifs,wallet:pgWallet,profile:pgProfile};
  if(P[page])P[page]();
  document.getElementById('sb').classList.remove('open');document.getElementById('mobOv').classList.remove('show');
}

function cityOpts(sel){return'<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>'+CITIES.map(function(c){return'<option value="'+c+'" '+(sel===c?'selected':'')+'>'+c+'</option>';}).join('');}
function specsHTML(sel){return'<div class="specs-box"><div class="specs-hd"><span style="font-size:11px;font-weight:700">Ø§Ù„ØªØ®ØµØµØ§Øª</span><span class="specs-cnt" id="spCnt">'+(sel?sel.length:0)+' Ù…Ø­Ø¯Ø¯</span></div><div class="specs-grid">'+CATS.map(function(c,i){var on=sel&&sel.includes(c);return'<div class="spec-it '+(on?'on':'')+'" onclick="togSpec(this)"><input type="checkbox" id="sp'+i+'" value="'+c+'" '+(on?'checked':'')+' onchange="updSpCnt()"><label for="sp'+i+'">'+c+'</label></div>';}).join('')+'</div></div>';}
function togSpec(el){el.classList.toggle('on');el.querySelector('input').checked=el.classList.contains('on');updSpCnt();}
function updSpCnt(){var c=document.querySelectorAll('.spec-it.on').length;var el=document.getElementById('spCnt');if(el)el.textContent=c+' Ù…Ø­Ø¯Ø¯';}
function getSpecs(){return Array.from(document.querySelectorAll('.spec-it.on input')).map(function(i){return i.value;});}
function imgUpHTML(id){return'<div class="img-up"><input type="file" accept="image/*" multiple onchange="handleImgs(this,\''+id+'\')"><div class="img-up-ic"><svg viewBox="0 0 24 24" fill="none" stroke-width="1.8"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></div><div class="img-up-t">Ø§Ø³Ø­Ø¨ Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø±ÙØ¹</div><div class="img-up-s">PNG, JPG â€” 5 ØµÙˆØ± ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰</div></div><div class="imgs-prev" id="ip-'+id+'"></div>';}
function handleImgs(input,id){var files=Array.from(input.files);if(!imgData[id])imgData[id]=[];files.forEach(function(f){if(imgData[id].length>=5)return;var r=new FileReader();r.onload=function(e){imgData[id].push(e.target.result);renderImgPrev(id);};r.readAsDataURL(f);});}
function renderImgPrev(id){var el=document.getElementById('ip-'+id);if(!el)return;el.innerHTML=(imgData[id]||[]).map(function(d,i){return'<div class="img-p"><img src="'+d+'"><button class="img-p-del" onclick="delImg(\''+id+'\','+i+')">Ã—</button></div>';}).join('');}
function delImg(id,i){imgData[id].splice(i,1);renderImgPrev(id);}
function starsHTML(n){var s='';for(var i=1;i<=5;i++)s+='<span style="color:'+(i<=n?'#f59e0b':'#e5e7eb')+'">â˜…</span>';return s;}

/* â”€â”€ AVAILABILITY â”€â”€ */
function toggleAvail(){
  isAvail=!isAvail;
  var tog=document.getElementById('avail-tog');
  var dot=document.getElementById('avail-dot');
  var lbl=document.getElementById('avail-lbl');
  tog.className='sb-tog '+(isAvail?'on':'off');
  dot.style.background=isAvail?'#22c55e':'#6b7280';
  lbl.textContent=isAvail?'ğŸŸ¢ Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù†':'âš« ØºÙŠØ± Ù…ØªØ§Ø­';
  api('/api/provider/availability',{method:'PUT',body:JSON.stringify({available:isAvail})});
  toast(isAvail?'Ø£Ù†Øª Ø§Ù„Ø¢Ù† Ù…ØªØ§Ø­ ğŸŸ¢':'ÙˆØ¶Ø¹Øª Ø­Ø§Ù„ØªÙƒ ÙƒØºÙŠØ± Ù…ØªØ§Ø­','success');
}

/* â”€â”€ SAVED (Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡ØªÙ…) â”€â”€ */
function isSaved(id){return savedIds.includes(id);}
function toggleSave(id,btn){
  var idx=savedIds.indexOf(id);
  if(idx>-1){
    savedIds.splice(idx,1);
    api('/api/saved/'+id,{method:'DELETE'});
    if(btn){btn.className='btn btn-save btn-sm';btn.textContent='ğŸ”– Ø§Ù‡ØªÙ…';}
    toast('Ø£ÙØ²ÙŠÙ„ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡ØªÙ…','info');
  }else{
    savedIds.push(id);
    api('/api/saved/'+id,{method:'POST'});
    if(btn){btn.className='btn btn-save saved btn-sm';btn.textContent='âœ“ Ù…Ù‡ØªÙ…';}
    toast('Ø£ÙØ¶ÙŠÙ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡ØªÙ… âœ…','success');
  }
  localStorage.setItem('saved_ids',JSON.stringify(savedIds));
  var cnt=document.getElementById('sb-saved-cnt');
  if(cnt){cnt.style.display=savedIds.length?'':'none';cnt.textContent=savedIds.length;}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function pgHome(){
  document.getElementById('content').innerHTML='<div class="loading"><div class="spin"></div></div>';
  Promise.all([
    api('/api/provider/stats'),
    api('/api/requests?status=open'),
    api('/api/my-bids')
  ]).then(function(res){
    var s=res[0]||{};var open=res[1]||[];var bids=res[2]||[];
    var winRate=s.total_bids?Math.round((s.won_bids||0)/s.total_bids*100):0;
    document.getElementById('sb-rating').textContent=s.avg_rating?Number(s.avg_rating).toFixed(1)+'â˜…':'â€”';
    document.getElementById('sb-done').textContent=s.completed||0;
    document.getElementById('sb-win').textContent=winRate+'%';

    document.getElementById('content').innerHTML=
    '<div class="pghd"><div><div class="pghd-t">Ù…Ø±Ø­Ø¨Ø§Ù‹ '+(me.name||'Ù…Ø²ÙˆØ¯Ù†Ø§')+' ğŸ‘‹</div><div class="pghd-s">Ù‡Ø°Ù‡ Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ</div></div>'+
    '<div class="pghd-r"><button class="btn btn-p" onclick="go(\'browse\',null)"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>ØªØµÙØ­ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</button></div></div>'+
    '<div class="sgrid">'+
      hsc('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±ÙˆØ¶',s.total_bids||0,'var(--pl)','#7c3aed','send','100','var(--p)','Ø¹Ø±Ø¶','tup')+
      hsc('Ø¹Ø±ÙˆØ¶ Ù…Ù‚Ø¨ÙˆÙ„Ø©',s.won_bids||0,'var(--gnl)','var(--gn)','check-circle',winRate,'var(--gn)',winRate+'% ÙÙˆØ²','tup')+
      hsc('Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…ÙƒØªÙ…Ù„Ø©',s.completed||0,'var(--bl)','var(--blue)','archive','100','var(--blue)','Ù…Ø´Ø±ÙˆØ¹','tup')+
      hsc('Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…',s.avg_rating?Number(s.avg_rating).toFixed(1):0,'var(--gl)','var(--gold2)','star',(s.avg_rating||0)*20,'var(--gold)',s.review_count||0+' ØªÙ‚ÙŠÙŠÙ…','tup')+
      hsc('Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°',s.active||0,'#ffedd5','var(--or)','zap','100','var(--or)','Ù†Ø´Ø·','twn')+
      hsc('Ø§Ù„Ù…Ù‡ØªÙ… Ø¨Ù‡Ø§',savedIds.length,'var(--gl)','var(--gold2)','bookmark','100','var(--gold)','Ù…Ø­ÙÙˆØ¸','tup')+
    '</div>'+
    '<div style="display:grid;grid-template-columns:1.3fr 1fr;gap:14px">'+
    '<div class="card"><div class="card-hd"><div class="card-hd-l"><div class="card-hd-ic" style="background:var(--gnl)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--gn)" stroke-width="1.8" width="13" height="13"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></div><div><div class="card-title">Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…ØªØ§Ø­Ø©</div><div class="card-sub">Ù…ÙØªÙˆØ­Ø© Ù„Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø¢Ù†</div></div></div><button class="btn btn-light btn-sm" onclick="go(\'browse\',null)">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button></div>'+
    '<div class="card-body">'+
    (open.length?open.slice(0,4).map(function(r){
      var sv=isSaved(r.id);
      return'<div style="border-bottom:1px solid var(--b2);padding:9px 0;display:flex;align-items:flex-start;gap:10px"><div style="flex:1"><div style="font-size:12px;font-weight:800;margin-bottom:3px">'+r.title+'</div><div style="display:flex;gap:5px;flex-wrap:wrap"><span class="pm">ğŸ“ '+(r.city||'â€”')+'</span><span class="pm">ğŸ“‚ '+(r.category||'â€”')+'</span>'+(r.budget_max?'<span class="pm">ğŸ’° '+r.budget_max.toLocaleString()+' Ø±.Ø³</span>':'')+'</div></div><div style="display:flex;gap:4px"><button class="btn btn-save '+(sv?'saved':'')+' btn-xs" onclick="toggleSave('+r.id+',this)">'+(sv?'âœ“ Ù…Ù‡ØªÙ…':'ğŸ”– Ø§Ù‡ØªÙ…')+'</button><button class="btn btn-p btn-xs" onclick="bidM('+r.id+',\''+r.title.replace(/'/g,'')+'\')">Ø¹Ø±Ø¶</button></div></div>';
    }).join(''):'<div class="empty"><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p></div>')+
    '</div></div>'+
    '<div class="card"><div class="card-hd"><div class="card-hd-l"><div class="card-hd-ic" style="background:var(--bl)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--blue)" stroke-width="1.8" width="13" height="13"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></div><div class="card-title">Ø¢Ø®Ø± Ø¹Ø±ÙˆØ¶ÙŠ</div></div><button class="btn btn-light btn-sm" onclick="go(\'mybids\',null)">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button></div>'+
    '<div class="card-body">'+
    (bids.length?bids.slice(0,5).map(function(b){
      var cls={accepted:'t-acc',rejected:'t-rej',pending:'t-pend'};
      var lbl={accepted:'Ù…Ù‚Ø¨ÙˆÙ„',rejected:'Ù…Ø±ÙÙˆØ¶',pending:'Ø¨Ø§Ù†ØªØ¸Ø§Ø±'};
      return'<div class="ir"><span class="ir-k" style="font-size:11px;font-weight:600;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+(b.request_title||'Ù…Ø´Ø±ÙˆØ¹ #'+b.request_id)+'</span><span class="tag '+(cls[b.status]||'t-pend')+'">'+(lbl[b.status]||'Ø¨Ø§Ù†ØªØ¸Ø§Ø±')+'</span></div>';
    }).join(''):'<div class="empty"><p>Ù„Ù… ØªÙ‚Ø¯Ù… Ø£ÙŠ Ø¹Ø±Ø¶ Ø¨Ø¹Ø¯</p></div>')+
    '</div></div></div>';
    lucide.createIcons();
  });
}

function hsc(lbl,val,ibg,ico,icon,pct,bclr,tr,trCls){
  return'<div class="sc"><div class="sc-top"><div class="sc-ico" style="background:'+ibg+';stroke:'+ico+'"><svg data-lucide="'+icon+'" viewBox="0 0 24 24" fill="none" stroke="'+ico+'" stroke-width="1.5" width="16" height="16"></svg></div><span class="sc-tr '+trCls+'">'+tr+'</span></div><div class="sc-val">'+val+'</div><div class="sc-lbl">'+lbl+'</div><div class="sc-bar"><div class="sc-bf" style="width:'+Math.min(pct,100)+'%;background:'+bclr+'"></div></div></div>';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BROWSE â€” ØªØµÙØ­ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function pgBrowse(){
  document.getElementById('content').innerHTML=
  '<div class="card">'+
  '<div class="card-hd"><div class="card-hd-l"><div class="card-hd-ic" style="background:var(--gnl)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--gn)" stroke-width="1.8" width="13" height="13"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></div><div><div class="card-title">ØªØµÙØ­ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</div><div class="card-sub">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¹Ø±ÙˆØ¶</div></div></div></div>'+
  '<div class="card-body">'+
  '<div class="fbar">'+
  '<div class="sbox"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" id="bf-q" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø§Ù„ØªÙØ§ØµÙŠÙ„..." oninput="filterBrowse()"></div>'+
  '<select class="fsel" id="bf-cat" onchange="filterBrowse()"><option value="">ÙƒÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</option>'+CATS.map(function(c){return'<option>'+c+'</option>';}).join('')+'</select>'+
  '<select class="fsel" id="bf-ci" onchange="filterBrowse()"><option value="">ÙƒÙ„ Ø§Ù„Ù…Ø¯Ù†</option>'+CITIES.map(function(c){return'<option>'+c+'</option>';}).join('')+'</select>'+
  '<select class="fsel" id="bf-sort" onchange="filterBrowse()"><option value="new">Ø§Ù„Ø£Ø­Ø¯Ø«</option><option value="budget">Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù…ÙŠØ²Ø§Ù†ÙŠØ©</option><option value="bids">Ø£Ù‚Ù„ Ø¹Ø±ÙˆØ¶</option></select>'+
  '</div>'+
  '<div id="browseList"><div class="loading"><div class="spin"></div></div></div>'+
  '</div></div>';
  api('/api/requests?status=open').then(function(r){allReqs=r||[];filterBrowse();});
}

function filterBrowse(){
  var q=((document.getElementById('bf-q')||{}).value||'').toLowerCase();
  var cat=((document.getElementById('bf-cat')||{}).value||'');
  var ci=((document.getElementById('bf-ci')||{}).value||'');
  var sort=((document.getElementById('bf-sort')||{}).value||'new');
  var f=allReqs.filter(function(r){
    return(!q||r.title.toLowerCase().includes(q)||(r.description||'').toLowerCase().includes(q))&&(!cat||r.category===cat)&&(!ci||r.city===ci);
  });
  if(sort==='budget')f.sort(function(a,b){return(b.budget_max||0)-(a.budget_max||0);});
  else if(sort==='bids')f.sort(function(a,b){return(a.bid_count||0)-(b.bid_count||0);});
  var el=document.getElementById('browseList');if(!el)return;
  if(!f.length){el.innerHTML='<div class="empty"><div class="empty-ic"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></div><h4>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø·Ø§Ø¨Ù‚Ø©</h4><p>Ø¬Ø±Ù‘Ø¨ ØªØºÙŠÙŠØ± ÙÙ„Ø§ØªØ± Ø§Ù„Ø¨Ø­Ø«</p></div>';return;}
  el.innerHTML=f.map(function(r){
    var sv=isSaved(r.id);
    var isNew=r.created_at&&(Date.now()-new Date(r.created_at).getTime())<86400000;
    return'<div class="pc pc-open" style="position:relative">'+
    (isNew?'<div class="pc-new-badge">Ø¬Ø¯ÙŠØ¯ âœ¨</div>':'')+
    '<div class="pc-hd"><div><div class="pc-num">'+(r.project_number||'#'+r.id)+'</div><div class="pc-title">'+r.title+'</div></div><span class="tag t-open">Ù…ÙØªÙˆØ­</span></div>'+
    '<div class="pc-meta"><span class="pm">ğŸ“ '+(r.city||'â€”')+'</span><span class="pm">ğŸ“‚ '+(r.category||'Ø¹Ø§Ù…')+'</span>'+(r.budget_max?'<span class="pm">ğŸ’° Ø­ØªÙ‰ '+r.budget_max.toLocaleString()+' Ø±.Ø³</span>':'')+(r.deadline?'<span class="pm">ğŸ“… '+r.deadline+'</span>':'')+'<span class="pm">ğŸ’¼ '+(r.bid_count||0)+' Ø¹Ø±Ø¶</span></div>'+
    (r.description?'<div class="pc-desc">'+r.description.slice(0,180)+(r.description.length>180?'...':'')+'</div>':'')+
    '<div class="pc-acts">'+
    '<button class="btn btn-p btn-sm" onclick="bidM('+r.id+',\''+r.title.replace(/'/g,'')+'\')">ğŸ“¤ ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±Ø¶</button>'+
    '<button class="btn btn-save '+(sv?'saved':'')+' btn-sm" onclick="toggleSave('+r.id+',this)">'+(sv?'âœ“ Ù…Ù‡ØªÙ…':'ğŸ”– Ø§Ù‡ØªÙ…')+'</button>'+
    '<button class="btn btn-light btn-sm" onclick="viewReq('+r.id+')">ğŸ‘ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>'+
    '</div></div>';
  }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SAVED â€” Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡ØªÙ…
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function pgSaved(){
  document.getElementById('content').innerHTML='<div class="loading"><div class="spin"></div></div>';
  api('/api/saved').then(function(r){
    var saved=r||[];
    savedIds=saved.map(function(x){return x.id;});
    localStorage.setItem('saved_ids',JSON.stringify(savedIds));
    var cnt=document.getElementById('sb-saved-cnt');
    if(cnt){cnt.style.display=savedIds.length?'':'none';cnt.textContent=savedIds.length;}

    document.getElementById('content').innerHTML=
    '<div class="card">'+
    '<div class="card-hd"><div class="card-hd-l"><div class="card-hd-ic" style="background:var(--gl)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--gold2)" stroke-width="1.8" width="13" height="13"><path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/></svg></div><div><div class="card-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡ØªÙ…</div><div class="card-sub">'+saved.length+' Ù…Ø´Ø±ÙˆØ¹ Ù…Ø­ÙÙˆØ¸</div></div></div>'+
    (saved.length?'<button class="btn btn-light btn-sm" onclick="clearAllSaved()">ğŸ—‘ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>':'')+
    '</div>'+
    '<div class="card-body">'+
    (saved.length?saved.map(function(r){
      return'<div class="pc pc-saved">'+
      '<div class="pc-hd"><div><div class="pc-num">'+(r.project_number||'#'+r.id)+'</div><div class="pc-title">'+r.title+'</div></div>'+
      '<span class="tag t-'+(r.status==='open'?'open':'pend')+'">'+( r.status==='open'?'Ù…ÙØªÙˆØ­':'Ù…Ø±Ø§Ø¬Ø¹Ø©')+'</span></div>'+
      '<div class="pc-meta"><span class="pm">ğŸ“ '+(r.city||'â€”')+'</span><span class="pm">ğŸ“‚ '+(r.category||'Ø¹Ø§Ù…')+'</span>'+(r.budget_max?'<span class="pm">ğŸ’° Ø­ØªÙ‰ '+r.budget_max.toLocaleString()+' Ø±.Ø³</span>':'')+'</div>'+
      (r.description?'<div class="pc-desc">'+r.description.slice(0,150)+'...</div>':'')+
      '<div class="pc-acts">'+
      (r.status==='open'?'<button class="btn btn-p btn-sm" onclick="bidM('+r.id+',\''+r.title.replace(/'/g,'')+'\')">ğŸ“¤ ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±Ø¶</button>':'')+
      '<button class="btn btn-light btn-sm" onclick="viewReq('+r.id+')">ğŸ‘ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>'+
      '<button class="btn btn-save saved btn-sm" onclick="toggleSave('+r.id+',this);setTimeout(pgSaved,500)">âœ“ Ø¥Ø²Ø§Ù„Ø©</button>'+
      '</div></div>';
    }).join(''):
    '<div class="empty"><div class="empty-ic"><svg viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/></svg></div><h4>Ù‚Ø§Ø¦Ù…ØªÙƒ ÙØ§Ø±ØºØ©</h4><p>Ø§Ø¶ØºØ· "Ø§Ù‡ØªÙ…" Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ø´Ø±ÙˆØ¹ Ù„Ø¥Ø¶Ø§ÙØªÙ‡ Ù‡Ù†Ø§</p></div>')+
    '</div></div>';
  });
}

function clearAllSaved(){
  if(!confirm('Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡ØªÙ…ØŸ'))return;
  Promise.all(savedIds.map(function(id){return api('/api/saved/'+id,{method:'DELETE'});})).then(function(){
    savedIds=[];localStorage.setItem('saved_ids','[]');
    toast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©','info');pgSaved();
    var cnt=document.getElementById('sb-saved-cnt');if(cnt)cnt.style.display='none';
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MY BIDS â€” Ø¹Ø±ÙˆØ¶ÙŠ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function pgMyBids(){
  document.getElementById('content').innerHTML='<div class="loading"><div class="spin"></div></div>';
  api('/api/my-bids').then(function(r){
    myBids=r||[];
    document.getElementById('sb-bids-cnt').textContent=myBids.length;
    var pend=myBids.filter(function(b){return b.status==='pending';}).length;
    var acc=myBids.filter(function(b){return b.status==='accepted';}).length;
    var rej=myBids.filter(function(b){return b.status==='rejected';}).length;

    document.getElementById('content').innerHTML=
    '<div class="pghd"><div><div class="pghd-t">Ø¹Ø±ÙˆØ¶ÙŠ</div><div class="pghd-s">ÙƒÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ØªÙŠ Ù‚Ø¯Ù…ØªÙ‡Ø§</div></div></div>'+
    '<div class="sgrid" style="grid-template-columns:repeat(4,1fr)">'+
      msc(myBids.length,'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±ÙˆØ¶','#7c3aed','var(--pl)')+
      msc(pend,'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø±Ø¯','#d97706','var(--gl)')+
      msc(acc,'Ù…Ù‚Ø¨ÙˆÙ„Ø© âœ…','#16a34a','var(--gnl)')+
      msc(rej,'Ù…Ø±ÙÙˆØ¶Ø©','#ef4444','var(--rl)')+
    '</div>'+
    '<div class="card"><div class="card-hd"><div class="card-hd-l"><div class="card-hd-ic" style="background:var(--bl)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--blue)" stroke-width="1.8" width="13" height="13"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></div><div class="card-title">ÙƒÙ„ Ø¹Ø±ÙˆØ¶ÙŠ</div></div>'+
    '<select class="fsel" id="bf-st" onchange="filterMyBids()"><option value="">Ø§Ù„ÙƒÙ„</option><option value="pending">Ø¨Ø§Ù†ØªØ¸Ø§Ø±</option><option value="accepted">Ù…Ù‚Ø¨ÙˆÙ„</option><option value="rejected">Ù…Ø±ÙÙˆØ¶</option></select></div>'+
    '<div class="card-body" id="bidsList">'+renderMyBids(myBids)+'</div></div>';
  });
}

function filterMyBids(){
  var st=((document.getElementById('bf-st')||{}).value||'');
  var f=st?myBids.filter(function(b){return b.status===st;}):myBids;
  var el=document.getElementById('bidsList');if(el)el.innerHTML=renderMyBids(f);
}

function renderMyBids(bids){
  if(!bids.length)return'<div class="empty"><h4>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶</h4></div>';
  var cls={accepted:'offer-acc',rejected:'offer-rej',pending:'offer-pend'};
  var lbl={accepted:'âœ“ Ù…Ù‚Ø¨ÙˆÙ„',rejected:'âœ— Ù…Ø±ÙÙˆØ¶',pending:'â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø±'};
  var tc={accepted:'t-acc',rejected:'t-rej',pending:'t-pend'};
  return bids.map(function(b){
    return'<div class="offer-c '+(cls[b.status]||'offer-pend')+'">'+
    '<div class="offer-hd"><div><div class="offer-num">'+(b.project_number||'#'+b.request_id)+'</div><div class="offer-proj">'+(b.request_title||'Ù…Ø´Ø±ÙˆØ¹')+'</div></div>'+
    '<span class="tag '+(tc[b.status]||'t-pend')+'">'+(lbl[b.status]||'Ø¨Ø§Ù†ØªØ¸Ø§Ø±')+'</span></div>'+
    '<div class="offer-info">'+
    '<div class="offer-ii"><span>Ø§Ù„Ø³Ø¹Ø±:</span>'+b.price.toLocaleString()+' Ø±.Ø³</div>'+
    '<div class="offer-ii"><span>Ø§Ù„Ù…Ø¯Ø©:</span>'+b.days+' ÙŠÙˆÙ…</div>'+
    (b.created_at?'<div class="offer-ii"><span>ØªØ§Ø±ÙŠØ®:</span>'+new Date(b.created_at).toLocaleDateString('ar-SA')+'</div>':'')+
    '</div>'+
    (b.note?'<div class="offer-note">'+b.note+'</div>':'')+
    (b.status==='pending'?'<div style="margin-top:7px"><button class="btn btn-r btn-xs" onclick="withdrawBid('+b.id+')">â†© Ø³Ø­Ø¨ Ø§Ù„Ø¹Ø±Ø¶</button></div>':'')+
    (b.status==='accepted'?'<div style="margin-top:7px;background:var(--gnl);border-radius:7px;padding:7px 10px;font-size:11px;color:var(--gn);font-weight:700">ğŸ‰ ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø¹Ø±Ø¶Ùƒ! ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„Ø¨Ø¯Ø¡</div>':'')+
    '</div>';
  }).join('');
}

function msc(val,lbl,c,bg){return'<div class="sc"><div class="sc-val" style="color:'+c+'">'+val+'</div><div class="sc-lbl">'+lbl+'</div></div>';}

function withdrawBid(id){
  if(!confirm('Ø³Ø­Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ØŸ'))return;
  api('/api/bids/'+id,{method:'DELETE'}).then(function(){toast('ØªÙ… Ø³Ø­Ø¨ Ø§Ù„Ø¹Ø±Ø¶','info');pgMyBids();});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACTIVE PROJECTS â€” Ù…Ø´Ø§Ø±ÙŠØ¹ÙŠ Ø§Ù„Ù†Ø´Ø·Ø©
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function pgActive(){
  document.getElementById('content').innerHTML='<div class="loading"><div class="spin"></div></div>';
  api('/api/my-projects?status=in_progress').then(function(r){
    var projects=r||[];
    document.getElementById('content').innerHTML=
    '<div class="pghd"><div><div class="pghd-t">Ù…Ø´Ø§Ø±ÙŠØ¹ÙŠ Ø§Ù„Ù†Ø´Ø·Ø©</div><div class="pghd-s">'+projects.length+' Ù…Ø´Ø±ÙˆØ¹ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</div></div></div>'+
    (projects.length?projects.map(function(p){
      return'<div class="card">'+
      '<div class="card-hd"><div class="card-hd-l"><div class="card-hd-ic" style="background:var(--bl)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--blue)" stroke-width="1.8" width="13" height="13"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></div>'+
      '<div><div class="card-title">'+p.title+'</div><div class="card-sub">'+(p.project_number||'#'+p.id)+' â€¢ '+(p.client_name||'Ø§Ù„Ø¹Ù…ÙŠÙ„')+'</div></div></div>'+
      '<span class="tag t-prog">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</span></div>'+
      '<div class="card-body">'+
      '<div class="tracker">'+trackerHTML(p.status)+'</div>'+
      '<div class="ib"><div class="ib-t">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</div>'+
      '<div class="ir"><span class="ir-k">Ø§Ù„Ø¹Ù…ÙŠÙ„</span><span class="ir-v">'+(p.client_name||'â€”')+'</span></div>'+
      '<div class="ir"><span class="ir-k">Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</span><span class="ir-v" style="color:var(--or)">'+(p.deadline||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')+'</span></div>'+
      '<div class="ir"><span class="ir-k">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ØªÙÙ‚</span><span class="ir-v" style="color:var(--gn)">'+(p.agreed_price?p.agreed_price.toLocaleString()+' Ø±.Ø³':'â€”')+'</span></div>'+
      '<div class="ir"><span class="ir-k">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</span><span class="ir-v">'+(p.city||'â€”')+'</span></div>'+
      (p.address?'<div class="ir"><span class="ir-k">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</span><span class="ir-v">'+p.address+'</span></div>':'')+
      '</div>'+
      (p.client_phone?'<div style="display:flex;gap:7px;margin-top:7px"><a href="tel:'+p.client_phone+'" class="btn btn-g btn-sm">ğŸ“ Ø§ØªØµÙ„ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„</a><a href="https://wa.me/966'+p.client_phone.replace(/^0/,'')+'" target="_blank" class="btn btn-light btn-sm">ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨</a></div>':'')+
      '</div></div>';
    }).join(''):
    '<div class="card"><div class="card-body"><div class="empty"><div class="empty-ic"><svg viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></div><h4>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù†Ø´Ø·Ø©</h4><p>Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙÙ‚Ø¨Ù„ Ø¹Ø±Ø¶Ùƒ Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù‡Ù†Ø§</p></div></div></div>');
  });
}

function trackerHTML(status){
  var steps=[
    {key:'open',lbl:'Ù†ÙØ´Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹'},
    {key:'in_progress',lbl:'Ø¨Ø¯Ø£ Ø§Ù„ØªÙ†ÙÙŠØ°'},
    {key:'completing',lbl:'Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø¹Ù…Ù„'},
    {key:'completed',lbl:'ØªÙ… Ø§Ù„Ø¥ØºÙ„Ø§Ù‚'}
  ];
  var active=status==='in_progress'?1:status==='completed'?3:0;
  return steps.map(function(s,i){
    var cls=i<active?'done':i===active?'cur':'';
    return'<div class="tracker-step '+cls+'"><div class="tracker-dot">'+(i<active?'âœ“':i+1)+'</div><div class="tracker-lbl">'+s.lbl+'</div></div>';
  }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HISTORY â€” ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…Ù„
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function pgHistory(){
  document.getElementById('content').innerHTML='<div class="loading"><div class="spin"></div></div>';
  api('/api/my-projects?status=completed').then(function(r){
    var projects=r||[];
    document.getElementById('content').innerHTML=
    '<div class="pghd"><div><div class="pghd-t">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…Ù„</div><div class="pghd-s">'+projects.length+' Ù…Ø´Ø±ÙˆØ¹ Ù…ÙƒØªÙ…Ù„</div></div></div>'+
    '<div class="card"><div class="card-body">'+
    (projects.length?'<div class="tw"><table class="tbl"><thead><tr><th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„</th></tr></thead><tbody>'+
    projects.map(function(p){
      var stars=p.my_rating?starsHTML(p.my_rating):'<span style="color:var(--sub);font-size:11px">Ù„Ù… ÙŠÙÙ‚ÙŠÙÙ‘Ù…</span>';
      return'<tr>'+
      '<td><div style="font-size:12px;font-weight:700">'+(p.project_number||'#'+p.id)+'</div><div style="font-size:11px;color:var(--sub)">'+p.title+'</div></td>'+
      '<td style="font-size:12px">'+(p.client_name||'â€”')+'</td>'+
      '<td style="font-size:11px">'+(p.city||'â€”')+'</td>'+
      '<td style="font-size:12px;font-weight:700;color:var(--gn)">'+(p.agreed_price?p.agreed_price.toLocaleString()+' Ø±.Ø³':'â€”')+'</td>'+
      '<td>'+stars+'</td>'+
      '<td style="font-size:11px;color:var(--sub)">'+(p.completed_at?new Date(p.completed_at).toLocaleDateString('ar-SA'):'â€”')+'</td>'+
      '</tr>';
    }).join('')+'</tbody></table></div>':
    '<div class="empty"><div class="empty-ic"><svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div><h4>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…ÙƒØªÙ…Ù„Ø© Ø¨Ø¹Ø¯</h4></div>')+
    '</div></div>';
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BID MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function bidM(reqId,title){
  openM('ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±Ø¶ â€” '+title,
    '<div class="fg"><label class="fl">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (Ø±.Ø³) <em>*</em></label><input type="number" class="fi" id="bid-price" placeholder="Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø±Ùƒ Ø§Ù„ØªÙ†Ø§ÙØ³ÙŠ" min="1"></div>'+
    '<div class="fg"><label class="fl">Ù…Ø¯Ø© Ø§Ù„ØªÙ†ÙÙŠØ° (Ø£ÙŠØ§Ù…) <em>*</em></label><input type="number" class="fi" id="bid-days" placeholder="Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²" min="1"></div>'+
    '<div class="fg"><label class="fl">Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ ÙˆÙ…Ø¤Ù‡Ù„Ø§ØªÙƒ</label><textarea class="fta" id="bid-note" placeholder="Ø§Ø´Ø±Ø­ Ù„Ù…Ø§Ø°Ø§ Ø£Ù†Øª Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙØ¶Ù„ØŒ Ø§Ø°ÙƒØ± Ø®Ø¨Ø±Ø§ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©..." style="min-height:100px"></textarea></div>',
    '<button class="btn btn-ghost" onclick="closeM()">Ø¥Ù„ØºØ§Ø¡</button><button class="btn btn-p" onclick="doSubmitBid('+reqId+')">ğŸ“¤ ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø¹Ø±Ø¶</button>',
    '<svg viewBox="0 0 24 24" fill="none" stroke="var(--p)" stroke-width="1.8" width="14" height="14"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>','var(--pl)'
  );
}

function doSubmitBid(reqId){
  var price=document.getElementById('bid-price').value;
  var days=document.getElementById('bid-days').value;
  var note=document.getElementById('bid-note').value;
  if(!price||!days){toast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ù…Ø¯Ø©','error');return;}
  api('/api/bids',{method:'POST',body:JSON.stringify({request_id:reqId,price:parseFloat(price),days:parseInt(days),note:note})}).then(function(r){
    if(r.message&&!r.id){toast(r.message,'error');return;}
    closeM();toast('ØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±Ø¶Ùƒ âœ… Ø³ÙŠØµÙ„Ùƒ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø¯','success');
    document.getElementById('sb-bids-cnt').textContent=parseInt(document.getElementById('sb-bids-cnt').textContent||0)+1;
  });
}

function viewReq(id){
  api('/api/requests/'+id).then(function(r){
    var sv=isSaved(r.id);
    openM('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹',
      '<div style="background:#111827;border-radius:10px;padding:14px;margin-bottom:14px">'+
      '<div style="font-size:9px;font-weight:700;color:rgba(255,255,255,.3);letter-spacing:1px;margin-bottom:3px">'+(r.project_number||'#'+r.id)+'</div>'+
      '<div style="font-size:15px;font-weight:900;color:#fff;margin-bottom:8px">'+r.title+'</div>'+
      '<div style="display:flex;gap:6px;flex-wrap:wrap"><span style="font-size:10px;color:rgba(255,255,255,.45);background:rgba(255,255,255,.07);padding:2px 8px;border-radius:20px">ğŸ“‚ '+(r.category||'â€”')+'</span><span style="font-size:10px;color:rgba(255,255,255,.45);background:rgba(255,255,255,.07);padding:2px 8px;border-radius:20px">ğŸ“ '+(r.city||'â€”')+'</span>'+(r.budget_max?'<span style="font-size:10px;color:rgba(255,255,255,.45);background:rgba(255,255,255,.07);padding:2px 8px;border-radius:20px">ğŸ’° Ø­ØªÙ‰ '+r.budget_max.toLocaleString()+' Ø±.Ø³</span>':'')+'</div></div>'+
      '<div class="ib"><div class="ib-t">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</div>'+
      '<div class="ir"><span class="ir-k">Ø§Ù„ØªØµÙ†ÙŠÙ</span><span class="ir-v">'+(r.category||'â€”')+'</span></div>'+
      '<div class="ir"><span class="ir-k">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù‚ØµÙˆÙ‰</span><span class="ir-v" style="color:var(--gn)">'+(r.budget_max?r.budget_max.toLocaleString()+' Ø±.Ø³':'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')+'</span></div>'+
      '<div class="ir"><span class="ir-k">Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</span><span class="ir-v">'+(r.deadline||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')+'</span></div>'+
      '<div class="ir"><span class="ir-k">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø±ÙˆØ¶</span><span class="ir-v">'+(r.bid_count||0)+' Ø¹Ø±Ø¶</span></div></div>'+
      (r.description?'<div class="ib"><div class="ib-t">Ø§Ù„ØªÙØ§ØµÙŠÙ„</div><div style="font-size:12px;line-height:1.8;color:#4b5563">'+r.description+'</div></div>':''),
      (r.status==='open'?'<button class="btn btn-save '+(sv?'saved':'')+' btn-sm" onclick="toggleSave('+r.id+',this)">'+(sv?'âœ“ Ù…Ù‡ØªÙ…':'ğŸ”– Ø§Ù‡ØªÙ…')+'</button><button class="btn btn-p" onclick="closeM();bidM('+r.id+',\''+r.title.replace(/'/g,'')+'\')">ğŸ“¤ ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±Ø¶</button>':'')+'<button class="btn btn-ghost" onclick="closeM()">Ø¥ØºÙ„Ø§Ù‚</button>',
      '<svg viewBox="0 0 24 24" fill="none" stroke="var(--p)" stroke-width="1.8" width="14" height="14"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/></svg>','var(--pl)'
    );
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REVIEWS â€” ØªÙ‚ÙŠÙŠÙ…Ø§ØªÙŠ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function pgReviews(){
  document.getElementById('content').innerHTML='<div class="loading"><div class="spin"></div></div>';
  api('/api/my-reviews').then(function(r){
    var revs=r||[];
    var avg=revs.length?revs.reduce(function(s,x){return s+x.rating;},0)/revs.length:0;
    var dist={5:0,4:0,3:0,2:0,1:0};
    revs.forEach(function(x){dist[x.rating]=(dist[x.rating]||0)+1;});

    document.getElementById('content').innerHTML=
    '<div class="pghd"><div><div class="pghd-t">ØªÙ‚ÙŠÙŠÙ…Ø§ØªÙŠ</div><div class="pghd-s">'+revs.length+' ØªÙ‚ÙŠÙŠÙ… Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div></div></div>'+
    '<div style="display:grid;grid-template-columns:200px 1fr;gap:14px;margin-bottom:18px">'+
    '<div class="card"><div class="card-body" style="text-align:center">'+
    '<div style="font-size:42px;font-weight:900;color:var(--text)">'+avg.toFixed(1)+'</div>'+
    '<div style="color:#f59e0b;font-size:20px;margin:5px 0">'+starsHTML(Math.round(avg))+'</div>'+
    '<div style="font-size:11px;color:var(--sub)">Ù…Ù† '+revs.length+' ØªÙ‚ÙŠÙŠÙ…</div>'+
    '</div></div>'+
    '<div class="card"><div class="card-body">'+[5,4,3,2,1].map(function(n){var c=dist[n]||0;var pct=revs.length?Math.round(c/revs.length*100):0;return'<div class="rpt-row" style="margin-bottom:7px"><div style="font-size:11px;font-weight:600;width:50px;flex-shrink:0">'+n+' â˜…</div><div style="flex:1;height:6px;border-radius:6px;background:var(--b2);overflow:hidden"><div style="height:100%;width:'+pct+'%;background:var(--gold);border-radius:6px;transition:width 1s"></div></div><div style="font-size:10px;color:var(--sub);width:30px;text-align:left;flex-shrink:0">'+c+'</div></div>';}).join('')+'</div></div>'+
    '</div>'+
    '<div class="card"><div class="card-hd"><div class="card-hd-l"><div class="card-hd-ic" style="background:var(--gl)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--gold2)" stroke-width="1.8" width="13" height="13"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></div><div class="card-title">ÙƒÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</div></div>'+
    '<select class="fsel" id="rvf" onchange="filterMyRevs(this.value)"><option value="">ÙƒÙ„ Ø§Ù„Ù†Ø¬ÙˆÙ…</option><option value="5">5 â˜…</option><option value="4">4 â˜…</option><option value="3">3 â˜…</option><option value="2">2 â˜…</option><option value="1">1 â˜…</option></select></div>'+
    '<div class="card-body" id="revsList">'+renderRevs(revs)+'</div></div>';

    window._allRevs=revs;
  });
}

function filterMyRevs(n){
  var f=n?window._allRevs.filter(function(r){return r.rating==n;}):window._allRevs;
  var el=document.getElementById('revsList');if(el)el.innerHTML=renderRevs(f);
}

function renderRevs(revs){
  if(!revs.length)return'<div class="empty"><h4>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h4></div>';
  return revs.map(function(r){
    var bg=COLORS[(r.reviewer_id||1)%COLORS.length];
    var date=r.created_at?new Date(r.created_at).toLocaleDateString('ar-SA'):'â€”';
    return'<div class="rev-c">'+
    '<div class="rev-hd"><div style="display:flex;align-items:center;gap:8px"><div class="rev-av" style="background:'+bg+'">'+(r.reviewer_name||'ØŸ').charAt(0)+'</div><div><div class="rev-nm">'+(r.reviewer_name||'â€”')+'</div><div class="rev-sub">'+(r.project_number||'#'+r.request_id)+'</div></div></div>'+
    '<div style="text-align:left"><div class="rev-stars">'+starsHTML(r.rating)+'</div><div style="font-size:10px;color:var(--sub);margin-top:2px">'+date+'</div></div></div>'+
    (r.comment?'<div class="rev-txt">'+r.comment+'</div>':'')+
    (r.admin_reply?'<div class="rev-reply"><div class="rev-reply-lbl">Ø±Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>'+r.admin_reply+'</div>':'')+
    '</div>';
  }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NOTIFICATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function pgNotifs(){
  document.getElementById('content').innerHTML='<div class="loading"><div class="spin"></div></div>';
  api('/api/notifications').then(function(r){
    myNotifs=r||[];
    var unread=myNotifs.filter(function(n){return!n.read;}).length;
    document.getElementById('content').innerHTML=
    '<div class="card">'+
    '<div class="card-hd"><div class="card-hd-l"><div class="card-hd-ic" style="background:var(--pl)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--p)" stroke-width="1.8" width="13" height="13"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg></div><div><div class="card-title">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</div><div class="card-sub">'+unread+' ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡</div></div></div>'+
    (unread?'<button class="btn btn-light btn-sm" onclick="markAllRead()">âœ“ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒÙ„</button>':'')+
    '</div>'+
    '<div class="card-body">'+
    (myNotifs.length?myNotifs.map(function(n){
      var ic={'bid_accepted':'ğŸ‰','bid_rejected':'âŒ','project_complete':'âœ…','warning':'âš ï¸','admin':'ğŸ“¢','info':'â„¹ï¸'};
      var bg={'bid_accepted':'var(--gnl)','bid_rejected':'var(--rl)','warning':'var(--ol)','admin':'var(--pl)'};
      return'<div class="notif-item '+(n.read?'':'unread')+'" onclick="readNotif('+n.id+')">'+
      '<div class="notif-ic" style="background:'+(bg[n.type]||'var(--bg)')+'">'+(ic[n.type]||'ğŸ””')+'</div>'+
      '<div style="flex:1"><div class="notif-title">'+(n.title||'Ø¥Ø´Ø¹Ø§Ø±')+'</div><div class="notif-body">'+(n.body||'')+'</div><div class="notif-time">'+(n.created_at?new Date(n.created_at).toLocaleDateString('ar-SA'):'Ø§Ù„Ø¢Ù†')+'</div></div>'+
      (!n.read?'<div class="notif-dot"></div>':'')+
      '</div>';
    }).join(''):
    '<div class="empty"><div class="empty-ic"><svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/></svg></div><h4>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h4></div>')+
    '</div></div>';
    var dot=document.getElementById('notif-dot');
    var cnt=document.getElementById('sb-notif-cnt');
    if(dot)dot.style.display=unread?'':'none';
    if(cnt){cnt.style.display=unread?'':'none';cnt.textContent=unread;}
  });
}

function readNotif(id){api('/api/notifications/'+id+'/read',{method:'PUT'});}
function markAllRead(){api('/api/notifications/read-all',{method:'PUT'}).then(function(){pgNotifs();});}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WALLET â€” Ø§Ù„Ù…Ø­ÙØ¸Ø©
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function pgWallet(){
  document.getElementById('content').innerHTML='<div class="loading"><div class="spin"></div></div>';
  api('/api/provider/stats').then(function(s){
    var total=(s.completed||0)*(s.avg_price||0);
    document.getElementById('content').innerHTML=
    '<div class="pghd"><div class="pghd-t">Ø§Ù„Ù…Ø­ÙØ¸Ø©</div></div>'+
    '<div class="wallet-card">'+
    '<div class="wallet-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</div>'+
    '<div class="wallet-val">'+total.toLocaleString()+' <span style="font-size:14px;font-weight:500;opacity:.4">Ø±.Ø³</span></div>'+
    '<div class="wallet-sub">Ù…Ù† '+(s.completed||0)+' Ù…Ø´Ø±ÙˆØ¹ Ù…ÙƒØªÙ…Ù„</div>'+
    '<div class="wallet-stats">'+
    '<div class="wallet-stat"><div class="wallet-stat-val">'+(s.completed||0)+'</div><div class="wallet-stat-lbl">Ù…ÙƒØªÙ…Ù„</div></div>'+
    '<div class="wallet-stat"><div class="wallet-stat-val">'+(s.avg_price?Math.round(s.avg_price).toLocaleString():0)+'</div><div class="wallet-stat-lbl">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</div></div>'+
    '<div class="wallet-stat"><div class="wallet-stat-val">'+(s.active||0)+'</div><div class="wallet-stat-lbl">Ù†Ø´Ø· Ø­Ø§Ù„ÙŠØ§Ù‹</div></div>'+
    '</div></div>'+
    '<div class="card"><div class="card-hd"><div class="card-hd-l"><div class="card-hd-ic" style="background:var(--gnl)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--gn)" stroke-width="1.8" width="13" height="13"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div><div class="card-title">Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø§Ù„ÙŠ</div></div></div>'+
    '<div class="card-body">'+
    '<div class="ib">'+
    '<div class="ir"><span class="ir-k">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</span><span class="ir-v" style="color:var(--gn)">'+total.toLocaleString()+' Ø±.Ø³</span></div>'+
    '<div class="ir"><span class="ir-k">Ù…ØªÙˆØ³Ø· Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</span><span class="ir-v">'+(s.avg_price?Math.round(s.avg_price).toLocaleString():0)+' Ø±.Ø³</span></div>'+
    '<div class="ir"><span class="ir-k">Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ² Ø¨Ø§Ù„Ø¹Ø±ÙˆØ¶</span><span class="ir-v">'+( s.total_bids?Math.round((s.won_bids||0)/s.total_bids*100):0)+'%</span></div>'+
    '<div class="ir"><span class="ir-k">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©</span><span class="ir-v">'+(s.total_bids||0)+' Ø¹Ø±Ø¶</span></div>'+
    '</div>'+
    '<div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:12px;font-size:12px;color:var(--gn)">'+
    'ğŸ’¡ Ù†ØµÙŠØ­Ø©: Ø±ÙØ¹ Ù…Ø³ØªÙˆÙ‰ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ ÙˆØ¥Ø¶Ø§ÙØ© Ø£Ø¹Ù…Ø§Ù„ Ø³Ø§Ø¨Ù‚Ø© ÙŠØ²ÙŠØ¯ Ù†Ø³Ø¨Ø© Ù‚Ø¨ÙˆÙ„ Ø¹Ø±ÙˆØ¶Ùƒ'+
    '</div>'+
    '</div></div>';
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROFILE â€” Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function pgProfile(){
  document.getElementById('content').innerHTML='<div class="loading"><div class="spin"></div></div>';
  api('/api/me').then(function(u){
    imgData['prof']=[];
    var BM={none:{c:'b-none',l:'Ø¨Ø¯ÙˆÙ† ÙˆØ³Ø§Ù…',i:'â€”'},verified:{c:'b-verified',l:'Ù…ÙˆØ«Ù‚',i:'âœ“'},star:{c:'b-star',l:'Ù…ØªÙ…ÙŠØ²',i:'â­'},partner:{c:'b-partner',l:'Ø´Ø±ÙŠÙƒ',i:'ğŸ’'},top:{c:'b-top',l:'Ø§Ù„Ø£ÙØ¶Ù„',i:'ğŸ†'}};
    var b=BM[u.badge||'none']||BM.none;
    document.getElementById('content').innerHTML=
    '<div class="profile-banner">'+
    '<div class="profile-av">'+(u.name||'Ù…').charAt(0)+'</div>'+
    '<div><div class="profile-nm">'+(u.name||'â€”')+'</div><div class="profile-email">'+(u.email||'â€”')+'</div>'+
    '<div class="profile-badges">'+
    '<span style="font-size:10px;background:rgba(255,255,255,.08);color:rgba(255,255,255,.5);padding:2px 8px;border-radius:20px">ğŸ“ '+(u.city||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')+'</span>'+
    '<span style="font-size:10px;background:var(--gold);color:#fff;padding:2px 8px;border-radius:20px">'+b.i+' '+b.l+'</span>'+
    '</div></div>'+
    '<button class="btn btn-light btn-sm" style="margin-right:auto" onclick="editProfile('+JSON.stringify(u).replace(/"/g,"'")+')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>'+
    '</div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">'+
    '<div class="card"><div class="card-hd"><div class="card-title">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</div></div>'+
    '<div class="card-body"><div class="ib">'+
    '<div class="ir"><span class="ir-k">Ø§Ù„Ø§Ø³Ù…</span><span class="ir-v">'+(u.name||'â€”')+'</span></div>'+
    '<div class="ir"><span class="ir-k">Ø§Ù„Ø¨Ø±ÙŠØ¯</span><span class="ir-v">'+(u.email||'â€”')+'</span></div>'+
    '<div class="ir"><span class="ir-k">Ø§Ù„Ø¬ÙˆØ§Ù„</span><span class="ir-v">'+(u.phone||'â€”')+'</span></div>'+
    '<div class="ir"><span class="ir-k">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</span><span class="ir-v">'+(u.city||'â€”')+'</span></div>'+
    '</div></div></div>'+
    '<div class="card"><div class="card-hd"><div class="card-title">Ø§Ù„ØªØ®ØµØµØ§Øª</div></div>'+
    '<div class="card-body">'+
    (u.specialties&&u.specialties.length?'<div style="display:flex;gap:5px;flex-wrap:wrap">'+u.specialties.map(function(s){return'<span style="background:var(--pl);color:var(--p2);padding:3px 9px;border-radius:20px;font-size:11px;font-weight:700;border:1px solid var(--pm)">'+s+'</span>';}).join('')+'</div>':
    '<div class="empty"><p>Ù„Ù… ØªØ­Ø¯Ø¯ ØªØ®ØµØµØ§ØªÙƒ Ø¨Ø¹Ø¯</p></div>')+
    '</div></div></div>'+
    (u.bio?'<div class="card"><div class="card-hd"><div class="card-title">Ù†Ø¨Ø°Ø© Ø¹Ù†ÙŠ</div></div><div class="card-body"><p style="font-size:13px;line-height:1.8;color:#4b5563">'+u.bio+'</p></div></div>':'');
  });
}

function editProfile(u){
  imgData['prof']=[];
  openM('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ',
    '<div class="fsec">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>'+
    '<div class="f2">'+
    '<div class="fg"><label class="fl">Ø§Ù„Ø§Ø³Ù…</label><input type="text" class="fi" id="ep-name" value="'+(u.name||'')+'"></div>'+
    '<div class="fg"><label class="fl">Ø§Ù„Ø¬ÙˆØ§Ù„</label><input type="text" class="fi" id="ep-phone" value="'+(u.phone||'')+'"></div>'+
    '<div class="fg"><label class="fl">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label><select class="fsel2" id="ep-city"><option value="">Ø§Ø®ØªØ±</option>'+CITIES.map(function(c){return'<option '+(u.city===c?'selected':'')+'>'+c+'</option>';}).join('')+'</select></div>'+
    '</div>'+
    '<div class="fsec">Ø§Ù„ØªØ®ØµØµØ§Øª</div>'+
    specsHTML(u.specialties||[])+
    '<div class="fsec">Ù†Ø¨Ø°Ø© Ø¹Ù†ÙŠ</div>'+
    '<div class="fg"><textarea class="fta" id="ep-bio" style="min-height:90px" placeholder="Ø§ÙƒØªØ¨ Ù†Ø¨Ø°Ø© Ù…Ø®ØªØµØ±Ø© Ø¹Ù† Ø®Ø¨Ø±Ø§ØªÙƒ ÙˆØ£Ø¹Ù…Ø§Ù„Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©...">'+(u.bio||'')+'</textarea></div>'+
    '<div class="fsec">ØµÙˆØ± Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>'+
    imgUpHTML('prof'),
    '<button class="btn btn-ghost" onclick="closeM()">Ø¥Ù„ØºØ§Ø¡</button><button class="btn btn-p" onclick="saveProfile()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>',
    '<svg viewBox="0 0 24 24" fill="none" stroke="var(--p)" stroke-width="1.8" width="14" height="14"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>','var(--pl)'
  );
}

function saveProfile(){
  var data={
    name:document.getElementById('ep-name').value,
    phone:document.getElementById('ep-phone').value,
    city:document.getElementById('ep-city').value,
    specialties:getSpecs(),
    bio:document.getElementById('ep-bio').value
  };
  api('/api/me',{method:'PUT',body:JSON.stringify(data)}).then(function(r){
    if(r.message&&!r.id){toast(r.message,'error');return;}
    me=Object.assign(me,data);
    localStorage.setItem('user',JSON.stringify(me));
    document.getElementById('sb-name').textContent=me.name||'Ø§Ù„Ù…Ø²ÙˆØ¯';
    document.getElementById('sb-av').textContent=(me.name||'Ù…').charAt(0);
    closeM();toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù âœ…','success');pgProfile();
  });
}

/* â”€â”€ OVERLAY CLOSE â”€â”€ */
document.getElementById('overlay').addEventListener('click',function(e){if(e.target===this)closeM();});

/* â”€â”€ INIT â”€â”€ */
api('/api/saved').then(function(r){
  if(r&&r.length){savedIds=r.map(function(x){return x.id;});localStorage.setItem('saved_ids',JSON.stringify(savedIds));var cnt=document.getElementById('sb-saved-cnt');if(cnt&&savedIds.length){cnt.style.display='';cnt.textContent=savedIds.length;}}
});
api('/api/notifications').then(function(r){
  var unread=(r||[]).filter(function(n){return!n.read;}).length;
  if(unread){var dot=document.getElementById('notif-dot');var cnt=document.getElementById('sb-notif-cnt');if(dot)dot.style.display='';if(cnt){cnt.style.display='';cnt.textContent=unread;}}
});
lucide.createIcons();
go('home',document.querySelector('.sbi.on'));
</script>
</body>
</html>
