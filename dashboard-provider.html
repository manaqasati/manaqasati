<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Ù…Ù†Ø§Ù‚ØµØ© â€” Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø²ÙˆØ¯</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
  --gray-50:#f9fafb;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-300:#d1d5db;
  --gray-400:#9ca3af;--gray-500:#6b7280;--gray-600:#4b5563;--gray-700:#374151;
  --gray-800:#1f2937;--gray-900:#111827;
  --violet-50:#f5f3ff;--violet-100:#ede9fe;--violet-200:#ddd6fe;--violet-300:#c4b5fd;
  --violet-500:#8b5cf6;--violet-600:#7c3aed;--violet-700:#6d28d9;
  --amber-50:#fffbeb;--amber-100:#fef3c7;--amber-200:#fde68a;--amber-400:#fbbf24;--amber-500:#f59e0b;--amber-600:#d97706;
  --emerald-50:#ecfdf5;--emerald-100:#d1fae5;--emerald-200:#a7f3d0;--emerald-500:#10b981;--emerald-600:#059669;--emerald-700:#047857;
  --red-50:#fef2f2;--red-100:#fee2e2;--red-400:#f87171;--red-500:#ef4444;--red-600:#dc2626;
  --blue-50:#eff6ff;--blue-100:#dbeafe;--blue-500:#3b82f6;--blue-600:#2563eb;
  --orange-50:#fff7ed;--orange-100:#ffedd5;--orange-500:#f97316;--orange-600:#ea580c;
  --bg:#f8f9fb;--surface:#fff;--border:#e5e7eb;--border-subtle:#f3f4f6;
  --text-primary:#111827;--text-secondary:#6b7280;--text-tertiary:#9ca3af;
  --brand:#7c3aed;--brand-light:#ede9fe;
  --sidebar:240px;--topbar:52px;
  --r-sm:6px;--r-md:8px;--r-lg:12px;--r-xl:16px;--r-full:9999px;
  --shadow-sm:0 1px 2px rgba(0,0,0,.05);
  --shadow-md:0 4px 6px -1px rgba(0,0,0,.07),0 2px 4px -1px rgba(0,0,0,.05);
  --shadow-lg:0 10px 15px -3px rgba(0,0,0,.08),0 4px 6px -2px rgba(0,0,0,.04);
  --shadow-xl:0 20px 25px -5px rgba(0,0,0,.1),0 10px 10px -5px rgba(0,0,0,.04);
  --t-fast:100ms ease;--t-base:150ms ease;--t-slow:250ms ease;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Tajawal',sans-serif;font-size:14px;line-height:1.5;color:var(--text-primary);background:var(--bg);display:flex;min-height:100vh;-webkit-font-smoothing:antialiased}
button{font-family:inherit;cursor:pointer;border:none;background:none}
input,select,textarea{font-family:inherit;font-size:inherit}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-thumb{background:var(--gray-200);border-radius:var(--r-full)}

/* â•â• SIDEBAR â•â• */
.sidebar{width:var(--sidebar);background:var(--gray-900);position:fixed;top:0;right:0;bottom:0;z-index:300;display:flex;flex-direction:column;transition:transform var(--t-slow)}
.sidebar-logo{height:var(--topbar);display:flex;align-items:center;gap:10px;padding:0 16px;border-bottom:1px solid rgba(255,255,255,.06);flex-shrink:0}
.logo-mark{width:30px;height:30px;border-radius:var(--r-md);background:linear-gradient(135deg,var(--amber-500),var(--orange-500));display:flex;align-items:center;justify-content:center;flex-shrink:0}
.logo-mark svg{width:16px;height:16px;stroke:#fff;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.logo-text{font-size:15px;font-weight:900;color:#fff;letter-spacing:-.3px}
.logo-text span{color:var(--amber-400)}

.sidebar-user{padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.06);flex-shrink:0}
.user-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.user-avatar{width:36px;height:36px;border-radius:var(--r-md);background:linear-gradient(135deg,var(--violet-600),var(--violet-500));display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:800;color:#fff;flex-shrink:0;letter-spacing:-.5px}
.user-name{font-size:12px;font-weight:700;color:#f9fafb;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.user-sub{font-size:10px;color:var(--gray-500);margin-top:1px}

/* Availability toggle */
.avail-row{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,.04);border-radius:var(--r-md);padding:7px 10px}
.avail-label{font-size:10px;font-weight:700;color:var(--gray-400)}
.avail-dot{width:6px;height:6px;border-radius:50%;margin-left:4px;display:inline-block;vertical-align:middle;transition:background var(--t-base)}
.toggle-pill{width:34px;height:18px;border-radius:var(--r-full);position:relative;cursor:pointer;transition:background var(--t-base);flex-shrink:0}
.toggle-pill.on{background:var(--emerald-600)}
.toggle-pill.off{background:var(--gray-700)}
.toggle-pill::after{content:'';position:absolute;top:2px;width:14px;height:14px;border-radius:50%;background:#fff;box-shadow:var(--shadow-sm);transition:right var(--t-base)}
.toggle-pill.on::after{right:2px}
.toggle-pill.off::after{right:18px}

/* Sidebar stats */
.sb-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:rgba(255,255,255,.06);border-top:1px solid rgba(255,255,255,.06);border-bottom:1px solid rgba(255,255,255,.06);flex-shrink:0}
.sb-stat{padding:10px 6px;text-align:center;background:var(--gray-900)}
.sb-stat-val{font-size:14px;font-weight:900;color:#fff;letter-spacing:-.3px}
.sb-stat-lbl{font-size:9px;color:var(--gray-600);margin-top:1px}

/* Nav */
.sidebar-nav{flex:1;overflow-y:auto;padding:8px;scrollbar-width:none}
.sidebar-nav::-webkit-scrollbar{display:none}
.nav-group-label{font-size:9px;font-weight:700;color:var(--gray-600);letter-spacing:.8px;text-transform:uppercase;padding:10px 10px 4px}
.nav-item{display:flex;align-items:center;gap:9px;padding:7px 10px;border-radius:var(--r-md);color:var(--gray-400);font-size:12px;font-weight:600;cursor:pointer;transition:background var(--t-fast),color var(--t-fast);margin-bottom:1px;position:relative;width:100%;text-align:right}
.nav-item:hover{background:rgba(255,255,255,.05);color:var(--gray-200)}
.nav-item.active{background:rgba(124,58,237,.15);color:var(--violet-300)}
.nav-item.active::after{content:'';position:absolute;right:0;top:20%;bottom:20%;width:2px;border-radius:var(--r-full);background:var(--violet-500)}
.nav-icon{width:28px;height:28px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.nav-icon svg{width:15px;height:15px;stroke:currentColor;fill:none;stroke-width:1.6;stroke-linecap:round;stroke-linejoin:round}
.nav-lbl{flex:1}
.nav-badge{font-size:9px;font-weight:800;padding:1px 6px;border-radius:var(--r-full);min-width:18px;text-align:center;flex-shrink:0}
.nb-violet{background:var(--violet-600);color:#fff}
.nb-amber{background:var(--amber-500);color:#fff}
.nb-red{background:var(--red-500);color:#fff}
.nb-emerald{background:var(--emerald-600);color:#fff}

.sidebar-bottom{padding:8px;border-top:1px solid rgba(255,255,255,.06);flex-shrink:0}
.sidebar-ver{text-align:center;font-size:9px;color:var(--gray-700);padding:6px 0 0}

/* â•â• MAIN â•â• */
.main{margin-right:var(--sidebar);flex:1;display:flex;flex-direction:column;min-height:100vh;max-width:calc(100vw - var(--sidebar))}
.topbar{height:var(--topbar);background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 20px;position:sticky;top:0;z-index:100;flex-shrink:0}
.breadcrumb{display:flex;align-items:center;gap:6px;font-size:12px}
.bc-root{color:var(--text-tertiary);font-weight:500}
.bc-sep{color:var(--gray-300)}
.bc-current{color:var(--text-primary);font-weight:700}
.topbar-right{display:flex;align-items:center;gap:6px}
.topbar-clock{font-size:11px;font-weight:700;color:var(--text-secondary);background:var(--gray-50);border:1px solid var(--border);padding:4px 10px;border-radius:var(--r-sm);font-variant-numeric:tabular-nums}
.icon-btn{width:32px;height:32px;border-radius:var(--r-md);border:1px solid var(--border);background:var(--surface);display:flex;align-items:center;justify-content:center;color:var(--text-secondary);cursor:pointer;transition:all var(--t-fast);position:relative}
.icon-btn:hover{background:var(--gray-50);color:var(--text-primary);border-color:var(--gray-300)}
.icon-btn svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:1.6;stroke-linecap:round;stroke-linejoin:round}
.notif-dot{position:absolute;top:4px;left:4px;width:6px;height:6px;border-radius:50%;background:var(--red-500);border:1.5px solid var(--surface)}

.page-content{padding:20px;flex:1}
.page-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px;gap:12px;flex-wrap:wrap}
.page-title{font-size:18px;font-weight:900;letter-spacing:-.3px;line-height:1.2}
.page-subtitle{font-size:12px;color:var(--text-secondary);margin-top:3px;font-weight:500}
.page-actions{display:flex;gap:8px;align-items:center;flex-shrink:0}

/* â•â• STATS â•â• */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:12px;margin-bottom:20px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);padding:16px;transition:box-shadow var(--t-base),transform var(--t-base)}
.stat-card:hover{box-shadow:var(--shadow-md);transform:translateY(-1px)}
.stat-card-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.stat-icon{width:36px;height:36px;border-radius:var(--r-md);display:flex;align-items:center;justify-content:center}
.stat-icon svg{width:16px;height:16px;stroke-width:1.6;stroke-linecap:round;stroke-linejoin:round}
.stat-val{font-size:24px;font-weight:900;letter-spacing:-.5px;line-height:1;margin-bottom:3px}
.stat-lbl{font-size:11px;color:var(--text-secondary);font-weight:500}
.stat-bar{height:2px;background:var(--gray-100);border-radius:var(--r-full);margin-top:12px;overflow:hidden}
.stat-bar-fill{height:100%;border-radius:var(--r-full);transition:width 1.2s cubic-bezier(.4,0,.2,1)}

/* â•â• WALLET CARD â•â• */
.wallet-hero{background:var(--gray-900);border-radius:var(--r-xl);padding:20px;margin-bottom:20px;position:relative;overflow:hidden}
.wallet-hero::before{content:'';position:absolute;top:-40px;left:-40px;width:180px;height:180px;border-radius:50%;background:rgba(124,58,237,.12)}
.wallet-hero::after{content:'';position:absolute;bottom:-30px;right:-20px;width:140px;height:140px;border-radius:50%;background:rgba(245,158,11,.08)}
.wallet-label{font-size:10px;font-weight:700;color:rgba(255,255,255,.35);letter-spacing:.8px;text-transform:uppercase;margin-bottom:6px}
.wallet-amount{font-size:32px;font-weight:900;color:#fff;letter-spacing:-.5px;line-height:1;margin-bottom:4px}
.wallet-sub{font-size:11px;color:rgba(255,255,255,.3)}
.wallet-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:16px}
.wallet-stat{background:rgba(255,255,255,.06);border-radius:var(--r-md);padding:10px 12px}
.wallet-stat-val{font-size:14px;font-weight:900;color:#fff;letter-spacing:-.3px}
.wallet-stat-lbl{font-size:9px;color:rgba(255,255,255,.3);margin-top:2px}

/* â•â• CARD â•â• */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);overflow:hidden;margin-bottom:16px}
.card-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.card-header-left{display:flex;align-items:center;gap:10px}
.card-icon{width:30px;height:30px;border-radius:var(--r-sm);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.card-icon svg{width:14px;height:14px;stroke-width:1.6;stroke-linecap:round;stroke-linejoin:round}
.card-title{font-size:13px;font-weight:800}
.card-sub{font-size:10px;color:var(--text-secondary);margin-top:1px}
.card-header-right{display:flex;gap:6px;align-items:center}
.card-body{padding:16px}

/* â•â• BUTTONS â•â• */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:7px 14px;border-radius:var(--r-md);font-size:12px;font-weight:700;line-height:1;cursor:pointer;border:none;transition:all var(--t-fast);white-space:nowrap;user-select:none}
.btn:active{transform:scale(.97)}
.btn svg{width:13px;height:13px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0}
.btn-primary{background:var(--violet-600);color:#fff}.btn-primary:hover{background:var(--violet-700)}
.btn-success{background:var(--emerald-600);color:#fff}.btn-success:hover{background:var(--emerald-700)}
.btn-danger{background:var(--red-500);color:#fff}.btn-danger:hover{background:var(--red-600)}
.btn-warning{background:var(--amber-500);color:#fff}.btn-warning:hover{background:var(--amber-600)}
.btn-info{background:var(--blue-500);color:#fff}.btn-info:hover{background:var(--blue-600)}
.btn-ghost{background:var(--surface);color:var(--text-primary);border:1px solid var(--border)}.btn-ghost:hover{background:var(--gray-50);border-color:var(--gray-300)}
.btn-subtle{background:var(--gray-100);color:var(--text-secondary)}.btn-subtle:hover{background:var(--gray-200);color:var(--text-primary)}
.btn-save{background:var(--amber-50);color:var(--amber-600);border:1px solid var(--amber-200)}.btn-save:hover{background:var(--amber-100)}
.btn-save.saved{background:var(--amber-500);color:#fff;border-color:var(--amber-500)}
.btn-sm{padding:5px 10px;font-size:11px;border-radius:var(--r-sm);gap:4px}
.btn-sm svg{width:12px;height:12px}
.btn-xs{padding:3px 8px;font-size:10px;border-radius:var(--r-sm);gap:3px}
.btn-xs svg{width:11px;height:11px}

/* â•â• BADGES â•â• */
.badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:var(--r-full);font-size:10px;font-weight:700;white-space:nowrap;border:1px solid transparent}
.badge::before{content:'';width:4px;height:4px;border-radius:50%;flex-shrink:0}
.badge-open{background:var(--emerald-50);color:var(--emerald-700);border-color:var(--emerald-200)}.badge-open::before{background:var(--emerald-500)}
.badge-progress{background:var(--blue-50);color:var(--blue-600);border-color:var(--blue-100)}.badge-progress::before{background:var(--blue-500)}
.badge-done{background:var(--violet-50);color:var(--violet-700);border-color:var(--violet-200)}.badge-done::before{background:var(--violet-600)}
.badge-pending{background:var(--amber-50);color:#92400e;border-color:var(--amber-200)}.badge-pending::before{background:var(--amber-500)}
.badge-rejected{background:var(--red-50);color:var(--red-600);border-color:var(--red-100)}.badge-rejected::before{background:var(--red-500)}
.badge-accepted{background:var(--emerald-50);color:var(--emerald-700);border-color:var(--emerald-200)}.badge-accepted::before{background:var(--emerald-500)}
.badge-new{background:var(--violet-600);color:#fff;border:none;font-size:9px;padding:2px 6px}

/* â•â• FILTER BAR â•â• */
.filter-bar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;align-items:center}
.search-box{flex:1;min-width:200px;display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:var(--r-md);padding:0 12px;transition:border-color var(--t-fast),box-shadow var(--t-fast)}
.search-box:focus-within{border-color:var(--gray-400);box-shadow:0 0 0 3px rgba(124,58,237,.06)}
.search-box svg{width:14px;height:14px;stroke:var(--text-tertiary);fill:none;stroke-width:1.6;flex-shrink:0;stroke-linecap:round;stroke-linejoin:round}
.search-box input{border:none;outline:none;background:transparent;font-size:12px;padding:8px 0;flex:1;color:var(--text-primary)}
.search-box input::placeholder{color:var(--text-tertiary)}
.filter-select{padding:7px 10px;border:1px solid var(--border);border-radius:var(--r-md);font-size:12px;font-weight:600;background:var(--surface);color:var(--text-primary);outline:none;cursor:pointer;transition:border-color var(--t-fast)}
.filter-select:focus{border-color:var(--gray-400)}

/* â•â• PROJECT CARD (Browse) â•â• */
.proj-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);padding:16px;margin-bottom:10px;transition:box-shadow var(--t-base),border-color var(--t-base);border-right:3px solid var(--emerald-500);position:relative}
.proj-card:hover{box-shadow:var(--shadow-md);border-color:var(--gray-300)}
.proj-card.saved-card{border-right-color:var(--amber-400)}
.proj-card.prog-card{border-right-color:var(--blue-500)}
.proj-card.done-card{border-right-color:var(--violet-600)}
.proj-num{font-size:9px;font-weight:800;color:var(--text-tertiary);letter-spacing:.5px;font-variant-numeric:tabular-nums;margin-bottom:3px}
.proj-title{font-size:14px;font-weight:800;color:var(--text-primary);line-height:1.3;letter-spacing:-.2px;margin-bottom:10px}
.proj-meta{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
.meta-chip{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:var(--r-full);background:var(--gray-50);border:1px solid var(--border);font-size:10px;font-weight:600;color:var(--text-secondary)}
.meta-chip svg{width:10px;height:10px;stroke:currentColor;fill:none;stroke-width:2;flex-shrink:0;stroke-linecap:round;stroke-linejoin:round}
.proj-desc{font-size:12px;color:var(--text-secondary);line-height:1.7;padding:10px 12px;background:var(--gray-50);border-radius:var(--r-md);border-right:2px solid var(--violet-200);margin-bottom:10px}
.proj-actions{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
.proj-new-tag{position:absolute;top:12px;left:12px}

/* â•â• BID CARD â•â• */
.bid-card{border:1px solid var(--border);border-radius:var(--r-md);padding:14px;margin-bottom:8px;background:var(--surface);transition:border-color var(--t-fast),box-shadow var(--t-fast)}
.bid-card:hover{border-color:var(--gray-300)}
.bid-card.acc{border-color:var(--emerald-200);background:var(--emerald-50)}
.bid-card.rej{opacity:.6;border-style:dashed}
.bid-card.pend{border-color:var(--violet-200)}
.bid-header{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:10px}
.bid-title{font-size:13px;font-weight:800;line-height:1.3}
.bid-num{font-size:9px;font-weight:700;color:var(--text-tertiary);font-variant-numeric:tabular-nums;margin-bottom:3px}
.bid-chips{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
.bid-chip{background:var(--gray-50);border:1px solid var(--border);border-radius:var(--r-sm);padding:4px 10px;font-size:11px}
.bid-chip strong{font-weight:800;color:var(--text-primary)}
.bid-chip span{color:var(--text-tertiary)}
.bid-note{font-size:11px;color:var(--text-secondary);background:var(--gray-50);padding:8px 10px;border-radius:var(--r-sm);line-height:1.7;border-right:2px solid var(--violet-200)}
.bid-footer{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}

/* â•â• BID SUBMIT FORM â•â• */
.bid-form{background:var(--gray-50);border:1px solid var(--border);border-radius:var(--r-md);padding:14px;margin-top:12px}
.bid-form-title{font-size:11px;font-weight:800;color:var(--violet-600);margin-bottom:12px;letter-spacing:.3px;text-transform:uppercase}

/* â•â• PROGRESS TRACKER â•â• */
.tracker{display:flex;align-items:flex-start;gap:0;margin:16px 0}
.tracker-step{flex:1;display:flex;flex-direction:column;align-items:center;position:relative}
.tracker-step:not(:last-child)::after{content:'';position:absolute;top:13px;left:-50%;right:50%;height:2px;background:var(--gray-200);z-index:0}
.tracker-step.done:not(:last-child)::after{background:var(--violet-600)}
.tracker-dot{width:26px;height:26px;border-radius:50%;border:2px solid var(--gray-200);background:var(--surface);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;z-index:1;transition:all var(--t-base)}
.tracker-step.done .tracker-dot{background:var(--violet-600);border-color:var(--violet-600);color:#fff}
.tracker-step.cur .tracker-dot{background:var(--surface);border-color:var(--violet-600);color:var(--violet-600);box-shadow:0 0 0 3px var(--violet-100)}
.tracker-lbl{font-size:9px;font-weight:600;color:var(--text-tertiary);margin-top:6px;text-align:center;white-space:nowrap}
.tracker-step.done .tracker-lbl{color:var(--violet-700);font-weight:700}
.tracker-step.cur .tracker-lbl{color:var(--violet-600);font-weight:800}

/* â•â• REVIEW CARD â•â• */
.rev-card{border:1px solid var(--border);border-radius:var(--r-md);padding:14px;margin-bottom:8px;background:var(--surface);transition:border-color var(--t-fast)}
.rev-card:hover{border-color:var(--gray-300)}
.rev-header{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:10px}
.rev-avatar{width:30px;height:30px;border-radius:var(--r-md);color:#fff;font-size:12px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.rev-name{font-size:12px;font-weight:700}
.rev-sub{font-size:10px;color:var(--text-tertiary);margin-top:1px}
.stars{letter-spacing:1px}
.star-on{color:var(--amber-400)}
.star-off{color:var(--gray-200)}
.rev-text{font-size:12px;color:var(--text-secondary);background:var(--gray-50);padding:10px 12px;border-radius:var(--r-md);line-height:1.7;border-right:2px solid var(--violet-200)}
.rev-admin-reply{background:var(--violet-50);border:1px solid var(--violet-100);border-radius:var(--r-md);padding:10px 12px;margin-top:8px}
.reply-label{font-size:9px;font-weight:800;color:var(--violet-600);margin-bottom:4px;text-transform:uppercase;letter-spacing:.4px}
.reply-text{font-size:11px;color:var(--violet-800);line-height:1.6}

/* â•â• NOTIF ITEM â•â• */
.notif-item{display:flex;gap:10px;padding:12px 0;border-bottom:1px solid var(--border-subtle);cursor:default;transition:background var(--t-fast)}
.notif-item:last-child{border-bottom:none}
.notif-item:hover{background:var(--gray-50);margin:0 -16px;padding:12px 16px}
.notif-item.unread .notif-body{font-weight:700;color:var(--text-primary)}
.notif-ic{width:36px;height:36px;border-radius:var(--r-md);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.notif-title{font-size:12px;font-weight:700;margin-bottom:2px}
.notif-body{font-size:11px;color:var(--text-secondary);line-height:1.5}
.notif-time{font-size:9px;color:var(--text-tertiary);margin-top:3px}
.unread-dot{width:6px;height:6px;border-radius:50%;background:var(--violet-600);flex-shrink:0;margin-top:5px}

/* â•â• PROFILE â•â• */
.profile-hero{background:var(--gray-900);border-radius:var(--r-xl);padding:20px;margin-bottom:16px;display:flex;align-items:center;gap:14px;flex-wrap:wrap}
.profile-avatar{width:56px;height:56px;border-radius:var(--r-lg);background:linear-gradient(135deg,var(--violet-600),var(--violet-500));color:#fff;font-size:22px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0;letter-spacing:-.5px}
.profile-name{font-size:16px;font-weight:900;color:#fff;letter-spacing:-.3px;margin-bottom:3px}
.profile-email{font-size:11px;color:rgba(255,255,255,.3)}
.profile-badges{display:flex;gap:5px;margin-top:8px;flex-wrap:wrap}
.pb{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:var(--r-full);font-size:10px;font-weight:700;border:1px solid}
.pb-none{background:rgba(255,255,255,.06);color:rgba(255,255,255,.3);border-color:rgba(255,255,255,.1)}
.pb-verified{background:var(--blue-50);color:var(--blue-600);border-color:var(--blue-100)}
.pb-star{background:var(--amber-50);color:var(--amber-600);border-color:var(--amber-200)}
.pb-partner{background:var(--violet-50);color:var(--violet-700);border-color:var(--violet-200)}
.pb-top{background:var(--emerald-50);color:var(--emerald-700);border-color:var(--emerald-200)}

/* â•â• INFO BLOCK â•â• */
.info-block{background:var(--gray-50);border-radius:var(--r-md);padding:12px;margin-bottom:10px;border:1px solid var(--border-subtle)}
.info-block-title{font-size:9px;font-weight:800;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px}
.info-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--border-subtle)}
.info-row:last-child{border-bottom:none}
.info-key{font-size:11px;color:var(--text-secondary)}
.info-val{font-size:11px;font-weight:700}

/* â•â• FORM â•â• */
.fg{display:flex;flex-direction:column;gap:5px;margin-bottom:12px}
.fl{font-size:11px;font-weight:700;color:var(--text-primary)}
.fl-hint{color:var(--text-tertiary);font-weight:500;margin-right:4px}
.fi{padding:8px 11px;border:1px solid var(--border);border-radius:var(--r-md);font-size:13px;outline:none;background:var(--surface);color:var(--text-primary);transition:border-color var(--t-fast),box-shadow var(--t-fast);width:100%}
.fi:focus{border-color:var(--gray-400);box-shadow:0 0 0 3px rgba(124,58,237,.07)}
.fi::placeholder{color:var(--text-tertiary)}
.fsel{padding:8px 11px;border:1px solid var(--border);border-radius:var(--r-md);font-size:13px;outline:none;background:var(--surface);cursor:pointer;width:100%}
.fsel:focus{border-color:var(--gray-400)}
.fta{padding:8px 11px;border:1px solid var(--border);border-radius:var(--r-md);font-size:13px;outline:none;resize:vertical;min-height:80px;transition:border-color var(--t-fast),box-shadow var(--t-fast);width:100%;color:var(--text-primary);line-height:1.6}
.fta:focus{border-color:var(--gray-400);box-shadow:0 0 0 3px rgba(124,58,237,.07)}
.f2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.fsec{font-size:10px;font-weight:800;color:var(--violet-600);padding:10px 0 6px;border-bottom:1px solid var(--violet-100);margin:4px 0 12px;letter-spacing:.5px;text-transform:uppercase}

/* â•â• SPECS â•â• */
.specs-wrap{border:1px solid var(--border);border-radius:var(--r-md);overflow:hidden}
.specs-head{padding:8px 12px;background:var(--gray-50);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.specs-head-lbl{font-size:11px;font-weight:700}
.specs-cnt-badge{font-size:10px;font-weight:700;color:var(--violet-600);background:var(--violet-50);padding:2px 8px;border-radius:var(--r-full);border:1px solid var(--violet-100)}
.specs-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;padding:8px;max-height:190px;overflow-y:auto}
.spec-item{display:flex;align-items:center;gap:6px;padding:6px 8px;border:1px solid var(--border);border-radius:var(--r-sm);cursor:pointer;transition:all var(--t-fast);background:var(--surface)}
.spec-item:hover{border-color:var(--gray-300);background:var(--gray-50)}
.spec-item.on{border-color:var(--violet-400);background:var(--violet-50)}
.spec-item input{width:12px;height:12px;accent-color:var(--violet-600);cursor:pointer;flex-shrink:0}
.spec-item label{font-size:11px;font-weight:600;cursor:pointer;color:var(--text-secondary);line-height:1.3}
.spec-item.on label{color:var(--violet-700);font-weight:700}

/* â•â• IMG UPLOAD â•â• */
.img-up{border:1.5px dashed var(--gray-300);border-radius:var(--r-md);padding:20px;text-align:center;cursor:pointer;transition:all var(--t-base);background:var(--gray-50);position:relative}
.img-up:hover{border-color:var(--violet-400);background:var(--violet-50)}
.img-up input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.img-up-ico{width:40px;height:40px;border-radius:var(--r-md);background:var(--violet-100);display:flex;align-items:center;justify-content:center;margin:0 auto 10px}
.img-up-ico svg{width:18px;height:18px;stroke:var(--violet-600);fill:none;stroke-width:1.6;stroke-linecap:round;stroke-linejoin:round}
.img-up-t{font-size:12px;font-weight:700;margin-bottom:3px}
.img-up-s{font-size:10px;color:var(--text-tertiary)}
.img-previews{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.img-prev{position:relative;width:72px;height:72px;border-radius:var(--r-md);overflow:hidden;border:1px solid var(--border)}
.img-prev img{width:100%;height:100%;object-fit:cover}
.img-prev-del{position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:var(--red-500);color:#fff;border:none;cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center;font-weight:800;line-height:1}

/* â•â• RATING STARS â•â• */
.rating-stars{display:flex;gap:4px;margin:8px 0}
.rating-star{font-size:28px;cursor:pointer;color:var(--gray-200);transition:color var(--t-fast);user-select:none;line-height:1}
.rating-star.active{color:var(--amber-400)}
.rating-star:hover{color:var(--amber-300)}

/* â•â• MODAL â•â• */
.overlay{display:none;position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.4);backdrop-filter:blur(6px);align-items:center;justify-content:center;padding:16px}
.overlay.visible{display:flex}
.modal{background:var(--surface);border-radius:var(--r-xl);width:100%;max-width:600px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-xl);animation:modalIn .2s cubic-bezier(.34,1.56,.64,1)}
@keyframes modalIn{from{opacity:0;transform:scale(.95) translateY(8px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal::-webkit-scrollbar{width:4px}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--surface);z-index:2;border-radius:var(--r-xl) var(--r-xl) 0 0}
.modal-header-left{display:flex;align-items:center;gap:10px}
.modal-ico{width:30px;height:30px;border-radius:var(--r-md);display:flex;align-items:center;justify-content:center}
.modal-ico svg{width:14px;height:14px;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round}
.modal-title{font-size:14px;font-weight:800;letter-spacing:-.2px}
.modal-close{width:28px;height:28px;border-radius:var(--r-md);background:var(--gray-100);display:flex;align-items:center;justify-content:center;color:var(--text-secondary);font-size:16px;line-height:1;cursor:pointer;transition:all var(--t-fast)}
.modal-close:hover{background:var(--red-100);color:var(--red-600)}
.modal-body{padding:18px}
.modal-footer{display:flex;gap:8px;justify-content:flex-end;padding:12px 18px;border-top:1px solid var(--border);background:var(--gray-50);border-radius:0 0 var(--r-xl) var(--r-xl)}

/* â•â• ALERT â•â• */
.alert{display:flex;align-items:flex-start;gap:10px;padding:10px 12px;border-radius:var(--r-md);margin-bottom:12px;font-size:12px;line-height:1.5}
.alert svg{width:14px;height:14px;flex-shrink:0;margin-top:1px;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round}
.alert-info{background:var(--blue-50);border:1px solid var(--blue-100);color:#1e40af}.alert-info svg{stroke:var(--blue-500)}
.alert-success{background:var(--emerald-50);border:1px solid var(--emerald-200);color:var(--emerald-700)}.alert-success svg{stroke:var(--emerald-500)}
.alert-warning{background:var(--orange-50);border:1px solid var(--orange-100);color:#9a3412}.alert-warning svg{stroke:var(--orange-500)}

/* â•â• TOAST â•â• */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(16px);background:var(--gray-900);color:#fff;padding:10px 18px;border-radius:var(--r-lg);font-size:12px;font-weight:600;z-index:9999;opacity:0;transition:all .2s cubic-bezier(.34,1.56,.64,1);pointer-events:none;display:flex;align-items:center;gap:8px;box-shadow:var(--shadow-xl);white-space:nowrap}
.toast.visible{opacity:1;transform:translateX(-50%) translateY(0)}
.toast-icon{width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;flex-shrink:0;background:rgba(255,255,255,.15)}
.toast-success{background:var(--emerald-600)}
.toast-error{background:var(--red-600)}
.toast-info{background:var(--gray-800)}

/* â•â• LOADING / EMPTY â•â• */
.loading-state{display:flex;flex-direction:column;align-items:center;padding:48px 20px;color:var(--text-tertiary)}
.spinner{width:28px;height:28px;border:2px solid var(--violet-100);border-top-color:var(--violet-600);border-radius:50%;animation:spin .7s linear infinite;margin-bottom:12px}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-size:12px;font-weight:600}
.empty-state{display:flex;flex-direction:column;align-items:center;padding:48px 20px;text-align:center}
.empty-icon{width:48px;height:48px;border-radius:var(--r-lg);background:var(--gray-100);border:1.5px dashed var(--gray-200);display:flex;align-items:center;justify-content:center;margin-bottom:12px}
.empty-icon svg{width:20px;height:20px;stroke:var(--gray-300);fill:none;stroke-width:1.5;stroke-linecap:round;stroke-linejoin:round}
.empty-title{font-size:13px;font-weight:700;margin-bottom:4px}
.empty-desc{font-size:11px;color:var(--text-secondary)}

/* â•â• TWO COL â•â• */
.two-col{display:grid;grid-template-columns:1.3fr 1fr;gap:16px}
.divider{height:1px;background:var(--border-subtle);margin:12px 0}

/* â•â• TABLE â•â• */
.table-wrap{overflow-x:auto}
.tbl{width:100%;border-collapse:collapse;min-width:560px}
.tbl th{text-align:right;padding:9px 14px;font-size:10px;font-weight:700;color:var(--text-secondary);background:var(--gray-50);border-bottom:1px solid var(--border);white-space:nowrap;text-transform:uppercase;letter-spacing:.3px}
.tbl td{padding:11px 14px;border-bottom:1px solid var(--border-subtle);vertical-align:middle}
.tbl tr:last-child td{border-bottom:none}
.tbl tbody tr{transition:background var(--t-fast)}
.tbl tbody tr:hover td{background:var(--gray-50)}

/* â•â• MOBILE â•â• */
.mob-trigger{display:none;position:fixed;top:10px;left:10px;z-index:400;width:36px;height:36px;border-radius:var(--r-md);background:var(--violet-600);border:none;cursor:pointer;align-items:center;justify-content:center;box-shadow:var(--shadow-md)}
.mob-trigger svg{width:16px;height:16px;stroke:#fff;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.mob-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:200}
@media(max-width:960px){
  .sidebar{transform:translateX(110%)}.sidebar.open{transform:translateX(0)}
  .main{margin-right:0}.mob-trigger{display:flex}.mob-overlay.active{display:block}
  .stats-grid{grid-template-columns:repeat(2,1fr)}
  .two-col{grid-template-columns:1fr}
  .page-content{padding:14px}.topbar{padding:0 14px}
  .f2{grid-template-columns:1fr}.specs-grid{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>

<button class="mob-trigger" onclick="openSb()">
  <svg viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
</button>
<div class="mob-overlay" id="mobOv" onclick="closeSb()"></div>

<!-- â•â• SIDEBAR â•â• -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    <div class="logo-mark"><svg viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg></div>
    <span class="logo-text">Ù…Ù†Ø§Ù‚ØµØ©<span>.</span></span>
  </div>

  <div class="sidebar-user">
    <div class="user-row">
      <div class="user-avatar" id="sbAvatar">Ù…</div>
      <div style="flex:1;min-width:0">
        <div class="user-name" id="sbName">Ø§Ù„Ù…Ø²ÙˆØ¯</div>
        <div class="user-sub" id="sbCity">Ù…Ø²ÙˆØ¯ Ø®Ø¯Ù…Ø©</div>
      </div>
    </div>
    <div class="avail-row">
      <div class="avail-label">
        <span class="avail-dot" id="availDot" style="background:var(--emerald-500)"></span>
        <span id="availLabel">Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù†</span>
      </div>
      <div class="toggle-pill on" id="availToggle" onclick="toggleAvailability()"></div>
    </div>
  </div>

  <div class="sb-stats">
    <div class="sb-stat"><div class="sb-stat-val" id="sbRating">â€”</div><div class="sb-stat-lbl">ØªÙ‚ÙŠÙŠÙ…ÙŠ</div></div>
    <div class="sb-stat"><div class="sb-stat-val" id="sbDone">0</div><div class="sb-stat-lbl">Ù…ÙƒØªÙ…Ù„</div></div>
    <div class="sb-stat"><div class="sb-stat-val" id="sbWin">â€”</div><div class="sb-stat-lbl">Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ²</div></div>
  </div>

  <nav class="sidebar-nav">
    <div class="nav-group-label">Ø¹Ø§Ù…</div>
    <button class="nav-item active" onclick="go('home',this)">
      <div class="nav-icon"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg></div>
      <span class="nav-lbl">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
    </button>

    <div class="nav-group-label">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</div>
    <button class="nav-item" onclick="go('browse',this)">
      <div class="nav-icon"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></div>
      <span class="nav-lbl">ØªØµÙØ­ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</span>
    </button>
    <button class="nav-item" onclick="go('saved',this)">
      <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/></svg></div>
      <span class="nav-lbl">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡ØªÙ…</span>
      <span class="nav-badge nb-amber" id="nbSaved" style="display:none">0</span>
    </button>
    <button class="nav-item" onclick="go('mybids',this)">
      <div class="nav-icon"><svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></div>
      <span class="nav-lbl">Ø¹Ø±ÙˆØ¶ÙŠ</span>
      <span class="nav-badge nb-violet" id="nbBids">0</span>
    </button>
    <button class="nav-item" onclick="go('active',this)">
      <div class="nav-icon"><svg viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></div>
      <span class="nav-lbl">Ù…Ø´Ø§Ø±ÙŠØ¹ÙŠ Ø§Ù„Ù†Ø´Ø·Ø©</span>
      <span class="nav-badge nb-emerald" id="nbActive" style="display:none">0</span>
    </button>
    <button class="nav-item" onclick="go('history',this)">
      <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div>
      <span class="nav-lbl">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…Ù„</span>
    </button>

    <div class="nav-group-label">Ø§Ù„ØªÙØ§Ø¹Ù„</div>
    <button class="nav-item" onclick="go('reviews',this)">
      <div class="nav-icon"><svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></div>
      <span class="nav-lbl">ØªÙ‚ÙŠÙŠÙ…Ø§ØªÙŠ</span>
    </button>
    <button class="nav-item" onclick="go('notifs',this)">
      <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg></div>
      <span class="nav-lbl">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span>
      <span class="nav-badge nb-red" id="nbNotifs" style="display:none">0</span>
    </button>

    <div class="nav-group-label">Ø§Ù„Ø­Ø³Ø§Ø¨</div>
    <button class="nav-item" onclick="go('wallet',this)">
      <div class="nav-icon"><svg viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg></div>
      <span class="nav-lbl">Ø§Ù„Ù…Ø­ÙØ¸Ø©</span>
    </button>
    <button class="nav-item" onclick="go('profile',this)">
      <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
      <span class="nav-lbl">Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</span>
    </button>
  </nav>

  <div class="sidebar-bottom">
    <button class="nav-item" onclick="logout()" style="width:100%;color:var(--red-400)">
      <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></div>
      <span class="nav-lbl">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
    </button>
    <div class="sidebar-ver">Ù…Ù†Ø§Ù‚ØµØ© Provider v3.0</div>
  </div>
</aside>

<!-- â•â• MAIN â•â• -->
<div class="main">
  <header class="topbar">
    <div class="breadcrumb">
      <span class="bc-root">Ù…Ù†Ø§Ù‚ØµØ©</span>
      <span class="bc-sep">/</span>
      <span class="bc-current" id="pageTitle">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
    </div>
    <div class="topbar-right">
      <div class="topbar-clock" id="clock">--:--:--</div>
      <button class="icon-btn" onclick="go('notifs',null)" title="Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª">
        <svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
        <div class="notif-dot" id="topNotifDot" style="display:none"></div>
      </button>
    </div>
  </header>

  <main class="page-content" id="pageContent">
    <div class="loading-state"><div class="spinner"></div><div class="loading-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</div></div>
  </main>
</div>

<!-- MODAL -->
<div class="overlay" id="overlay">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-header-left">
        <div class="modal-ico" id="mIco"></div>
        <span class="modal-title" id="mTitle">â€”</span>
      </div>
      <button class="modal-close" onclick="closeModal()">Ã—</button>
    </div>
    <div class="modal-body" id="mBody"></div>
    <div class="modal-footer" id="mFoot"></div>
  </div>
</div>

<div class="toast" id="toast">
  <div class="toast-icon" id="toastIco"></div>
  <span id="toastMsg"></span>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETUP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const API = 'https://manaqasati-production.up.railway.app';
const token = localStorage.getItem('token');
const me = JSON.parse(localStorage.getItem('user') || '{}');

if (!token || me.role !== 'provider') location.href = 'auth.html';

let savedIds = JSON.parse(localStorage.getItem('prov_saved') || '[]');
let allOpenReqs = [], myBidsData = [], myNotifsData = [], myRevsData = [];
let isAvail = true;
let uploadedImgs = {};
let ratingSelected = 0;

const CATS = ['ØªØ¨Ø±ÙŠØ¯ ÙˆØªÙƒÙŠÙŠÙ','ÙƒÙ‡Ø±Ø¨Ø§Ø¡','Ø³Ø¨Ø§ÙƒØ©','Ù†Ø¬Ø§Ø±Ø©','ØªÙ†Ø¸ÙŠÙ','Ù†Ù‚Ù„ Ø¹ÙØ´','Ø­Ø¯Ø§Ø¯Ø©','Ø£Ù„Ù…Ù†ÙŠÙˆÙ…','Ù…Ø³Ø§Ø¨Ø­','ÙƒØ§Ù…ÙŠØ±Ø§Øª Ù…Ø±Ø§Ù‚Ø¨Ø©','Ø´Ø¨ÙƒØ§Øª ÙˆØ¥Ù†ØªØ±Ù†Øª','Ù…Ø¸Ù„Ø§Øª ÙˆØ³ÙˆØ§ØªØ±','Ø¹Ø²Ù„ Ø­Ø±Ø§Ø±ÙŠ','Ø£Ø¨ÙˆØ§Ø¨','Ø¬Ø¨Ø³ ÙˆØ·Ø¨Ø§Ø´ÙŠØ±','Ù…ÙƒØ§ÙØ­Ø© Ø­Ø´Ø±Ø§Øª','Ø£Ø®Ø±Ù‰'];
const CITIES = ['Ø§Ù„Ø±ÙŠØ§Ø¶','Ø¬Ø¯Ø©','Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©','Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©','Ø§Ù„Ø¯Ù…Ø§Ù…','Ø§Ù„Ø®Ø¨Ø±','Ø§Ù„Ø¸Ù‡Ø±Ø§Ù†','Ø§Ù„Ø£Ø­Ø³Ø§Ø¡','Ø§Ù„Ø·Ø§Ø¦Ù','ØªØ¨ÙˆÙƒ','Ø¨Ø±ÙŠØ¯Ø©','Ø®Ù…ÙŠØ³ Ù…Ø´ÙŠØ·','Ø£Ø¨Ù‡Ø§','Ù†Ø¬Ø±Ø§Ù†','Ø¬ÙŠØ²Ø§Ù†','Ø­Ø§Ø¦Ù„','ÙŠÙ†Ø¨Ø¹','Ø§Ù„Ø¬Ø¨ÙŠÙ„','Ø§Ù„Ù‚Ø·ÙŠÙ','Ø³ÙƒØ§ÙƒØ§','Ø¹Ø±Ø¹Ø±','Ø§Ù„Ø¨Ø§Ø­Ø©','Ø§Ù„Ø±Ø³','Ø±Ø§Ø¨Øº','Ø¨ÙŠØ´Ø©','ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¯ÙˆØ§Ø³Ø±','Ø§Ù„Ø²Ù„ÙÙŠ','Ø§Ù„Ù‚Ø±ÙŠØ§Øª'];
const AV_COLORS = ['#7c3aed','#2563eb','#059669','#d97706','#dc2626','#0891b2','#7e22ce','#b45309'];
const BADGE_MAP = {none:{cls:'pb-none',label:'Ø¨Ø¯ÙˆÙ† ÙˆØ³Ø§Ù…',icon:'â€”'},verified:{cls:'pb-verified',label:'Ù…ÙˆØ«Ù‚',icon:'âœ“'},star:{cls:'pb-star',label:'Ù…ØªÙ…ÙŠØ²',icon:'â­'},partner:{cls:'pb-partner',label:'Ø´Ø±ÙŠÙƒ',icon:'ğŸ’'},top:{cls:'pb-top',label:'Ø§Ù„Ø£ÙØ¶Ù„',icon:'ğŸ†'}};

/* Init UI */
document.getElementById('sbName').textContent = me.name || 'Ø§Ù„Ù…Ø²ÙˆØ¯';
document.getElementById('sbAvatar').textContent = (me.name || 'Ù…')[0];
if (me.city) document.getElementById('sbCity').textContent = 'ğŸ“ ' + me.city;
setInterval(() => { document.getElementById('clock').textContent = new Date().toLocaleTimeString('ar-SA',{hour12:false}); }, 1000);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function api(path, opts = {}) {
  try {
    const r = await fetch(API + path, {
      headers: {'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json'},
      ...opts
    });
    return await r.json();
  } catch { return {}; }
}

let toastTimer;
function toast(msg, type = 'info') {
  const el = document.getElementById('toast');
  el.className = `toast toast-${type}`;
  document.getElementById('toastIco').textContent = type==='success'?'âœ“':type==='error'?'âœ•':'i';
  document.getElementById('toastMsg').textContent = msg;
  el.classList.add('visible');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('visible'), 3200);
}

function openModal(title, body, footer, icoSvg, icoBg = 'var(--violet-100)') {
  document.getElementById('mTitle').textContent = title;
  document.getElementById('mBody').innerHTML = body;
  document.getElementById('mFoot').innerHTML = footer || '';
  const ic = document.getElementById('mIco');
  ic.innerHTML = icoSvg || '';
  ic.style.background = icoBg;
  if (icoSvg) {
    const s = ic.querySelector('svg');
    if (s) { s.style.cssText = 'width:14px;height:14px;stroke-width:1.8;fill:none;stroke-linecap:round;stroke-linejoin:round'; }
  }
  document.getElementById('overlay').classList.add('visible');
}
function closeModal() { document.getElementById('overlay').classList.remove('visible'); }

function setContent(html) { document.getElementById('pageContent').innerHTML = html; }
function loading() { setContent(`<div class="loading-state"><div class="spinner"></div><div class="loading-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</div></div>`); }

function openSb() { document.getElementById('sidebar').classList.add('open'); document.getElementById('mobOv').classList.add('active'); }
function closeSb() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('mobOv').classList.remove('active'); }
function logout() { localStorage.clear(); location.href = 'auth.html'; }

function go(page, btn) {
  document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
  if (btn) btn.classList.add('active');
  const titles = {home:'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',browse:'ØªØµÙØ­ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹',saved:'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡ØªÙ…',mybids:'Ø¹Ø±ÙˆØ¶ÙŠ',active:'Ù…Ø´Ø§Ø±ÙŠØ¹ÙŠ Ø§Ù„Ù†Ø´Ø·Ø©',history:'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…Ù„',reviews:'ØªÙ‚ÙŠÙŠÙ…Ø§ØªÙŠ',notifs:'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª',wallet:'Ø§Ù„Ù…Ø­ÙØ¸Ø©',profile:'Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ'};
  document.getElementById('pageTitle').textContent = titles[page] || page;
  const pages = {home:pgHome,browse:pgBrowse,saved:pgSaved,mybids:pgMyBids,active:pgActive,history:pgHistory,reviews:pgReviews,notifs:pgNotifs,wallet:pgWallet,profile:pgProfile};
  if (pages[page]) pages[page]();
  closeSb();
}

/* â•â• SVG shortcuts â•â• */
const I = {
  send: `<line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>`,
  star: `<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>`,
  check: `<polyline points="20 6 9 17 4 12"/>`,
  eye: `<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>`,
  edit: `<path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>`,
  trash: `<polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/>`,
  bookmark: `<path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/>`,
  map: `<path d="M21 10c0 7-9 13-9 13S3 17 3 10a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/>`,
  folder: `<path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/>`,
  dollar: `<line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>`,
  zap: `<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>`,
  bell: `<path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/>`,
  user: `<path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/>`,
  img: `<rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/>`,
  calendar: `<rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>`,
  phone: `<path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 8.8a19.79 19.79 0 01-3.07-8.63A2 2 0 012 0h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L6.09 7.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 14.92z"/>`,
  alert: `<path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>`,
};

function svg(paths, color) {
  return `<svg viewBox="0 0 24 24" fill="none" stroke="${color||'currentColor'}" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">${paths}</svg>`;
}

/* â•â• HELPERS â•â• */
function avColor(id) { return AV_COLORS[(id||0) % AV_COLORS.length]; }
function avLetter(name) { return (name||'ØŸ')[0]; }
function starsHtml(n) {
  return [1,2,3,4,5].map(i => `<span class="${i<=Math.round(n)?'star-on':'star-off'}">â˜…</span>`).join('');
}
function fdate(d) { return d ? new Date(d).toLocaleDateString('ar-SA') : 'â€”'; }
function fprice(p) { return p ? Number(p).toLocaleString('ar-SA') + ' Ø±.Ø³' : 'â€”'; }
function isNew(d) { return d && (Date.now() - new Date(d).getTime()) < 86400000; }

function cityOpts(sel = '') {
  return `<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>` +
    CITIES.map(c => `<option value="${c}" ${c===sel?'selected':''}>${c}</option>`).join('');
}

function specsHtml(sel = []) {
  return `<div class="specs-wrap">
    <div class="specs-head">
      <span class="specs-head-lbl">Ø§Ù„ØªØ®ØµØµØ§Øª</span>
      <span class="specs-cnt-badge" id="specCnt">${sel.length} Ù…Ø­Ø¯Ø¯</span>
    </div>
    <div class="specs-grid">
      ${CATS.map((c,i) => {
        const on = sel.includes(c);
        return `<div class="spec-item${on?' on':''}" onclick="togSpec(this)">
          <input type="checkbox" id="sp${i}" value="${c}" ${on?'checked':''} onchange="updSpec()">
          <label for="sp${i}">${c}</label>
        </div>`;
      }).join('')}
    </div>
  </div>`;
}
function togSpec(el) { el.classList.toggle('on'); el.querySelector('input').checked = el.classList.contains('on'); updSpec(); }
function updSpec() { const c = document.querySelectorAll('.spec-item.on').length; const el = document.getElementById('specCnt'); if(el) el.textContent = `${c} Ù…Ø­Ø¯Ø¯`; }
function getSpecs() { return [...document.querySelectorAll('.spec-item.on input')].map(i => i.value); }

function imgUpHtml(id) {
  return `<div class="img-up">
    <input type="file" accept="image/*" multiple onchange="handleImgs(this,'${id}')">
    <div class="img-up-ico">${svg(I.img,'var(--violet-600)')}</div>
    <div class="img-up-t">Ø§Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ± Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„Ø±ÙØ¹</div>
    <div class="img-up-s">PNG, JPG â€” Ø­ØªÙ‰ 5 ØµÙˆØ±</div>
  </div>
  <div class="img-previews" id="imgPv_${id}"></div>`;
}
function handleImgs(input, id) {
  const files = [...input.files];
  if (!uploadedImgs[id]) uploadedImgs[id] = [];
  files.forEach(f => {
    if (uploadedImgs[id].length >= 5) return;
    const r = new FileReader();
    r.onload = e => { uploadedImgs[id].push(e.target.result); renderImgPv(id); };
    r.readAsDataURL(f);
  });
}
function renderImgPv(id) {
  const el = document.getElementById(`imgPv_${id}`);
  if (!el) return;
  el.innerHTML = (uploadedImgs[id]||[]).map((src,i) =>
    `<div class="img-prev"><img src="${src}"><button class="img-prev-del" onclick="delImg('${id}',${i})">Ã—</button></div>`
  ).join('');
}
function delImg(id, i) { uploadedImgs[id].splice(i,1); renderImgPv(id); }

/* â•â• SAVED LIST â•â• */
function savedIncl(id) { return savedIds.includes(id); }
function savePersist() { localStorage.setItem('prov_saved', JSON.stringify(savedIds)); }
function toggleSave(id, btn) {
  const idx = savedIds.indexOf(id);
  if (idx > -1) {
    savedIds.splice(idx, 1);
    api(`/api/saved/${id}`, {method:'DELETE'});
    if (btn) { btn.className = 'btn btn-save btn-sm'; btn.textContent = 'ğŸ”– Ø§Ù‡ØªÙ…'; }
    toast('Ø£ÙØ²ÙŠÙ„ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡ØªÙ…', 'info');
  } else {
    savedIds.push(id);
    api(`/api/saved/${id}`, {method:'POST'});
    if (btn) { btn.className = 'btn btn-save saved btn-sm'; btn.textContent = 'âœ“ Ù…Ù‡ØªÙ…'; }
    toast('Ø£ÙØ¶ÙŠÙ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡ØªÙ… âœ…', 'success');
  }
  savePersist();
  const nb = document.getElementById('nbSaved');
  if (nb) { nb.style.display = savedIds.length ? '' : 'none'; nb.textContent = savedIds.length; }
}

/* â•â• AVAILABILITY â•â• */
function toggleAvailability() {
  isAvail = !isAvail;
  const tog = document.getElementById('availToggle');
  const dot = document.getElementById('availDot');
  const lbl = document.getElementById('availLabel');
  tog.className = 'toggle-pill ' + (isAvail ? 'on' : 'off');
  dot.style.background = isAvail ? 'var(--emerald-500)' : 'var(--gray-500)';
  lbl.textContent = isAvail ? 'Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù†' : 'ØºÙŠØ± Ù…ØªØ§Ø­';
  api('/api/provider/availability', {method:'PUT', body:JSON.stringify({available:isAvail})});
  toast(isAvail ? 'Ø£Ù†Øª Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù† ğŸŸ¢' : 'ÙˆØ¶Ø¹Øª Ø­Ø§Ù„ØªÙƒ ÙƒØºÙŠØ± Ù…ØªØ§Ø­ âš«', 'info');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOME PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function pgHome() {
  loading();
  const [stats, open] = await Promise.all([
    api('/api/provider/stats'),
    api('/api/requests?status=open')
  ]);
  const s = stats || {};
  allOpenReqs = open || [];
  const winRate = s.total_bids ? Math.round((s.won_bids||0)/s.total_bids*100) : 0;

  // Update sidebar stats
  document.getElementById('sbRating').textContent = s.avg_rating ? Number(s.avg_rating).toFixed(1)+'â˜…' : 'â€”';
  document.getElementById('sbDone').textContent = s.completed || 0;
  document.getElementById('sbWin').textContent = winRate + '%';

  setContent(`
    <div class="page-header">
      <div>
        <div class="page-title">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${me.name||'Ù…Ø²ÙˆØ¯Ù†Ø§'} ğŸ‘‹</div>
        <div class="page-subtitle">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø£Ø¯Ø§Ø¦Ùƒ ÙÙŠ Ø§Ù„Ù…Ù†ØµØ©</div>
      </div>
      <div class="page-actions">
        <button class="btn btn-primary" onclick="go('browse',null)">
          ${svg('<circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>')}
          ØªØµÙØ­ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
        </button>
      </div>
    </div>

    <div class="stats-grid">
      ${sc('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±ÙˆØ¶', s.total_bids||0, '#7c3aed','var(--violet-100)', I.send, 100, 'var(--violet-600)')}
      ${sc('Ø¹Ø±ÙˆØ¶ Ù…Ù‚Ø¨ÙˆÙ„Ø©', s.won_bids||0, 'var(--emerald-600)','var(--emerald-100)', I.check, winRate, 'var(--emerald-600)')}
      ${sc('Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…ÙƒØªÙ…Ù„Ø©', s.completed||0, 'var(--blue-600)','var(--blue-100)', I.zap, s.total_bids?Math.round((s.completed||0)/s.total_bids*100):0, 'var(--blue-500)')}
      ${sc('Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…', s.avg_rating?Number(s.avg_rating).toFixed(1):0, 'var(--amber-600)','var(--amber-50)', I.star, (s.avg_rating||0)*20, 'var(--amber-500)')}
      ${sc('Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°', s.active||0, 'var(--orange-500)','var(--orange-50)', I.zap, 100, 'var(--orange-500)')}
      ${sc('Ù…Ø­ÙÙˆØ¸', savedIds.length, 'var(--amber-600)','var(--amber-50)', I.bookmark, 100, 'var(--amber-500)')}
    </div>

    <div class="two-col">
      <div class="card">
        <div class="card-header">
          <div class="card-header-left">
            <div class="card-icon" style="background:var(--emerald-100)">${svg(I.eye,'var(--emerald-600)')}</div>
            <div>
              <div class="card-title">Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…ØªØ§Ø­Ø©</div>
              <div class="card-sub">Ù…ÙØªÙˆØ­Ø© Ù„Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø¢Ù†</div>
            </div>
          </div>
          <button class="btn btn-subtle btn-sm" onclick="go('browse',null)">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
        </div>
        <div class="card-body">
          ${allOpenReqs.slice(0,5).map(r => {
            const sv = savedIncl(r.id);
            return `<div style="display:flex;align-items:flex-start;gap:10px;padding:10px 0;border-bottom:1px solid var(--border-subtle)">
              <div style="flex:1;min-width:0">
                <div style="font-size:12px;font-weight:800;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${r.title}</div>
                <div style="display:flex;gap:4px;flex-wrap:wrap">
                  <span class="meta-chip">${svg(I.map)} ${r.city||'â€”'}</span>
                  <span class="meta-chip">${svg(I.folder)} ${r.category||'Ø¹Ø§Ù…'}</span>
                  ${r.budget_max?`<span class="meta-chip">${svg(I.dollar)} ${Number(r.budget_max).toLocaleString()}</span>`:''}
                </div>
              </div>
              <div style="display:flex;gap:4px;flex-shrink:0">
                <button class="btn btn-save ${sv?'saved':''} btn-xs" onclick="toggleSave(${r.id},this)">${sv?'âœ“':'ğŸ”–'}</button>
                <button class="btn btn-primary btn-xs" onclick="bidModal(${r.id},'${r.title.replace(/'/g,'')}')">Ø¹Ø±Ø¶</button>
              </div>
            </div>`;
          }).join('') || `<div class="empty-state"><div class="empty-desc">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…ØªØ§Ø­Ø©</div></div>`}
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-header-left">
            <div class="card-icon" style="background:var(--blue-100)">${svg(I.send,'var(--blue-600)')}</div>
            <div class="card-title">Ø¢Ø®Ø± Ø¹Ø±ÙˆØ¶ÙŠ</div>
          </div>
          <button class="btn btn-subtle btn-sm" onclick="go('mybids',null)">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
        </div>
        <div class="card-body" id="homeBids">
          <div class="loading-state" style="padding:20px"><div class="spinner"></div></div>
        </div>
      </div>
    </div>
  `);

  // Load recent bids
  const bids = await api('/api/my-bids');
  myBidsData = bids || [];
  const hb = document.getElementById('homeBids');
  if (hb) {
    const bClr = {pending:'badge-pending',accepted:'badge-accepted',rejected:'badge-rejected'};
    const bLbl = {pending:'Ø¨Ø§Ù†ØªØ¸Ø§Ø±',accepted:'Ù…Ù‚Ø¨ÙˆÙ„',rejected:'Ù…Ø±ÙÙˆØ¶'};
    hb.innerHTML = myBidsData.slice(0,6).map(b =>
      `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-subtle)">
        <div style="font-size:11px;font-weight:700;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${b.request_title||'Ù…Ø´Ø±ÙˆØ¹ #'+b.request_id}</div>
        <span class="badge ${bClr[b.status]||'badge-pending'}">${bLbl[b.status]||'Ø¨Ø§Ù†ØªØ¸Ø§Ø±'}</span>
      </div>`
    ).join('') || `<div class="empty-state" style="padding:20px"><div class="empty-desc">Ù„Ù… ØªÙ‚Ø¯Ù… Ø£ÙŠ Ø¹Ø±Ø¶ Ø¨Ø¹Ø¯</div></div>`;
  }

  // Update nav badge
  document.getElementById('nbBids').textContent = myBidsData.length;
}

function sc(lbl, val, ic, ibg, ipath, pct, bclr) {
  return `<div class="stat-card">
    <div class="stat-card-top">
      <div class="stat-icon" style="background:${ibg}">${svg(ipath, ic)}</div>
    </div>
    <div class="stat-val">${val}</div>
    <div class="stat-lbl">${lbl}</div>
    <div class="stat-bar"><div class="stat-bar-fill" style="width:${Math.min(pct,100)}%;background:${bclr}"></div></div>
  </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BROWSE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function pgBrowse() {
  loading();
  const data = await api('/api/requests?status=open');
  allOpenReqs = data || [];

  setContent(`
    <div class="page-header">
      <div>
        <div class="page-title">ØªØµÙØ­ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</div>
        <div class="page-subtitle">${allOpenReqs.length} Ù…Ø´Ø±ÙˆØ¹ Ù…ØªØ§Ø­ Ù„Ù„Ø¹Ø±ÙˆØ¶</div>
      </div>
    </div>
    <div class="card">
      <div class="card-body">
        <div class="filter-bar">
          <div class="search-box">
            <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input type="text" id="bQ" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø§Ù„ØªÙØ§ØµÙŠÙ„â€¦" oninput="filterBrowse()">
          </div>
          <select class="filter-select" id="bCat" onchange="filterBrowse()">
            <option value="">ÙƒÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</option>
            ${CATS.map(c=>`<option value="${c}">${c}</option>`).join('')}
          </select>
          <select class="filter-select" id="bCity" onchange="filterBrowse()">
            <option value="">ÙƒÙ„ Ø§Ù„Ù…Ø¯Ù†</option>
            ${CITIES.map(c=>`<option value="${c}">${c}</option>`).join('')}
          </select>
          <select class="filter-select" id="bSort" onchange="filterBrowse()">
            <option value="new">Ø§Ù„Ø£Ø­Ø¯Ø«</option>
            <option value="budget">Ø£Ø¹Ù„Ù‰ Ù…ÙŠØ²Ø§Ù†ÙŠØ©</option>
            <option value="bids">Ø£Ù‚Ù„ Ø¹Ø±ÙˆØ¶</option>
          </select>
        </div>
        <div id="browseList">${renderBrowse(allOpenReqs)}</div>
      </div>
    </div>
  `);
}

function filterBrowse() {
  const q = (document.getElementById('bQ')?.value||'').toLowerCase();
  const cat = document.getElementById('bCat')?.value||'';
  const city = document.getElementById('bCity')?.value||'';
  const sort = document.getElementById('bSort')?.value||'new';
  let f = allOpenReqs.filter(r =>
    (!q || r.title.toLowerCase().includes(q)||(r.description||'').toLowerCase().includes(q)) &&
    (!cat || r.category===cat) && (!city || r.city===city)
  );
  if (sort==='budget') f.sort((a,b)=>(b.budget_max||0)-(a.budget_max||0));
  else if (sort==='bids') f.sort((a,b)=>(a.bid_count||0)-(b.bid_count||0));
  const el = document.getElementById('browseList');
  if (el) el.innerHTML = renderBrowse(f);
}

function renderBrowse(list) {
  if (!list.length) return `<div class="empty-state"><div class="empty-icon"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></div><div class="empty-title">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div><div class="empty-desc">Ø¬Ø±Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø§Ù„ÙÙ„Ø§ØªØ±</div></div>`;
  return list.map(r => {
    const sv = savedIncl(r.id);
    const newTag = isNew(r.created_at) ? `<span class="badge badge-new proj-new-tag">Ø¬Ø¯ÙŠØ¯ âœ¨</span>` : '';
    return `<div class="proj-card" style="position:relative">
      ${newTag}
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:10px">
        <div>
          <div class="proj-num">${r.project_number||'#'+r.id}</div>
          <div class="proj-title">${r.title}</div>
        </div>
        <span class="badge badge-open" style="flex-shrink:0">Ù…ÙØªÙˆØ­</span>
      </div>
      <div class="proj-meta">
        <span class="meta-chip">${svg(I.map)} ${r.city||'â€”'}</span>
        <span class="meta-chip">${svg(I.folder)} ${r.category||'Ø¹Ø§Ù…'}</span>
        ${r.budget_max?`<span class="meta-chip">${svg(I.dollar)} Ø­ØªÙ‰ ${Number(r.budget_max).toLocaleString()} Ø±.Ø³</span>`:''}
        ${r.deadline?`<span class="meta-chip">${svg(I.calendar)} ${r.deadline}</span>`:''}
        <span class="meta-chip">${svg(I.user)} ${r.bid_count||0} Ø¹Ø±Ø¶</span>
      </div>
      ${r.description?`<div class="proj-desc">${r.description.slice(0,200)}${r.description.length>200?'â€¦':''}</div>`:''}
      <div class="proj-actions">
        <button class="btn btn-primary btn-sm" onclick="bidModal(${r.id},'${r.title.replace(/'/g,'')}')">
          ${svg(I.send)} ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±Ø¶
        </button>
        <button class="btn btn-save ${sv?'saved':''} btn-sm" onclick="toggleSave(${r.id},this)">
          ${sv?'âœ“ Ù…Ù‡ØªÙ…':'ğŸ”– Ø§Ù‡ØªÙ…'}
        </button>
        <button class="btn btn-subtle btn-sm" onclick="viewReqModal(${r.id})">
          ${svg(I.eye)} Ø§Ù„ØªÙØ§ØµÙŠÙ„
        </button>
      </div>
    </div>`;
  }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BID MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function bidModal(reqId, title) {
  openModal(`ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±Ø¶ â€” ${title}`,
    `<div class="alert alert-info">${svg('<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>')}Ø³ÙŠØµÙ„Ùƒ Ø¥Ø´Ø¹Ø§Ø± ÙÙˆØ± Ø±Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù„Ù‰ Ø¹Ø±Ø¶Ùƒ</div>
     <div class="f2">
       <div class="fg"><label class="fl">Ø³Ø¹Ø±Ùƒ Ø§Ù„Ù…Ù‚ØªØ±Ø­ (Ø±.Ø³) <span class="fl-hint">*</span></label><input type="number" class="fi" id="bPrice" placeholder="Ø§Ø¯Ø®Ù„ Ø³Ø¹Ø±Ùƒ Ø§Ù„ØªÙ†Ø§ÙØ³ÙŠ" min="1"></div>
       <div class="fg"><label class="fl">Ù…Ø¯Ø© Ø§Ù„ØªÙ†ÙÙŠØ° (Ø£ÙŠØ§Ù…) <span class="fl-hint">*</span></label><input type="number" class="fi" id="bDays" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…" min="1"></div>
     </div>
     <div class="fg"><label class="fl">Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ ÙˆÙ…Ø¤Ù‡Ù„Ø§ØªÙƒ</label><textarea class="fta" id="bNote" style="min-height:110px" placeholder="Ø§Ø´Ø±Ø­ Ù„Ù…Ø§Ø°Ø§ Ø£Ù†Øª Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙØ¶Ù„. Ø§Ø°ÙƒØ± Ø®Ø¨Ø±Ø§ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙˆØ£Ø¹Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…Ø´Ø§Ø¨Ù‡Ø©â€¦"></textarea></div>`,
    `<button class="btn btn-ghost" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
     <button class="btn btn-primary" onclick="submitBid(${reqId})">${svg(I.send)} Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶</button>`,
    `<svg viewBox="0 0 24 24" stroke="var(--violet-600)">${I.send}</svg>`, 'var(--violet-100)'
  );
}

async function submitBid(reqId) {
  const price = document.getElementById('bPrice')?.value;
  const days = document.getElementById('bDays')?.value;
  const note = document.getElementById('bNote')?.value;
  if (!price || !days) { toast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ù…Ø¯Ø©', 'error'); return; }
  const res = await api('/api/bids', {method:'POST', body:JSON.stringify({request_id:reqId, price:parseFloat(price), days:parseInt(days), note})});
  if (res.message && !res.id) { toast(res.message, 'error'); return; }
  closeModal();
  toast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶Ùƒ Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
  const nb = document.getElementById('nbBids');
  if (nb) nb.textContent = parseInt(nb.textContent||0) + 1;
}

async function viewReqModal(id) {
  const r = await api(`/api/requests/${id}`);
  const sv = savedIncl(r.id);
  openModal('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹',
    `<div style="background:var(--gray-900);border-radius:var(--r-lg);padding:16px;margin-bottom:14px">
       <div style="font-size:9px;font-weight:800;color:rgba(255,255,255,.3);letter-spacing:1px;margin-bottom:4px">${r.project_number||'#'+r.id}</div>
       <div style="font-size:15px;font-weight:900;color:#fff;margin-bottom:10px;line-height:1.3">${r.title}</div>
       <div style="display:flex;gap:5px;flex-wrap:wrap">
         <span class="badge badge-open">Ù…ÙØªÙˆØ­</span>
         <span style="font-size:10px;color:rgba(255,255,255,.35);background:rgba(255,255,255,.07);padding:2px 9px;border-radius:var(--r-full)">${r.category||'â€”'}</span>
         ${r.city?`<span style="font-size:10px;color:rgba(255,255,255,.35);background:rgba(255,255,255,.07);padding:2px 9px;border-radius:var(--r-full)">ğŸ“ ${r.city}</span>`:''}
       </div>
     </div>
     <div class="info-block">
       <div class="info-block-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</div>
       <div class="info-row"><span class="info-key">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù‚ØµÙˆÙ‰</span><span class="info-val" style="color:var(--emerald-600)">${fprice(r.budget_max)}</span></div>
       <div class="info-row"><span class="info-key">Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</span><span class="info-val">${r.deadline||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span></div>
       <div class="info-row"><span class="info-key">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</span><span class="info-val">${r.city||'â€”'}</span></div>
       ${r.address?`<div class="info-row"><span class="info-key">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</span><span class="info-val">${r.address}</span></div>`:''}
       <div class="info-row"><span class="info-key">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©</span><span class="info-val">${r.bid_count||0} Ø¹Ø±Ø¶</span></div>
     </div>
     ${r.description?`<div class="info-block"><div class="info-block-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</div><div style="font-size:12px;line-height:1.8;color:var(--text-secondary)">${r.description}</div></div>`:''}`,
    `${r.status==='open'?`<button class="btn btn-save ${sv?'saved':''} btn-sm" onclick="toggleSave(${r.id},this)">${sv?'âœ“ Ù…Ù‡ØªÙ…':'ğŸ”– Ø§Ù‡ØªÙ…'}</button><button class="btn btn-primary" onclick="closeModal();bidModal(${r.id},'${(r.title||'').replace(/'/g,'')}')">ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±Ø¶</button>`:''}
     <button class="btn btn-ghost" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>`,
    `<svg viewBox="0 0 24 24" stroke="var(--violet-600)">${I.eye}</svg>`, 'var(--violet-100)'
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SAVED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function pgSaved() {
  loading();
  const data = await api('/api/saved');
  const saved = data || [];
  savedIds = saved.map(x => x.id);
  savePersist();
  const nb = document.getElementById('nbSaved');
  if (nb) { nb.style.display = savedIds.length ? '' : 'none'; nb.textContent = savedIds.length; }

  setContent(`
    <div class="page-header">
      <div>
        <div class="page-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡ØªÙ…</div>
        <div class="page-subtitle">${saved.length} Ù…Ø´Ø±ÙˆØ¹ Ù…Ø­ÙÙˆØ¸</div>
      </div>
      ${saved.length?`<div class="page-actions"><button class="btn btn-subtle btn-sm" onclick="clearSaved()">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button></div>`:''}
    </div>
    <div class="card">
      <div class="card-body">
        ${saved.length ? saved.map(r => {
          return `<div class="proj-card saved-card">
            <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:10px">
              <div>
                <div class="proj-num">${r.project_number||'#'+r.id}</div>
                <div class="proj-title">${r.title}</div>
              </div>
              <span class="badge ${r.status==='open'?'badge-open':'badge-pending'}">${r.status==='open'?'Ù…ÙØªÙˆØ­':'Ù…Ø¹Ù„Ù‚'}</span>
            </div>
            <div class="proj-meta">
              <span class="meta-chip">${svg(I.map)} ${r.city||'â€”'}</span>
              <span class="meta-chip">${svg(I.folder)} ${r.category||'Ø¹Ø§Ù…'}</span>
              ${r.budget_max?`<span class="meta-chip">${svg(I.dollar)} Ø­ØªÙ‰ ${Number(r.budget_max).toLocaleString()} Ø±.Ø³</span>`:''}
            </div>
            ${r.description?`<div class="proj-desc">${r.description.slice(0,150)}${r.description.length>150?'â€¦':''}</div>`:''}
            <div class="proj-actions">
              ${r.status==='open'?`<button class="btn btn-primary btn-sm" onclick="bidModal(${r.id},'${r.title.replace(/'/g,'')}')">ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±Ø¶</button>`:''}
              <button class="btn btn-subtle btn-sm" onclick="viewReqModal(${r.id})">Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
              <button class="btn btn-save saved btn-sm" onclick="toggleSave(${r.id},this);setTimeout(pgSaved,400)">âœ“ Ø¥Ø²Ø§Ù„Ø©</button>
            </div>
          </div>`;
        }).join('') : `<div class="empty-state">
          <div class="empty-icon"><svg viewBox="0 0 24 24">${I.bookmark}</svg></div>
          <div class="empty-title">Ù‚Ø§Ø¦Ù…ØªÙƒ ÙØ§Ø±ØºØ©</div>
          <div class="empty-desc">Ø§Ø¶ØºØ· "ğŸ”– Ø§Ù‡ØªÙ…" Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ø´Ø±ÙˆØ¹ Ù„Ø¥Ø¶Ø§ÙØªÙ‡ Ù‡Ù†Ø§</div>
        </div>`}
      </div>
    </div>
  `);
}

async function clearSaved() {
  if (!confirm('Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§ØªØŸ')) return;
  await Promise.all(savedIds.map(id => api(`/api/saved/${id}`, {method:'DELETE'})));
  savedIds = []; savePersist();
  toast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', 'info'); pgSaved();
  const nb = document.getElementById('nbSaved'); if (nb) nb.style.display = 'none';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MY BIDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function pgMyBids() {
  loading();
  const data = await api('/api/my-bids');
  myBidsData = data || [];
  const pend = myBidsData.filter(b => b.status==='pending').length;
  const acc = myBidsData.filter(b => b.status==='accepted').length;
  const rej = myBidsData.filter(b => b.status==='rejected').length;
  document.getElementById('nbBids').textContent = myBidsData.length;

  setContent(`
    <div class="page-header">
      <div>
        <div class="page-title">Ø¹Ø±ÙˆØ¶ÙŠ</div>
        <div class="page-subtitle">ÙƒÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ØªÙŠ Ù‚Ø¯Ù…ØªÙ‡Ø§</div>
      </div>
    </div>

    <div class="stats-grid" style="grid-template-columns:repeat(4,1fr)">
      ${ms('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±ÙˆØ¶', myBidsData.length, '#7c3aed')}
      ${ms('Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø±Ø¯', pend, '#d97706')}
      ${ms('Ù…Ù‚Ø¨ÙˆÙ„Ø© âœ…', acc, 'var(--emerald-600)')}
      ${ms('Ù…Ø±ÙÙˆØ¶Ø©', rej, 'var(--red-600)')}
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-header-left">
          <div class="card-icon" style="background:var(--blue-100)">${svg(I.send,'var(--blue-600)')}</div>
          <div><div class="card-title">ÙƒÙ„ Ø¹Ø±ÙˆØ¶ÙŠ</div></div>
        </div>
        <select class="filter-select" id="bfSt" onchange="filterMyBids()">
          <option value="">Ø§Ù„ÙƒÙ„</option>
          <option value="pending">Ø¨Ø§Ù†ØªØ¸Ø§Ø±</option>
          <option value="accepted">Ù…Ù‚Ø¨ÙˆÙ„</option>
          <option value="rejected">Ù…Ø±ÙÙˆØ¶</option>
        </select>
      </div>
      <div class="card-body" id="bidsList">${renderBidsList(myBidsData)}</div>
    </div>
  `);
}

function ms(lbl, val, clr) {
  return `<div class="stat-card"><div class="stat-val" style="color:${clr}">${val}</div><div class="stat-lbl">${lbl}</div></div>`;
}

function filterMyBids() {
  const st = document.getElementById('bfSt')?.value||'';
  const f = st ? myBidsData.filter(b => b.status===st) : myBidsData;
  const el = document.getElementById('bidsList');
  if (el) el.innerHTML = renderBidsList(f);
}

function renderBidsList(list) {
  if (!list.length) return `<div class="empty-state"><div class="empty-icon"><svg viewBox="0 0 24 24">${I.send}</svg></div><div class="empty-title">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶</div><div class="empty-desc">Ø§Ø¨Ø¯Ø£ Ø¨ØªØµÙØ­ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ÙˆØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±ÙˆØ¶Ùƒ</div></div>`;
  const clsMap = {accepted:'acc',rejected:'rej',pending:'pend'};
  const lblMap = {accepted:'Ù…Ù‚Ø¨ÙˆÙ„ âœ…',rejected:'Ù…Ø±ÙÙˆØ¶',pending:'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø±Ø¯'};
  const badgeMap = {accepted:'badge-accepted',rejected:'badge-rejected',pending:'badge-pending'};
  return list.map(b => `<div class="bid-card ${clsMap[b.status]||'pend'}">
    <div class="bid-header">
      <div>
        <div class="bid-num">${b.project_number||'#'+b.request_id}</div>
        <div class="bid-title">${b.request_title||'Ù…Ø´Ø±ÙˆØ¹'}</div>
      </div>
      <span class="badge ${badgeMap[b.status]||'badge-pending'}">${lblMap[b.status]||'â€”'}</span>
    </div>
    <div class="bid-chips">
      <div class="bid-chip"><span>Ø§Ù„Ø³Ø¹Ø±: </span><strong>${Number(b.price).toLocaleString()} Ø±.Ø³</strong></div>
      <div class="bid-chip"><span>Ø§Ù„Ù…Ø¯Ø©: </span><strong>${b.days} ÙŠÙˆÙ…</strong></div>
      ${b.created_at?`<div class="bid-chip"><span>Ø§Ù„ØªØ§Ø±ÙŠØ®: </span><strong>${fdate(b.created_at)}</strong></div>`:''}
    </div>
    ${b.note?`<div class="bid-note">${b.note}</div>`:''}
    ${b.status==='accepted'?`<div class="alert alert-success" style="margin-top:8px">${svg(I.check)} ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø¹Ø±Ø¶Ùƒ! ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø§Ù„Ø¹Ù…Ù„</div>`:''}
    ${b.status==='pending'?`<div class="bid-footer"><button class="btn btn-danger btn-xs" onclick="withdrawBid(${b.id})">${svg(I.trash)} Ø³Ø­Ø¨ Ø§Ù„Ø¹Ø±Ø¶</button></div>`:''}
  </div>`).join('');
}

async function withdrawBid(id) {
  if (!confirm('Ø³Ø­Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) return;
  await api(`/api/bids/${id}`, {method:'DELETE'});
  toast('ØªÙ… Ø³Ø­Ø¨ Ø§Ù„Ø¹Ø±Ø¶', 'info'); pgMyBids();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACTIVE PROJECTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function pgActive() {
  loading();
  const data = await api('/api/my-projects?status=in_progress');
  const projects = data || [];
  const nb = document.getElementById('nbActive');
  if (nb) { nb.style.display = projects.length ? '' : 'none'; nb.textContent = projects.length; }

  setContent(`
    <div class="page-header">
      <div>
        <div class="page-title">Ù…Ø´Ø§Ø±ÙŠØ¹ÙŠ Ø§Ù„Ù†Ø´Ø·Ø©</div>
        <div class="page-subtitle">${projects.length} Ù…Ø´Ø±ÙˆØ¹ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</div>
      </div>
    </div>
    ${projects.length ? projects.map(p => `
      <div class="card">
        <div class="card-header">
          <div class="card-header-left">
            <div class="card-icon" style="background:var(--blue-100)">${svg(I.zap,'var(--blue-600)')}</div>
            <div>
              <div class="card-title">${p.title}</div>
              <div class="card-sub">${p.project_number||'#'+p.id} â€¢ ${p.client_name||'Ø§Ù„Ø¹Ù…ÙŠÙ„'}</div>
            </div>
          </div>
          <span class="badge badge-progress">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</span>
        </div>
        <div class="card-body">
          <div class="tracker">
            ${['Ù†ÙØ´Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹','Ø¨Ø¯Ø£ Ø§Ù„ØªÙ†ÙÙŠØ°','Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø¹Ù…Ù„','ØªÙ… Ø§Ù„Ø¥ØºÙ„Ø§Ù‚'].map((lbl,i) => {
              const cls = i<1?'done':i===1?'cur':'';
              return `<div class="tracker-step ${cls}">
                <div class="tracker-dot">${i<1?'âœ“':i+1}</div>
                <div class="tracker-lbl">${lbl}</div>
              </div>`;
            }).join('')}
          </div>

          <div class="info-block">
            <div class="info-block-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</div>
            <div class="info-row"><span class="info-key">Ø§Ù„Ø¹Ù…ÙŠÙ„</span><span class="info-val">${p.client_name||'â€”'}</span></div>
            <div class="info-row"><span class="info-key">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ØªÙÙ‚</span><span class="info-val" style="color:var(--emerald-600)">${fprice(p.agreed_price)}</span></div>
            <div class="info-row"><span class="info-key">Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</span><span class="info-val" style="color:var(--orange-500)">${p.deadline||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span></div>
            <div class="info-row"><span class="info-key">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</span><span class="info-val">${p.city||'â€”'}</span></div>
            ${p.address?`<div class="info-row"><span class="info-key">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</span><span class="info-val">${p.address}</span></div>`:''}
          </div>

          ${p.description?`<div class="proj-desc" style="margin-bottom:10px">${p.description}</div>`:''}

          ${p.client_phone?`
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <a href="tel:${p.client_phone}" class="btn btn-success btn-sm">${svg(I.phone)} Ø§ØªØµÙ„ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„</a>
              <a href="https://wa.me/966${p.client_phone.replace(/^0/,'')}" target="_blank" class="btn btn-subtle btn-sm">ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨</a>
            </div>` : ''}
        </div>
      </div>`).join('') : `
      <div class="card"><div class="card-body">
        <div class="empty-state">
          <div class="empty-icon"><svg viewBox="0 0 24 24">${I.zap}</svg></div>
          <div class="empty-title">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù†Ø´Ø·Ø©</div>
          <div class="empty-desc">Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙ‚Ø¨Ù„ Ø¹Ù…ÙŠÙ„ Ø¹Ø±Ø¶Ùƒ Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù‡Ù†Ø§</div>
        </div>
      </div></div>`}
  `);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HISTORY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function pgHistory() {
  loading();
  const data = await api('/api/my-projects?status=completed');
  const projects = data || [];

  setContent(`
    <div class="page-header">
      <div>
        <div class="page-title">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…Ù„</div>
        <div class="page-subtitle">${projects.length} Ù…Ø´Ø±ÙˆØ¹ Ù…ÙƒØªÙ…Ù„</div>
      </div>
    </div>
    <div class="card">
      <div class="card-body">
        ${projects.length ? `
          <div class="table-wrap">
            <table class="tbl">
              <thead><tr>
                <th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„</th><th></th>
              </tr></thead>
              <tbody>${projects.map(p => `<tr>
                <td>
                  <div style="font-size:12px;font-weight:800">${p.title}</div>
                  <div style="font-size:10px;color:var(--text-tertiary);font-variant-numeric:tabular-nums">${p.project_number||'#'+p.id}</div>
                </td>
                <td style="font-size:12px;font-weight:600">${p.client_name||'â€”'}</td>
                <td style="font-size:11px;color:var(--text-secondary)">${p.city||'â€”'}</td>
                <td style="font-size:12px;font-weight:800;color:var(--emerald-600)">${fprice(p.agreed_price)}</td>
                <td style="font-size:13px">${p.my_rating?`<span style="color:var(--amber-400)">${starsHtml(p.my_rating)}</span>`:`<span style="color:var(--text-tertiary);font-size:11px">â€”</span>`}</td>
                <td style="font-size:11px;color:var(--text-tertiary)">${fdate(p.completed_at)}</td>
                <td>
                  ${!p.my_rating?`<button class="btn btn-warning btn-xs" onclick="rateClientModal(${p.id},'${(p.client_name||'').replace(/'/g,'')}',${p.client_id||0})">${svg(I.star)} ØªÙ‚ÙŠÙŠÙ…</button>`:''}
                </td>
              </tr>`).join('')}</tbody>
            </table>
          </div>` :
          `<div class="empty-state">
            <div class="empty-icon"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div>
            <div class="empty-title">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…ÙƒØªÙ…Ù„Ø© Ø¨Ø¹Ø¯</div>
            <div class="empty-desc">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ù…Ø¹ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</div>
          </div>`}
      </div>
    </div>
  `);
}

function rateClientModal(reqId, clientName, clientId) {
  ratingSelected = 0;
  openModal(`ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„ â€” ${clientName}`,
    `<div style="text-align:center;margin-bottom:16px">
       <div style="font-size:12px;color:var(--text-secondary);margin-bottom:10px">ÙƒÙŠÙ ÙƒØ§Ù†Øª ØªØ¬Ø±Ø¨ØªÙƒ Ù…Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ</div>
       <div class="rating-stars" style="justify-content:center">
         ${[1,2,3,4,5].map(n=>`<span class="rating-star" onclick="selectRating(${n})" data-n="${n}">â˜…</span>`).join('')}
       </div>
       <div style="font-size:11px;color:var(--text-tertiary);margin-top:8px" id="ratingHint">Ø§Ø®ØªØ± Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø¬ÙˆÙ…</div>
     </div>
     <div class="fg"><label class="fl">ØªØ¹Ù„ÙŠÙ‚Ùƒ <span class="fl-hint">Ø§Ø®ØªÙŠØ§Ø±ÙŠ</span></label><textarea class="fta" id="ratingComment" placeholder="Ø´Ø§Ø±Ùƒ ØªØ¬Ø±Ø¨ØªÙƒ Ù…Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„â€¦"></textarea></div>`,
    `<button class="btn btn-ghost" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
     <button class="btn btn-warning" onclick="submitRating(${reqId},${clientId})">${svg(I.star)} Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>`,
    `<svg viewBox="0 0 24 24" stroke="var(--amber-600)">${I.star}</svg>`, 'var(--amber-100)'
  );
}

function selectRating(n) {
  ratingSelected = n;
  document.querySelectorAll('.rating-star').forEach((s,i) => s.classList.toggle('active', i<n));
  const hints = ['','Ø¶Ø¹ÙŠÙ Ø¬Ø¯Ø§Ù‹','Ø¶Ø¹ÙŠÙ','Ù…Ù‚Ø¨ÙˆÙ„','Ø¬ÙŠØ¯','Ù…Ù…ØªØ§Ø²!'];
  const el = document.getElementById('ratingHint');
  if (el) el.textContent = hints[n] || '';
}

async function submitRating(reqId, clientId) {
  if (!ratingSelected) { toast('Ø§Ø®ØªØ± Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø¬ÙˆÙ… Ø£ÙˆÙ„Ø§Ù‹', 'error'); return; }
  const comment = document.getElementById('ratingComment')?.value || '';
  await api('/api/reviews', {method:'POST', body:JSON.stringify({request_id:reqId, reviewed_id:clientId, rating:ratingSelected, comment})});
  closeModal(); toast('Ø´ÙƒØ±Ø§Ù‹ Ø¹Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ…Ùƒ âœ…', 'success'); pgHistory();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REVIEWS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function pgReviews() {
  loading();
  const data = await api('/api/my-reviews');
  myRevsData = data || [];
  const avg = myRevsData.length ? myRevsData.reduce((s,r) => s+r.rating, 0)/myRevsData.length : 0;
  const dist = {5:0,4:0,3:0,2:0,1:0};
  myRevsData.forEach(r => { dist[r.rating] = (dist[r.rating]||0)+1; });

  setContent(`
    <div class="page-header">
      <div>
        <div class="page-title">ØªÙ‚ÙŠÙŠÙ…Ø§ØªÙŠ</div>
        <div class="page-subtitle">${myRevsData.length} ØªÙ‚ÙŠÙŠÙ… Ø¥Ø¬Ù…Ø§Ù„Ø§Ù‹</div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:180px 1fr;gap:14px;margin-bottom:16px">
      <div class="card">
        <div class="card-body" style="text-align:center">
          <div style="font-size:40px;font-weight:900;letter-spacing:-1px;margin-bottom:4px">${avg.toFixed(1)}</div>
          <div style="font-size:18px;color:var(--amber-400);margin-bottom:6px">${starsHtml(avg)}</div>
          <div style="font-size:11px;color:var(--text-tertiary)">Ù…Ù† ${myRevsData.length} ØªÙ‚ÙŠÙŠÙ…</div>
        </div>
      </div>
      <div class="card">
        <div class="card-body">
          ${[5,4,3,2,1].map(n => {
            const c = dist[n]||0;
            const pct = myRevsData.length ? Math.round(c/myRevsData.length*100) : 0;
            return `<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
              <div style="font-size:11px;font-weight:700;width:35px;flex-shrink:0">${n} â˜…</div>
              <div style="flex:1;height:6px;border-radius:var(--r-full);background:var(--gray-100);overflow:hidden">
                <div style="height:100%;width:${pct}%;background:var(--amber-400);border-radius:var(--r-full);transition:width 1.2s cubic-bezier(.4,0,.2,1)"></div>
              </div>
              <div style="font-size:10px;color:var(--text-tertiary);width:20px;text-align:left;flex-shrink:0">${c}</div>
            </div>`;
          }).join('')}
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-header-left">
          <div class="card-icon" style="background:var(--amber-100)">${svg(I.star,'var(--amber-600)')}</div>
          <div class="card-title">ÙƒÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</div>
        </div>
        <select class="filter-select" id="rvF" onchange="filterRevs()">
          <option value="">ÙƒÙ„ Ø§Ù„Ù†Ø¬ÙˆÙ…</option>
          ${[5,4,3,2,1].map(n=>`<option value="${n}">${n} â˜…</option>`).join('')}
        </select>
      </div>
      <div class="card-body" id="revsList">${renderRevsList(myRevsData)}</div>
    </div>
  `);
}

function filterRevs() {
  const n = document.getElementById('rvF')?.value||'';
  const f = n ? myRevsData.filter(r => r.rating==n) : myRevsData;
  const el = document.getElementById('revsList');
  if (el) el.innerHTML = renderRevsList(f);
}

function renderRevsList(list) {
  if (!list.length) return `<div class="empty-state"><div class="empty-title">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª</div></div>`;
  return list.map(r => {
    const bg = avColor(r.reviewer_id||1);
    return `<div class="rev-card">
      <div class="rev-header">
        <div style="display:flex;align-items:center;gap:8px">
          <div class="rev-avatar" style="background:${bg}">${avLetter(r.reviewer_name)}</div>
          <div>
            <div class="rev-name">${r.reviewer_name||'â€”'}</div>
            <div class="rev-sub">${r.project_number||'#'+r.request_id}</div>
          </div>
        </div>
        <div style="text-align:left">
          <div class="stars">${starsHtml(r.rating)}</div>
          <div style="font-size:10px;color:var(--text-tertiary);margin-top:2px">${fdate(r.created_at)}</div>
        </div>
      </div>
      ${r.comment?`<div class="rev-text">${r.comment}</div>`:''}
      ${r.admin_reply?`<div class="rev-admin-reply"><div class="reply-label">Ø±Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div><div class="reply-text">${r.admin_reply}</div></div>`:''}
    </div>`;
  }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NOTIFICATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function pgNotifs() {
  loading();
  const data = await api('/api/notifications');
  myNotifsData = data || [];
  const unread = myNotifsData.filter(n => !n.read).length;

  const dot = document.getElementById('topNotifDot');
  const nb = document.getElementById('nbNotifs');
  if (dot) dot.style.display = unread ? '' : 'none';
  if (nb) { nb.style.display = unread ? '' : 'none'; nb.textContent = unread; }

  setContent(`
    <div class="page-header">
      <div>
        <div class="page-title">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</div>
        <div class="page-subtitle">${unread} ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡</div>
      </div>
      ${unread?`<div class="page-actions"><button class="btn btn-subtle btn-sm" onclick="markAllRead()">âœ“ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒÙ„</button></div>`:''}
    </div>
    <div class="card">
      <div class="card-body">
        ${myNotifsData.length ? myNotifsData.map(n => {
          const icoBg = {bid_accepted:'var(--emerald-100)',bid_rejected:'var(--red-100)',warning:'var(--orange-100)',admin:'var(--violet-100)'};
          const ico = {bid_accepted:'ğŸ‰',bid_rejected:'âŒ',project_complete:'âœ…',warning:'âš ï¸',admin:'ğŸ“¢'};
          return `<div class="notif-item ${n.read?'':'unread'}" onclick="readN(${n.id})">
            <div class="notif-ic" style="background:${icoBg[n.type]||'var(--gray-100)'}">${ico[n.type]||'ğŸ””'}</div>
            <div style="flex:1">
              <div class="notif-title">${n.title||'Ø¥Ø´Ø¹Ø§Ø±'}</div>
              <div class="notif-body">${n.body||''}</div>
              <div class="notif-time">${fdate(n.created_at)}</div>
            </div>
            ${!n.read?'<div class="unread-dot"></div>':''}
          </div>`;
        }).join('') : `<div class="empty-state">
          <div class="empty-icon"><svg viewBox="0 0 24 24">${I.bell}</svg></div>
          <div class="empty-title">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</div>
        </div>`}
      </div>
    </div>
  `);
}

function readN(id) { api(`/api/notifications/${id}/read`, {method:'PUT'}); }
async function markAllRead() { await api('/api/notifications/read-all', {method:'PUT'}); pgNotifs(); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WALLET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function pgWallet() {
  loading();
  const s = await api('/api/provider/stats') || {};
  const total = (s.completed||0) * (s.avg_price||0);
  const winRate = s.total_bids ? Math.round((s.won_bids||0)/s.total_bids*100) : 0;

  setContent(`
    <div class="page-header">
      <div class="page-title">Ø§Ù„Ù…Ø­ÙØ¸Ø©</div>
    </div>

    <div class="wallet-hero">
      <div class="wallet-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…Ù‚Ø¯Ø±Ø©</div>
      <div class="wallet-amount">${total.toLocaleString('ar-SA')} <span style="font-size:16px;font-weight:500;opacity:.3">Ø±.Ø³</span></div>
      <div class="wallet-sub">Ù…Ù† ${s.completed||0} Ù…Ø´Ø±ÙˆØ¹ Ù…ÙƒØªÙ…Ù„</div>
      <div class="wallet-stats">
        <div class="wallet-stat"><div class="wallet-stat-val">${s.completed||0}</div><div class="wallet-stat-lbl">Ù…Ø´Ø±ÙˆØ¹ Ù…ÙƒØªÙ…Ù„</div></div>
        <div class="wallet-stat"><div class="wallet-stat-val">${s.avg_price?Math.round(s.avg_price).toLocaleString():0}</div><div class="wallet-stat-lbl">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</div></div>
        <div class="wallet-stat"><div class="wallet-stat-val">${winRate}%</div><div class="wallet-stat-lbl">Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ²</div></div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-header-left">
          <div class="card-icon" style="background:var(--emerald-100)">${svg(I.dollar,'var(--emerald-600)')}</div>
          <div class="card-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø§Ù„ÙŠ</div>
        </div>
      </div>
      <div class="card-body">
        <div class="info-block">
          <div class="info-row"><span class="info-key">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…Ù‚Ø¯Ø±Ø©</span><span class="info-val" style="color:var(--emerald-600);font-size:14px">${total.toLocaleString('ar-SA')} Ø±.Ø³</span></div>
          <div class="info-row"><span class="info-key">Ù…ØªÙˆØ³Ø· Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</span><span class="info-val">${fprice(s.avg_price)}</span></div>
          <div class="info-row"><span class="info-key">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©</span><span class="info-val">${s.total_bids||0} Ø¹Ø±Ø¶</span></div>
          <div class="info-row"><span class="info-key">Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø©</span><span class="info-val">${s.won_bids||0} Ø¹Ø±Ø¶</span></div>
          <div class="info-row"><span class="info-key">Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ²</span><span class="info-val">${winRate}%</span></div>
          <div class="info-row"><span class="info-key">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</span><span class="info-val" style="color:var(--blue-600)">${s.active||0}</span></div>
        </div>
        <div class="alert alert-success">${svg(I.star,'var(--emerald-500)')} Ø±ÙØ¹ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ ÙˆØ¥Ø¶Ø§ÙØ© Ø£Ø¹Ù…Ø§Ù„ Ø³Ø§Ø¨Ù‚Ø© ÙŠØ²ÙŠØ¯ Ù†Ø³Ø¨Ø© Ù‚Ø¨ÙˆÙ„ Ø¹Ø±ÙˆØ¶Ùƒ</div>
      </div>
    </div>
  `);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROFILE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function pgProfile() {
  loading();
  const u = await api('/api/me') || me;
  const b = BADGE_MAP[u.badge||'none'] || BADGE_MAP.none;
  uploadedImgs['prof'] = [];

  setContent(`
    <div class="profile-hero">
      <div class="profile-avatar">${avLetter(u.name)}</div>
      <div style="flex:1">
        <div class="profile-name">${u.name||'â€”'}</div>
        <div class="profile-email">${u.email||'â€”'}</div>
        <div class="profile-badges">
          <span style="font-size:10px;background:rgba(255,255,255,.07);color:rgba(255,255,255,.4);padding:2px 9px;border-radius:var(--r-full);border:1px solid rgba(255,255,255,.08)">ğŸ“ ${u.city||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
          <span class="pb ${b.cls}">${b.icon} ${b.label}</span>
        </div>
      </div>
      <button class="btn btn-ghost btn-sm" style="flex-shrink:0" onclick="editProfileModal(${JSON.stringify(u).replace(/"/g,"'")})">
        ${svg(I.edit)} ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
      </button>
    </div>

    <div class="two-col">
      <div class="card">
        <div class="card-header">
          <div class="card-header-left">
            <div class="card-icon" style="background:var(--violet-100)">${svg(I.user,'var(--violet-600)')}</div>
            <div class="card-title">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</div>
          </div>
        </div>
        <div class="card-body">
          <div class="info-block">
            <div class="info-row"><span class="info-key">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</span><span class="info-val">${u.name||'â€”'}</span></div>
            <div class="info-row"><span class="info-key">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</span><span class="info-val">${u.email||'â€”'}</span></div>
            <div class="info-row"><span class="info-key">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</span><span class="info-val">${u.phone||'â€”'}</span></div>
            <div class="info-row"><span class="info-key">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</span><span class="info-val">${u.city||'â€”'}</span></div>
            <div class="info-row"><span class="info-key">Ø§Ù„ÙˆØ³Ø§Ù…</span><span class="info-val"><span class="pb ${b.cls}">${b.icon} ${b.label}</span></span></div>
          </div>
          ${u.bio?`<div style="background:var(--gray-50);border-radius:var(--r-md);padding:12px;border:1px solid var(--border-subtle)">
            <div style="font-size:9px;font-weight:800;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:.8px;margin-bottom:7px">Ù†Ø¨Ø°Ø© Ø¹Ù†ÙŠ</div>
            <div style="font-size:12px;line-height:1.8;color:var(--text-secondary)">${u.bio}</div>
          </div>`:''}
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-header-left">
            <div class="card-icon" style="background:var(--amber-100)">${svg(I.star,'var(--amber-600)')}</div>
            <div class="card-title">Ø§Ù„ØªØ®ØµØµØ§Øª</div>
          </div>
        </div>
        <div class="card-body">
          ${(u.specialties||[]).length ?
            `<div style="display:flex;gap:5px;flex-wrap:wrap">
              ${(u.specialties||[]).map(s=>`<span style="background:var(--violet-50);color:var(--violet-700);padding:4px 10px;border-radius:var(--r-full);font-size:11px;font-weight:700;border:1px solid var(--violet-200)">${s}</span>`).join('')}
            </div>` :
            `<div class="empty-state" style="padding:24px">
              <div class="empty-title">Ù„Ù… ØªØ­Ø¯Ø¯ ØªØ®ØµØµØ§ØªÙƒ Ø¨Ø¹Ø¯</div>
              <div class="empty-desc">Ø£Ø¶Ù ØªØ®ØµØµØ§ØªÙƒ Ù„ØªØ¸Ù‡Ø± ÙÙŠ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</div>
              <button class="btn btn-primary btn-sm" style="margin-top:10px" onclick="editProfileModal(${JSON.stringify(u).replace(/"/g,"'")})">Ø¥Ø¶Ø§ÙØ© ØªØ®ØµØµØ§Øª</button>
            </div>`}
        </div>
      </div>
    </div>
  `);
}

function editProfileModal(u) {
  if (typeof u === 'string') { try { u = JSON.parse(u.replace(/'/g,'"')); } catch { u = me; } }
  uploadedImgs['editProf'] = [];
  openModal('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ',
    `<div class="fsec">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>
     <div class="f2">
       <div class="fg"><label class="fl">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input type="text" class="fi" id="epName" value="${u.name||''}"></div>
       <div class="fg"><label class="fl">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label><input type="text" class="fi" id="epPhone" value="${u.phone||''}" placeholder="05xxxxxxxx"></div>
     </div>
     <div class="fg"><label class="fl">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label><select class="fsel" id="epCity">${cityOpts(u.city)}</select></div>

     <div class="fsec">Ø§Ù„ØªØ®ØµØµØ§Øª</div>
     ${specsHtml(u.specialties||[])}

     <div class="fsec">Ù†Ø¨Ø°Ø© Ø¹Ù†ÙŠ</div>
     <div class="fg"><textarea class="fta" id="epBio" style="min-height:90px" placeholder="Ø§ÙƒØªØ¨ Ù†Ø¨Ø°Ø© Ù…Ø®ØªØµØ±Ø© Ø¹Ù† Ø®Ø¨Ø±Ø§ØªÙƒ ÙˆØ£Ø¹Ù…Ø§Ù„Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©â€¦">${u.bio||''}</textarea></div>

     <div class="fsec">ØµÙˆØ± Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>
     ${imgUpHtml('editProf')}`,
    `<button class="btn btn-ghost" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
     <button class="btn btn-primary" onclick="saveProfile()">${svg(I.check)} Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>`,
    `<svg viewBox="0 0 24 24" stroke="var(--violet-600)">${I.edit}</svg>`, 'var(--violet-100)'
  );
}

async function saveProfile() {
  const body = {
    name: document.getElementById('epName')?.value?.trim() || me.name,
    phone: document.getElementById('epPhone')?.value || '',
    city: document.getElementById('epCity')?.value || '',
    specialties: getSpecs(),
    bio: document.getElementById('epBio')?.value || ''
  };
  if (!body.name) { toast('Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨', 'error'); return; }
  const res = await api('/api/me', {method:'PUT', body:JSON.stringify(body)});
  if (res.message && !res.id) { toast(res.message, 'error'); return; }
  Object.assign(me, body);
  localStorage.setItem('user', JSON.stringify(me));
  document.getElementById('sbName').textContent = me.name;
  document.getElementById('sbAvatar').textContent = me.name[0];
  if (me.city) document.getElementById('sbCity').textContent = 'ğŸ“ ' + me.city;
  closeModal();
  toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ âœ…', 'success');
  pgProfile();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.getElementById('overlay').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

// Load saved from server
api('/api/saved').then(r => {
  if (r && r.length) {
    savedIds = r.map(x => x.id);
    savePersist();
    const nb = document.getElementById('nbSaved');
    if (nb && savedIds.length) { nb.style.display = ''; nb.textContent = savedIds.length; }
  }
});

// Check unread notifs
api('/api/notifications').then(r => {
  const unread = (r||[]).filter(n => !n.read).length;
  if (unread) {
    const dot = document.getElementById('topNotifDot');
    const nb = document.getElementById('nbNotifs');
    if (dot) dot.style.display = '';
    if (nb) { nb.style.display = ''; nb.textContent = unread; }
  }
});

go('home', document.querySelector('.nav-item.active'));
</script>
</body>
</html>
